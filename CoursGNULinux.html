<h1 id="formation-à-gnulinux">Formation à GNU/Linux</h1>
<dl>
<dt>author</dt>
<dd><p>Michaël Launay &lt;<a href="mailto:michaellaunay@ecreall.com">michaellaunay@ecreall.com</a>&gt;</p>
</dd>
<dt>version</dt>
<dd><p>1.9</p>
</dd>
<dt>licence</dt>
<dd><p>Cette création est mise à disposition selon le Contrat Paternité 2.0 France disponible en ligne <a href="http://creativecommons.org/licenses/by/2.0/fr/">http://creativecommons.org/licenses/by/2.0/fr/</a> ou par courrier postal à Creative Commons, 171 Second Street, Suite 300, San Francisco, California 94105, USA.</p>
</dd>
</dl>

<div class="header">
<p>Ecréall 2020 update de la version 2009 pour Ubuntu 20.04</p>
</div>
<div class="footer">
<p><strong>###Title###</strong> <em>Page : ###Page###</em></p>
</div>
<div class="contents">

</div>
<div class="section-numbering">

</div>

<h2 id="objectif">Objectif</h2>
<p>Cette formation a pour but de fournir les bases indispensables à l'utilisation et à l'administration des systèmes GNU/Linux.</p>
<p>La formation privilégie la distribution Ubuntu.</p>
<h2 id="introduction">Introduction</h2>
<p>En 1991, l'étudiant finlandais Linus Torvalds publie sur internet l'intégralité du code source d'un noyau Unix qu'il a écrit en C et en assembleur et qui fonctionne sur PC AT 386(486).</p>
<p>Depuis cette date GNU/Linux ne cesse d'évoluer. Il occupe en 2015 1,6%<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> du marché mondial des systèmes d'exploitation pour ordinateur personnel, plus de 60% des serveurs web, prés de 75% du Cloud et plus de 80% des smartphones (Android étant basé sur GNU/Linux) et est en autre utilisé en France par la Gendarmerie (Ubuntu) et par l'Assemblée Nationale (Ubuntu), dans la Freebox, par l'entreprise Google (Android) et la fondation Wikipedia (serveur Ubuntu).</p>
<h2 id="historique">Historique</h2>
<h3 id="unix-les-racines">UNIX (les racines)</h3>
<figure>
<img src="HistoriqueUnix.jpg" alt="Histoire des Unix (source wikipedia)" class="align-center" /><figcaption>Histoire des Unix (source wikipedia)</figcaption>
</figure>
<p>Ken Thompson, ingénieur d'AT&amp;T travaille en collaboration avec le MIT au Bell Labs sur Multics.</p>
<p>En 1969 il créait un système d'exploitation inspiré de Multics. Brian Kernighan le nommera Unics.</p>
<p>En 1971 Unics devient Unix et est alors récrit en C spécialement développé pour cela par Dennis Ritchie.</p>
<p>1973 AT&amp;T diffuse Unix avec ses sources à ses clients (première licence open source).</p>
<p>1974 l'Université de Californie Berkeley (UCB) commence ses recherches sur UNIX en collaboration étroite avec AT&amp;T.</p>
<p>1977 Bill Joy alors étudiant à l'UCB réalise la première version de BSD (Berkeley Software Distribution).</p>
<p>À partir de là, les éditions se succèdent (SYSTEM III puis V en 1985 et SVR2 à SVR4 pour AT&amp;T, 4.2BSD pour l'UCB en 1983).</p>
<p>La DARPA finance BSD ce qui aboutit à l'intégration de la première pile TCP/IP en 1983 qui sera intégrée telle quel dans Windows en raison de sa licence permissive.</p>
<p>1985 la 4.3 BSD n'est plus livrée avec les sources de AT&amp;T en raison du prix excessif de la licence.</p>
<p>Face à ce problème, l'UCB réécrit et nettoie complètement son UNIX qui sort en 1989 sous le nom NetBSD. Le noyau est alors le MACH de l'université de Carnegie-Mellon. L'accès aux sources et à la distribution complète devient gratuit.</p>
<p>1991 Sun Microsystems co-fondé en 1982 par Bill Joy sort SunOS qui deviendra Solaris.</p>
<p>1992 Procès AT&amp;T BSD</p>
<p>FreeBSD apparaît en 1993 comme le portage de NetBSD sur i386</p>
<p>1998 Solaris supporte le 64 bits</p>
<p>1999 Mac OS X (server)</p>
<p>2005 Open Solaris</p>
<p>Octobre 2008 version 4.0.1 de NetBSD</p>
<p>Janvier 2009 version 7.1 de FreeBSD</p>
<p>La Free Software Foundation (FSF), le projet GNU</p>
<p>1983 Richard Stallman (RMS) qui travaillait au laboratoire d'intelligence artificielle du MIT crée le projet GNU.</p>
<p>GNU est un acronyme récursif (GNU's Not Unix).</p>
<p>GNU a pour objectif de fournir un système d'exploitation compatible avec UNIX sans dépendre des ayant droits (AT&amp;T et BSD) dont RMS récuse les licences.</p>
<p>1985 création de la Free Software Foundation (FSF) organisation américaine à but non lucratif pour le soutien du logiciel libre.</p>
<p>1987 Rob Pike, Ken Thompson et Dennis Ritchie débutent les travaux de Plan 9 qui inspirera les UNIX modernes.</p>
<p>1989 écriture de la GNU GPL (GNU Genral Public Licence ou GPL) version 1.</p>
<p>1990 le système GNU possède son propre éditeur (Emacs), d'un compilateur C (GCC), et d'une réécriture de la plupart des bibliothèques système d'UNIX.</p>
<p>1991 le noyau Linux utilise la GPL et GCC.</p>
<p>1997 lancement de GNOME un environnement graphique dont l'objectif était de fournir une alternative libre à l'environnement KDE qui utilisait la bibliothèque Qt alors non libre.</p>
<h3 id="la-licence-bsd-versus-la-licence-gpl">La licence BSD versus la licence GPL</h3>
<p>Il existe presque plusieurs centaines de licences appliquées aux logiciels libres, mais dans la majorité des cas on peut les séparer en deux catégories selon qu'elles sont compatibles avec la licence BSD ou la licence GPL.</p>
<h3 id="la-licence-gpl">La licence GPL</h3>
<p>La licence GPL a pour but de protéger l'auteur et l'utilisateur en garantissant les droits suivants (appelés libertés) :</p>
<ol type="1">
<li>La liberté d'exécuter le logiciel, pour n'importe quel usage ;</li>
<li>La liberté d'étudier le fonctionnement d'un programme et de l'adapter à ses besoins, ce qui passe par l'accès aux codes sources ;</li>
<li>La liberté de redistribuer des copies ;</li>
<li>La liberté d'améliorer le programme et de rendre publiques les modifications afin que l'ensemble de la communauté en bénéficie.</li>
</ol>
<p>En contrepartie l'utilisation du logiciel est au risque et péril de l'utilisateur.</p>
<h4 id="le-gauche-dauteur">Le gauche d'auteur</h4>
<p>Le code n'est pas dans le domaine public.</p>
<p>Il est protégé par le droit d'auteur.</p>
<p>L'exécution du logiciel et la diffusion des sources modifiées ne sont possibles qu'à la condition de respecter les obligations de la licence.</p>
<p>Notamment :</p>
<blockquote>
<p>Le droit de redistribuer est garanti seulement si l'utilisateur fournit le code source de la version modifiée. En outre, les copies distribuées, incluant les modifications, doivent être aussi sous les termes de la GPL.</p>
<p>Cette condition est connue sous le nom de copyleft.</p>
<p>Puisque le logiciel est protégé par les droits d'auteurs, l'utilisateur ne peut le modifier ou le redistribuer, sauf sous les termes du copyleft. En conséquence l'utilisateur doit à son tour fournir les sources et placer ses modifications sous GPL.</p>
</blockquote>
<p>Puisque le copyleft des versions 1 et 2 de la GPL ne s'appliquait pas aux entrées sorties du programme, il était possible dans le cas par exemple d'un service web de contourner l'obligation de diffusion des sources. De même, il suffisait de transformer tout code GPL en bibliothèque dynamique pour ne pas propager la GPL aux extensions apportées à un programme existant.</p>
<p>Cette faille a été corrigée avec la version GPL v3 qui accorde aux utilisateurs d’un programme accédé par réseau les mêmes droits que les utilisateurs d’un programme installé localement.</p>
<p>La GPL a été adaptée au droit Français par le CEA, CNRS, INRIA sous le nom de CECILL. Sa version 2 est compatible avec la licence publique générale GNU.</p>
<p>Le 28 mars 2007 le tribunal de grande instance de Paris a jugé applicable la licence GPL (v2).</p>
<h3 id="la-licence-bsd">La licence BSD</h3>
<p>La licence BSD permet l'utilisation du logiciel et la réutilisation de n'importe quelle partie de son code source sans restriction. La seule obligation était la mention des auteurs initiaux.</p>
<p>Pour pouvoir utiliser le logiciel écrit sous licence BSD l'utilisateur accepte de ne pas se retourner contre les auteurs en cas de problèmes.</p>
<p>Un logiciel propriétaire peut donc être réalisé à partir du code source d'un logiciel BSD (C.f. pile TCP/IP dans Windows).</p>
<h3 id="gnulinux">GNU/Linux</h3>
<p>Linux est développé sur internet par des milliers de contributeurs distants de nationalité et de culture différentes. C'est l'un des projets collaboratifs les plus importants.</p>
<h2 id="les-distributions">Les distributions</h2>
<h3 id="quest-ce-quun-noyau">Qu'est-ce qu'un noyau ?</h3>
<dl>
<dt>Pour définir le noyau, nous pouvons nous baser sur les services qu'il fournit :</dt>
<dd><p>Abstraction du matériel (fourniture d'interface) Gestion des interruptions Gestion des tâches et autres logiciels Gestion des utilisateurs Gestion des droits d'accès</p>
</dd>
</dl>
<p>Historiquement on distingue les micro-noyaux des noyaux monolithiques. Cette séparation vient de ce que le noyau est censé gérer (kernel space) et donc de ce qui est de la responsabilité des utilisateurs (user space). Dans les faits aujourd'hui même les noyaux monolithiques comme Linux sont modulaires et ne charge les modules que si nécessaire pendant l'utilisation.</p>
<h3 id="quest-ce-quune-distribution">Qu'est ce qu'une distribution ?</h3>
<p>Une distribution est un ensemble cohérent de logiciels fourni avec un noyau (Linux ou BSD). Les logiciels sont choisis pour utiliser les mêmes versions de bibliothèque et être compatibles les uns avec les autres ce qui a pour conséquence d'augmenter la stabilité et d'améliorer l'utilisation.</p>
<p>Elles comprennent des outils d'installation et de configuration.</p>
<p>Il en existe de nombreuses couvrant des besoins et des usages différents (ordinateur personnel, de bureau, serveur, passerelle, intrusion, multimédia center), ou des matériels spécifiques.</p>
<h3 id="les-différentes-distributions-gnulinux">Les différentes distributions GNU/Linux</h3>
<p>Sont orientées vers les utilisateurs débutants :</p>
<blockquote>
<ul>
<li>Suse</li>
<li>Ubuntu Desktop,</li>
</ul>
</blockquote>
<p>Pour les serveurs :</p>
<blockquote>
<ul>
<li>Ubuntu Server</li>
<li>Debian</li>
<li>Gentoo</li>
<li>Red Hat</li>
<li>CentOS</li>
</ul>
</blockquote>
<p>Pour les développeurs :</p>
<blockquote>
<ul>
<li>Fedora</li>
<li>Red Hat</li>
</ul>
</blockquote>
<p>Les métas distributions :</p>
<blockquote>
<ul>
<li>Red hat -&gt; Fedora, CentOS</li>
<li>Debian -&gt; Ubuntu, Knoppix,</li>
<li>Gentoo -&gt; Aurora</li>
</ul>
</blockquote>
<h3 id="les-principales-distributions">Les principales distributions</h3>
<p>Debian reste très orienté administrateur. Il est important d'être à l'aise avec la ligne de commande. Les versions stables sortent en moyenne tous les 2 ans.</p>
<p>Ubuntu reprend les outils Debian mais les versions sortent tous les 6 mois.</p>
<p>Gentoo permet une optimisation poussée du système. Il propose en priorité de compiler les sources de chacun des logiciels et donc de ne garder que les fonctionnalités voulues par l'utilisateur, en tenant compte des nombreux paramètres locaux.</p>
<p>Distributions commerciales :</p>
<blockquote>
<ul>
<li>Red Hat (<a href="http://www.redhat.com">http://www.redhat.com</a>),</li>
<li>Novell/SUSE (<a href="http://www.novell.com/linux/">http://www.novell.com/linux/</a>).</li>
</ul>
</blockquote>
<p>Distributions "communautaires" :</p>
<blockquote>
<ul>
<li>Gentoo (<a href="http://www.gentoo.org">http://www.gentoo.org</a>)</li>
<li>CentOs (<a href="http://www.centos.org">http://www.centos.org</a>)</li>
<li>Debian (<a href="http://www.debian.org">http://www.debian.org</a>)</li>
<li>Fedora (<a href="http://fedoraproject.org/">http://fedoraproject.org/</a>)</li>
<li>Ubuntu (<a href="http://www.ubuntu.com">http://www.ubuntu.com</a>)</li>
</ul>
</blockquote>
<p>Linus Torvalds défend la multiplicité des distributions.</p>
<h2 id="installation">Installation</h2>
<p>Le choix d'une distribution doit se faire en fonction :</p>
<blockquote>
<ul>
<li>du besoin technique,</li>
<li>des performances voulues,</li>
<li>de la pérennité désirée,</li>
<li>du niveau de sécurisation attendu.</li>
</ul>
</blockquote>
<p>Une fois ces exigences connues, il ne reste plus qu'à se procurer les images des distributions adéquates, soit directement sur les sites des distributions, soit sur un miroir.</p>
<h3 id="installation-de-gnulinux-ubuntu-version-pc-de-bureau">Installation de GNU/Linux Ubuntu version pc de bureau</h3>
<p>Les versions desktop d'Ubuntu sont fournies avec l'environnement graphique Gnome, des outils de maintenance, la suite open-office, le lecteur de courrier evolution, le logiciel de dessin Gimp, le navigateur firefox, un client vnc permettant de se connecter à distance, des jeux, des logiciels multimédias.</p>
<p>Elles conviennent parfaitement à un poste de travail, mais sont à proscrire pour un serveur en raison du nombre de services fonctionnant par défaut.</p>
<h4 id="installation-dubuntu-20.04">Installation d'Ubuntu 20.04</h4>
<p>Choisir l'image "iso" d'Ubuntu correspondant à sa machine à l'adresse <a href="https://releases.ubuntu.com/20.04/">https://releases.ubuntu.com/20.04/</a></p>
<p>La différence entre Desktop et Server est que dans la Desktop vous aurez tout l'environnement graphique, alors que la version Server suppose une utilisation en ligne de commande.</p>
<p>Créer un disque d'amorçage en suivant <a href="https://help.ubuntu.com/community/BurningIsoHowto">https://help.ubuntu.com/community/BurningIsoHowto</a></p>
<p>Insérer la clé dans votre lecteur usb. Redémarrer votre ordinateur pour pouvoir modifier les paramètres du <strong>bios</strong>. Selon la marque de votre ordinateur la touche pour entrer dans le bios lors du démarrage est soit Ech, Entrée, F2, ou Suppr. Modifier votre bios pour qu'il démarre sur la clé usb (généralement le menu boot). Enregistrer et quitter le bios. L'ordinateur va alors démarrer sur la clé et charger Ubuntu comme système d'exploitation. Ubuntu commence par vérifier qu'il n'y a pas eu de corruption de la clé. Puis il affiche différents écrans que nous allons expliquer ici.</p>
<h4 id="étape-01">Étape 01</h4>
<figure>
<img src="./images_ubuntu_20_04/00_EssayerOuInstaller.png" alt="Choix de la langue du live usb. Et choix entre tester Ubuntu ou lancer l&#39;istallation." class="align-center" /><figcaption>Choix de la langue du live usb. Et choix entre tester Ubuntu ou lancer l'istallation.</figcaption>
</figure>
<p>Si vous cliquez sur le bouton "Essayer Ubuntu" vous pourrez tester Ubuntu sans rien installer sur votre machine, les logiciels utilisés seront ceux présents sur la clé usb (vou pourrez en installer d'autres). C'est un excellent moyen de dépanner une machine pour par exemple accéder à vos disques lorsque votre l'OS de votre machine ne fonctionne plus.</p>
<h4 id="étape-02">Étape 02</h4>
<figure>
<img src="./images_ubuntu_20_04/02_Clavier.png" alt="Choix de la disposition du clavier." class="align-center" /><figcaption>Choix de la disposition du clavier.</figcaption>
</figure>
<p>Les différents choix déterminent comment vous allez pouvoir saisir les caractères comme œ. Par exemple avec le choix de clavier "alt." il suffira de faire "Alt Gr" "o", pour avoir œ. Vous pouvez tester les touches du clavier dans la zone de saisie du texte.</p>
<h4 id="étape-03">Étape 03</h4>
<figure>
<img src="./images_ubuntu_20_04/03_TypeInstall.png" alt="Type d&#39;installation avec mise à jour ou non." class="align-center" /><figcaption>Type d'installation avec mise à jour ou non.</figcaption>
</figure>
<p>L'installation minimale n'installe pas les logiciels comme libre office vous laissant le faire par la suite. Demander la mise à jour lors de l'installation suppose d'être relié à internet.</p>
<h4 id="étape-04">Étape 04</h4>
<figure>
<img src="./images_ubuntu_20_04/03_TypeInstall.png" alt="Choix du partitionnement si l&#39;on clique sur &quot;autre chose&quot; on pourra créer ses partitions." class="align-center" /><figcaption>Choix du partitionnement si l'on clique sur "autre chose" on pourra créer ses partitions.</figcaption>
</figure>
<p>Par défaut le disque sera formaté et une partition racine sera créée ainsi qu'une partition swap. La partition de swap est utilisée pour stocker temporairement la mémoire d'un programme qui s'exécutait, mais qui n'est pas celui en cours d'utilisation. Par exemple si vous n'avez que très peu de mémoire et que vous lancez plusieurs programmes, celui avec lequel vous interagissez sera en mémoire et les autres peuvent être dans le swap.</p>
<p>Si votre swap a la même taille que votre mémoire vive vous pourrez "hiberner" votre ordinateur, ainsi toute la mémoire vive sera copiée dans le swap et l'ordinateur sera éteint, lorsqu'il sera rallumé tout le swap sera recopié en mémoire vive et les programmes reprendront là où ils en éteint.</p>
<p>C'est pour cela qu'il est intéressant de créer et paramétrer ses partitions et au minimum de créer une partition "/home" pour préserver le contenu de ses données en cas de crash sévère de l'OS, nous allons voir comment partitionner le disque.</p>
<p>Nous détaillerons le partitionnement ci-après.</p>
<h4 id="étape-05">Étape 05</h4>
<figure>
<img src="./images_ubuntu_20_04/05_TypePartitionLVM.png" alt="Ubuntu propose d&#39;utiliser LVM." class="align-center" /><figcaption>Ubuntu propose d'utiliser LVM.</figcaption>
</figure>
<p>LVM (Logical Volume Manager) est un gestionnaire de volumes logiques qui vous permettra de créer des partitions virtuelles afin de pouvoir les retailler ou d'en créer de nouvelles. Linux crée alors une couche intermédiaire entre le(s) disque(s) physique(s) et l'OS, c'est dans cette couche virtuelle que vous aurez vos partitions virtuelles qui seront écrites dans la partition réelle. Toutefois si la partition physique est abîmée, on pert les partitions virtuelles écrites dessus, c'est pourquoi il faut faire des copies de sauvegardes ou avoir des disques montés en raid. Vous pouvez également chiffrer la partition LVM.</p>
<h4 id="étape-06">Étape 06</h4>
<figure>
<img src="./images_ubuntu_20_04/07_FuseauHoraire.png" alt="Choix du fuseau horaire." class="align-center" /><figcaption>Choix du fuseau horaire.</figcaption>
</figure>
<p>Si vous êtes en France métropolitaine, choisissez le fuseau passant par la France.</p>
<h4 id="étape-07">Étape 07</h4>
<figure>
<img src="./images_ubuntu_20_04/15_User1000.png" alt="Création du 1er compte utilisateur." class="align-center" /><figcaption>Création du 1er compte utilisateur.</figcaption>
</figure>
<p>Sous Ubuntu cet utilisateur aura la particularité de pouvoir mettre à jour le système et plus généralement de pouvoir devenir super utilisateur (root).</p>
<h4 id="étape-08">Étape 08</h4>
<p>Ubuntu affiche un récapitulatif des choix réalisés, la confirmation lance alors le partitionnement des disques, leur formatage puis l'installation du système.</p>
<figure>
<img src="./images_ubuntu_20_04/15_User1000.png" alt="Une fois les choix confirmés, l&#39;installation commence." class="align-center" /><figcaption>Une fois les choix confirmés, l'installation commence.</figcaption>
</figure>
<p>En fin d'installation un écran vous invite à retirer la clé usb et à redémarrer l'ordinateur.</p>
<figure>
<img src="./images_ubuntu_20_04/17_FinInstallation.png" alt="Fin d&#39;installation." class="align-center" /><figcaption>Fin d'installation.</figcaption>
</figure>
<p>Une fois redémarré saisissez votre identifiant et votre mot de passe (ceux donnés à l'étape 07)</p>
<p>Vous pouvez alors associer votre machine à vos comptes google et microsoft pour par exemple voir vos agendas et recevoir vos notifications.</p>
<figure>
<img src="./images_ubuntu_20_04/18_ConfigurationComptesEnLigne.png" alt="Configuration des comptes en lignes." class="align-center" /><figcaption>Configuration des comptes en lignes.</figcaption>
</figure>
<p>Vous pouvez associer votre machine au mécanisme livepatch de Canonical l'éditeur d'Ubuntu pour faire automatiquement la mise à jour de votre machine.</p>
<figure>
<img src="./images_ubuntu_20_04/19_LivePatch.png" alt="Configuration de votre compte Ubuntu pour le live patch." class="align-center" /><figcaption>Configuration de votre compte Ubuntu pour le live patch.</figcaption>
</figure>
<p>Vous pouvez aider Canonical à corriger les bogues en autorisant la remontée des incidents.</p>
<figure>
<img src="./images_ubuntu_20_04/20_UbuntuWatch.png" alt="Remonté des informations pour les développeurs." class="align-center" /><figcaption>Remonté des informations pour les développeurs.</figcaption>
</figure>
<p>Il est possible de permettre la géolocalisation.</p>
<figure>
<img src="./images_ubuntu_20_04/21_Geolocalisation.png" alt="Autorisation de la géolocalisation." class="align-center" /><figcaption>Autorisation de la géolocalisation.</figcaption>
</figure>
<p>On peut installer immédiatement les applications compatibles avec Ubuntu 20.04</p>
<figure>
<img src="./images_ubuntu_20_04/22_AutresApplications.png" alt="Fin d&#39;installation." class="align-center" /><figcaption>Fin d'installation.</figcaption>
</figure>
<h4 id="étape-alternative-04-bis">Étape alternative 04 bis</h4>
<p>Le partitionnement est l'étape la plus importante, car il est difficile de corriger les erreurs.</p>
<p>Pour les serveurs cette étape influence directement la sécurité du système (/var/lib, /var/log, /var/spool, /var/www, /tmp), la sécurité est alors physique et ne repose pas seulement sur le mécanisme des quotas. De plus, l'analyse post-mortem d'une partition dédiée est plus facile que celle d'un énorme fourre-tout.</p>
<p>Au minimum, il est recommandé d'avoir une partition /, /home et swap.</p>
<p>Pour activer le partitionnement manuelle, il suffit de cocher sur le bouton "Autre chose" à l'étape 04.</p>
<p>Il faut alors choisir un disque.</p>
<figure>
<img src="./images_ubuntu_20_04/09_TypePartition_Partitioner_sda.png" alt="Création de la table de partition" class="align-center" /><figcaption>Création de la table de partition</figcaption>
</figure>
<figure>
<img src="./images_ubuntu_20_04/10_TypePartition_Partitioner_sda_NouvelleTable.png" alt="Création de la table de partition" class="align-center" /><figcaption>Création de la table de partition</figcaption>
</figure>
<p>Le bouton "+" permet de créer de nouvelle partition</p>
<p>Dans notre cas nous allons créer 3 partitions /, /home et swap.</p>
<figure>
<img src="./images_ubuntu_20_04/12_TypePartition_Partitioner_sda_NouvelleTable_root.png" alt="Création de la racine &quot;/&quot;" class="align-center" /><figcaption>Création de la racine "/"</figcaption>
</figure>
<p>Sur le même principe, on crée "/home" On peut cocher la case "formater" pour purger le disque de ce qu'il contenait avant.</p>
<p>Puis vient la partition de "swap".</p>
<figure>
<img src="./images_ubuntu_20_04/13_TypePartition_Partitioner_sda_root_home_swap.png" alt="Création du swap" class="align-center" /><figcaption>Création du swap</figcaption>
</figure>
<p>N'oubliez pas que la taille du swap doit être au moins égale à celle de la mémoire vive (RAM) pour permettre l'hibernation.</p>
<figure>
<img src="./images_ubuntu_20_04/14_TypePartition_Partitioner_sda_root_home_swap.png" alt="Création des partitions" class="align-center" /><figcaption>Création des partitions</figcaption>
</figure>
<h3 id="installation-de-gnulinux-ubuntu-en-version-serveur">Installation de GNU/Linux Ubuntu en version serveur</h3>
<p>La philosophie des distributions serveur est moins il y a de programmes installés plus le système est stable et moins il y a de faille de sécurité.</p>
<p>En conséquence, les interfaces graphiques ne sont disponibles qu'en option et le moyen privilégié d'administrer le système est la ligne de commande.</p>
<p>Pour un serveur il vaut mieux opter pour les versions LTS (Long Term Support) des distributions.</p>
<p>Les différences entre "Debian server" et "Ubuntu server" sont liées aux versions du noyau et des bibliothèques utilisées, aux dépôts et fichiers de configurations par défaut.</p>
<h4 id="attention">Attention</h4>
<p>Sous Ubuntu, il n'est pas possible de créer une partition /var, car le système y stocke des fichiers au démarrage, alors que les points de montage ne sont pas encore installés, ce qui provoque un plantage du système difficile à comprendre.</p>
<h4 id="travaux-pratiques">Travaux pratiques</h4>
<p>Installation d'une Ubuntu server LTS</p>
<h3 id="utilisation-de-gnulinux">Utilisation de GNU/Linux</h3>
<p>Présentation interactive du système d'exploitation:</p>
<blockquote>
<ul>
<li>le bureau,</li>
<li>les fenêtres d'application,</li>
<li>le tableau de bord.</li>
</ul>
</blockquote>
<p>Administration graphique du système:</p>
<blockquote>
<ul>
<li>Configuration du réseau (Système (Flèche descendante de la barre de menus, à droite) &gt; Wifi ou Filaire (non) connecté ou Administration (Roue dentée) &gt; Wifi ou Réseau)</li>
<li>Synaptic (Pour l'installer <a href="https://doc.ubuntu-fr.org/synaptic">https://doc.ubuntu-fr.org/synaptic</a> ): l'installation de logiciels (Système &gt; Administration &gt; Gestionnaire de paquets Synaptic)</li>
<li>configuration des dépôts (Rechercher depuis le menu Activité -&gt; Logiciels &amp; mises à jour)</li>
<li>personnalisations basiques <a href="https://doc.ubuntu-fr.org/personnalisation_basique">https://doc.ubuntu-fr.org/personnalisation_basique</a></li>
<li>la configuration de Gnome (installer gnome-tweaks )</li>
<li>les applets</li>
<li>la résolution graphique</li>
<li>les bureaux virtuels</li>
<li>les services (Système &gt; Administration &gt; Services)</li>
</ul>
</blockquote>
<p>Les logiciels d'administration ne sont que des surcouches graphiques (front-end) qui appellent les commandes en ligne, par conséquent leurs possibilités sont moindres.</p>
<h2 id="laide-et-la-communauté">L'aide et la communauté</h2>
<h3 id="laide-en-ligne">L'aide en ligne</h3>
<p>En mode graphique, les applications possèdent un onglet "Aide" permettant d'ouvrir un navigateur sur l'aide en ligne. Cette aide est généralement accessible par la touche F1.</p>
<figure>
<img src="AideEnLigneUbuntu.jpg" alt="Aide en ligne d&#39;Ubuntu (appelée avec F1)" class="align-center" /><figcaption>Aide en ligne d'Ubuntu (appelée avec F1)</figcaption>
</figure>
<p>Dans un shell, la plupart des commandes unix acceptent l'option -h ou --help ou --usage : :</p>
<pre><code>michaellaunay@luciole:~$ apropos --help
Usage: apropos [OPTION...] KEYWORD...
Project-Id-Version: man-db 2.3.90
Report-Msgid-Bugs-To: Colin Watson &lt;cjwatson@debian.org&gt;
POT-Creation-Date: 2008-05-05 02:09+0100
PO-Revision-Date: 2008-08-19 20:37+0000
Last-Translator: Laurent Pelecq &lt;laurent.pelecq@soleil.org&gt;
Language-Team: French &lt;traduc@traduc.org&gt;
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-Launchpad-Export-Date: 2008-11-09 09:58+0000
X-Generator: Launchpad (build Unknown)

  -d, --debug                emit debugging messages
  -v, --verbose              print verbose warning messages
  -e, --exact                search each keyword for exact match
  -r, --regex                interpret each keyword as a regex
  -w, --wildcard             the keyword(s) contain wildcards
  -a, --and                  require all keywords to match
  -l, --long                 do not trim output to terminal width
  -C, --config-file=FICHIER  use this user configuration file
  -L, --locale=LOCALE        define the locale for this search
  -m, --systems=SYSTEM       use manual pages from other systems
  -M, --manpath=CHEMIN       set search path for manual pages to PATH
  -s, --section=SECTION      search only this section
  -?, --help                 give this help list
      --usage                give a short usage message
  -V, --version              print program version

Mandatory or optional arguments to long options are also mandatory or optional
for any corresponding short options.

The --regex option is enabled by default.

Report bugs to cjwatson@debian.org.</code></pre>
<p>Pour trouver une commande il suffit de faire apropos MotClé qui affichera toutes les commandes comportant MotClé dans sa description courte. Toutefois la base des commandes peut avoir besoin d'être régénérée par <strong>makewhatis</strong>.</p>
<p><em>whatis NomDeCommande</em> affichera la description courte de NomDeCommande.</p>
<h3 id="les-man-pages">Les man pages</h3>
<p>Les applications et commandes possèdent toutes un manuel accessible en ligne de commande via la commande man.</p>
<p>Ce manuel est généralement traduit dans la langue de l'utilisateur :</p>
<pre><code>michaellaunay@luciole:~$ man man
MAN(1)            Utilitaires de l’afficheur des pages de manuel               MAN(1)

NOM
       man - Interface de consultation des manuels de référence en ligne

SYNOPSIS
       man  [-c|-w|-tZ] [-H[navigateur]] [-T[périphérique]] [-adhu7V] [-i|-I]
       [-m système[,...]] [-L langue] [-p chaîne] [-C fichier] [-M chemin]
       [-P afficheur] [-r invite] [-S liste] [-e extension] [[section] page ...] ...
       man -l [-7] [-tZ] [-H[navigateur]] [-T[périphérique]] [-p chaîne]
       [-P afficheur] [-r invite] fichier ...
       man -k [apropos options] expression_rationnelle ...
       man -f [whatis options] page ...

DESCRIPTION
       man est le programme de visualisation des pages de manuel.  Chacun  des  argu-
       ments  page,  indiqué dans la ligne de commande de man, porte, en principe, le
       nom d’un programme, d’un utilitaire ou d’une fonction. La page de manuel  cor-
       respondant à chaque argument est alors trouvée et affichée. Si une section est
       précisée alors man limite  la  recherche  à  cette  section.  Par  défaut,  il
       recherche dans toutes les sections disponibles, suivant un ordre prédéfini. Il
       n’affiche que la première page de manuel trouvée, même si  d’autres  pages  de
       manuel existent dans d’autres sections.

       Le  tableau  ci-dessous  indique le numéro des sections de manuel ainsi que le
       type de pages qu’elles contiennent.

       1   Programmes exécutables ou commandes de l’interpréteur de  com-
           mandes (shell) ;
       2   Appels système (Fonctions fournies par le noyau) ;
       3   Appels  de  bibliothèque  (fonctions  fournies  par  les  bib-
           liothèques des programmes) ;
       4   Fichiers spéciaux (situés généralement dans /dev) ;
       5   Formats des fichiers et conventions. Par exemple /etc/passwd ;
       6   Jeux ;
       7   Divers (y compris les macropaquets et les  conventions).   Par
           exemple, man(7), groff(7) ;
       8   Commandes  de  gestion  du  système (généralement réservées au
           superutilisateur) ;
       9   Sous-programmes du noyau [hors standard].

       Une page de manuel est constituée de plusieurs parties.

       Elles peuvent être libellées NOM, SYNOPSIS,  DESCRIPTION,  OPTIONS,  FICHIERS,
       VOIR AUSSI, BOGUES et AUTEUR.</code></pre>
<p>Pour chercher les pages associées à un mot clé:</p>
<pre><code>michaellaunay@luciole:~/Documents/ecreall/Cours/CoursGNULinux$ man -k manual
apropos (1)          - search the manual page names and descriptions
catman (8)           - create or update the pre-formatted manual pages
esdcompat (1)        - manual page for pulseaudio esd wrapper 0.9.5
grub-reboot (8)      - manual page for grub-reboot 0.01
man (1)              - an interface to the on-line reference manuals
manconv (1)          - convert manual page from one encoding to another
mandb (8)            - create or update the manual page index caches
manpath (1)          - determine search path for manual pages
missing (7)          - missing manual pages
pulseaudio (1)       - manual page for pulseaudio 0.9.5
readahead-list (8)   - manual page for readahead-list: 0.20050517.0220
readahead-watch (8)  - manual page for readahead-watch: 0.20050517.0220
update-apt-xapian-index (8) - manual page for update-apt-xapian-index 0.15
w3mman (1)           - an interface to the on-line reference manuals by w3m(1)
whatis (1)           - display manual page descriptions
whereis (1)          - locate the binary, source, and manual page files for a command
xman (1)             - Manual page display program for the X Window System</code></pre>
<h3 id="les-sites">Les sites</h3>
<p>Le site officiel de Linux <a href="http://www.linux.org">http://www.linux.org</a></p>
<p>Un site dédié à Linux (Linux Entre Amis) : <a href="http://www.lea-linux.org">http://www.lea-linux.org</a></p>
<p>Une présentation de Linux <a href="http://fr.wikipedia.org/wiki/Linux">http://fr.wikipedia.org/wiki/Linux</a></p>
<p>La communauté ubuntu française <a href="http://www.ubuntu-fr.org/">http://www.ubuntu-fr.org/</a></p>
<h3 id="les-forums">Les forums</h3>
<p>Le forum de la communauté Ubuntu <a href="http://ubuntuforums.org/">http://ubuntuforums.org/</a></p>
<p>Le forum de la communauté Debian française <a href="http://forum.debian-fr.org">http://forum.debian-fr.org</a></p>
<h3 id="les-lugs">Les LUGs</h3>
<p>Un LUG est un groupe d'utilisateurs de Linux (Linux User Group) réuni généralement au sein d'une association loi 1901.</p>
<p>Dans la région lilloise on compte essentiellement Chtinux <a href="http://www.chtinux.org/">http://www.chtinux.org/</a> anciennement Campux et CLX <a href="http://clx.asso.fr/spip">http://clx.asso.fr/spip</a></p>
<p>Les LUGs réalisent la promotion de Linux est des logiciels libres. Ils organisent des manifestations telles que des install party.</p>
<h2 id="shell-commandes">Shell &amp; Commandes</h2>
<h3 id="les-terminaux-tty">Les terminaux (tty)</h3>
<p>Historiquement, un terminal est une interface homme machine minimale issue des technologies de communication de la fin XIX et du début XX siècle, le Télétype marque déposée en 1906 est l'ancêtre des claviers numériques des premiers ordinateurs.</p>
<p>L'abréviation tty de Télétype a été utilisée pour décrire l'interface série de communication utilisée au début d'Unix. Par usage c'est le terme qui décrit l'interface de saisie et d'affichage avec l'humain. On trouve aussi l'appellation de terminal ou console.</p>
<p>La commande tty affiche le pseudo fichier associé à la saisie.</p>
<p>Dans l'environnement graphique XWindows on trouve des logiciels émulant les terminaux, on les appelle alors des terminaux virtuels (ex: xterm).</p>
<p>Les terminaux ne sont en charge que de la récupération des touches frappées, de leur transformation en lettre, et de l'affichage de celle-ci. L'interprétation de ce qui est saisi est dévolue au shell.</p>
<p>Les six premiers terminaux sont accessibles par la combinaison de touche Ctrl Alt F[1-6].</p>
<p>Le terminal graphique est accessible Ctrl Alt F7</p>
<h3 id="la-ligne-de-commande">La ligne de commande</h3>
<p>Sous Unix la CLI (Command Line Interface) est la méthode privilégiée pour transmettre au système les ordres à exécuter.</p>
<h4 id="les-différents-shell">Les différents shell</h4>
<p>Le shell est un logiciel qui interprète séquentiellement les commandes saisies dans un terminal ou stockées dans un fichier (script) ou provenant d'un pseudo fichier.</p>
<p>La syntaxe et la sémantique de cette interprétation dépendent du shell employé.</p>
<p>Historiquement la première version est <strong>sh</strong> (1977 écrit par Stephen Bourne) qui évolua en <strong>csh</strong>, <strong>ksh</strong> et <strong>bash</strong> (Bourne again shell) le plus répandu.</p>
<p>Bash est l'interpréteur de commande par défaut des Unix libres et de Mac OS X.</p>
<p>Pour connaître la version de bash en cours d'utilisation:</p>
<pre><code>michaellaunay@luciole:~$ echo $BASH
/bin/bash
michaellaunay@luciole:~$ echo $BASH_VERSION
4.3.39(1)-release</code></pre>
<p>Pour modifier le shell par défaut associé à un utilisateur il faut modifier <em>/etc/passwd</em> avec la commande <strong>usermod -s /bin/bash login</strong> : :</p>
<pre><code>michaellaunay@luciole:~$ grep michael /etc/passwd
michaellaunay:x:1000:1000:Michael Launay,,,:/home/michaellaunay:/bin/bash
michaellaunay@luciole:~$ sudo usermod -s /bin/sh michaellaunay
michaellaunay@luciole:~$ grep michael /etc/passwd
michaellaunay:x:1000:1000:Michael Launay,,,:/home/michaellaunay:/bin/sh</code></pre>
<p>Pour créer un compte qui pourra se connecter sans avoir de shell (utilisation de tunnel) : :</p>
<pre><code>usermod -s /bin/false prestataire</code></pre>
<p>Détails sur le format du fichier passwd</p>
<blockquote>
<p><a href="mailto:michaellaunay@luciole">michaellaunay@luciole</a>:~$ man 5 passwd PASSWD(5) Formats et conversions de fich PASSWD(5)</p>
<dl>
<dt>NOM</dt>
<dd><p>passwd - fichier des mots de passe</p>
</dd>
<dt>DESCRIPTION</dt>
<dd><p>/etc/passwd contient différentes informations sur les comptes utilisateurs. Ces informations consistent en sept champs séparés par des deux-points (« : ») :</p>
<p>· nom de connexion de l´utilisateur (« login »)</p>
<p>· un mot de passe chiffré optionnel</p>
<p>· l´identifiant numérique de l´utilisateur</p>
<p>· l´identifiant numérique du groupe de l´utilisateur</p>
<p>· le nom complet de l´utilisateur ou un champ de commentaires</p>
<p>· le répertoire personnel de l´utilisateur</p>
<p>· l´interpréteur de commandes de l´utilisateur (optionnel)</p>
<p>Le champ du mot de passe chiffré peut être vide. Dans ce cas, aucun mot de passe n´est nécessaire pour s´authentifier avec le compte donné. Cependant, certaines applications qui lisent le fichier /etc/passwd peuvent décider de ne donner aucun accès si le mot de passe est vide. Si le mot de passe est un « x » minuscule, alors le mot de passe chiffré se trouve dans le fichier shadow(5) ; il doit y avoir une ligne correspondante dans le fichier shadow, sinon le compte de l´utilisateur n´est pas valide. Si le mot de passe est constitué d´une autre chaîne, alors il est considéré comme un mot de passe chiffré, comme indiqué dans crypt(3).</p>
</dd>
</dl>
</blockquote>
<p>Plus d'information : man bash</p>
<p>Lien : <a href="http://fr.wikipedia.org/wiki/Bourne-Again_shell">http://fr.wikipedia.org/wiki/Bourne-Again_shell</a></p>
<h4 id="les-fichiers-de-ressources-et-de-configuration-de-bash">Les fichiers de ressources et de configuration de bash</h4>
<p>Au lancement du shell celui-ci détermine s'il a été appelé de façon interactive ou pour exécuter un script ou en tant que shell de login. En fonction de la nature de son lancement, il exécutera plusieurs fichiers lui permettant de ce paramétrer.</p>
<p>Scripts exécutés lors du lancement d'un shell interactif en ouverture de session (interactive login shell) : :</p>
<pre><code>/etc/profile
~/.bash_profile #le ~ désigne le répertoire &quot;home&quot; de l&#39;utilisateur
~/.bash_login #si ~/.bash_profile n&#39;existe pas
~/.profile #si ~/.bash_login</code></pre>
<p>Scripts exécutés lors d'un shell interactif : :</p>
<pre><code>/etc/bash.bashrc
~/.bashrc</code></pre>
<p>La modification de ces scripts nécessite la commande <strong>source</strong> pour une prise en compte immédiate dans le shell courant.</p>
<p>Scripts exécutés lors d'un script : :</p>
<pre><code>$BASH_ENV #BASH_ENV est une variable. Si elle existe alors les scripts lancés essayent d&#39;exécuter le fichier désigné par $BASH_ENV</code></pre>
<p>Un petit exemple : :</p>
<pre><code>michaellaunay@luciole:~$ echo &quot;echo coucou&quot; &gt; /tmp/hello.sh #on crée un fichier hello.sh qui contient echo coucou
michaellaunay@luciole:~$ chmod +x /tmp/hello.sh   # on rend exécutable ce fichier
michaellaunay@luciole:~$ /tmp/hello.sh            # on exécute ce fichier
coucou
michaellaunay@luciole:~$ echo $BASH_ENV           # on affiche le contenu de la variable BASH_ENV

michaellaunay@luciole:~$ BASH_ENV=&#39;/tmp/hello.sh&#39; # on affecte la chaîne /tmp/hello.sh à la variable BASH_ENV
michaellaunay@luciole:~$ export BASH_ENV # maintenant BASH_ENV sera accessible à toute commande exécutée depuis le shell courant
michaellaunay@luciole:~$ echo &quot;echo cuicui&quot; &gt; /tmp/oiseau.sh
michaellaunay@luciole:~$ bash /tmp/oiseau.sh # on exécute oiseau.sh avec bash, car on n&#39;a pas fait le chmod +x dessus
coucou
cuicui</code></pre>
<h4 id="les-variables-denvironnement">Les variables d'environnement</h4>
<p>Les variables d'environnement sont accessibles en consultation avec la commande <strong>env</strong> : :</p>
<pre><code>michaellaunay@luciole:~$ env
SHELL=/bin/bash
TERM=xterm
HISTSIZE=1000
USERNAME=michaellaunay
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
PWD=/home/michaellaunay
EDITOR=vim
LANG=fr_FR.UTF-8
HOME=/home/michaellaunay
LOGNAME=michaellaunay
DISPLAY=:0.0
OLDPWD=/home/michaellaunay</code></pre>
<p>Signification des variables d'environnement : :</p>
<pre><code>BASH      # Le nom du fichier bash
DISPLAY   # Le numéro de serveur et de session d&#39;affichage
EDITOR    # L&#39;éditeur à utiliser par défaut
HISTSIZE  # La taille du fichier historique
HOSTNAME  # Le nom de la machine
HOME      # Le répertoire personnel de l&#39;utilisateur
LANG      # La langue de l&#39;utilisateur et l&#39;encodage utilisé pour afficher cette langue
LOGNAME   # Le nom d&#39;utilisateur lors de l&#39;ouverture de la session
MAIL      # Le chemin vers la boite mail de l&#39;utilisateur
OLDPWD    # Le répertoire où nous étions avant le dernier cd
PATH      # Le chemin vers les exécutables
PS1       # Permet de constituer l&#39;invite de commande
PS2       # Symbole affiché sur les lignes de commande débordant sur plusieurs lignes
PROMPT_COMMAND # Le nom d&#39;une commande à exécuter à chaque commande
PWD       # Le chemin actuel
SHELL     # Le shell de l&#39;utilisateur
TERM      # Le type de terminal
USERNAME  # Le nom d&#39;utilisateur</code></pre>
<p>Pour accéder au contenu d'une variable, il suffit de la référencer en la précédent de <strong>$</strong>:</p>
<pre><code>michaellaunay@luciole:~$ echo $HOME
/home/michaellaunay</code></pre>
<p>Pour voir l'ensemble des définitions réalisées dans un shell (variable et fonction) il suffit de taper <strong>set</strong>.</p>
<p>Pour voir les lignes exécutées dans un script <strong>set -x</strong> en début de cript.</p>
<h4 id="les-caractères-spéciaux">Les caractères spéciaux</h4>
<p>Les caractères suivants permettent de déclencher des comportements particuliers qui seront expliqués ci-après : :</p>
<pre><code># # Mise en commentaire
&gt; # Indirection vers un fichier
&lt; # Indirection depuis un fichier
| # Pipe
? # Un caractère ou pas
. # Un caractère
* # Une chaîne de caractère
$ # Référencement d&#39;une variable
\ # Échappement
/ # Séparateur
[ # Début d&#39;un ensemble ou d&#39;un test
] # Fin d&#39;un ensemble ou d&#39;un test
( # Sous shell ou évaluation
) # Fin de sous shell ou d&#39;évaluation
: # Séparateur de groupe
; # Fin de commande
^ # Inversion ou début
@ # Adresse
` # Début ou fin d&#39;interprétation
~ # Désigne le répertoire personnel</code></pre>
<p>Si vous voulez les utiliser pour nommer par exemple un fichier sans que le comportement particulier soit déclenché vous avez l'obligation de les échapper avec <strong>** ou de les mettre entre apostrophes</strong>'** ou guillemets <strong>"</strong>:</p>
<pre><code>\# ou &#39;#&#39; ou &quot;#&quot;
\&gt; ou &#39;&gt;&#39; ou &quot;&gt;&quot;
\&lt; ou &#39;&lt;&#39; ou &quot;&lt;&quot;
\| ou &#39;|&#39; ou &quot;|&quot;
\? ou &#39;?&#39; ou &quot;?&quot;
\. ou &#39;.&#39; ou &quot;.&quot;
\* ou &#39;*&#39; ou &quot;*&quot;
\$ ou &#39;$&#39; ou &quot;$&quot;
\\ ou &#39;\&#39; ou &quot;\&quot;
\/ ou &#39;/&#39; ou &quot;/&quot;
\[ ou &#39;[&#39; ou &quot;[&quot;
\] ou &#39;]&#39; ou &quot;]&quot;
\( ou &#39;(&#39; ou &quot;(&quot;
\) ou &#39;)&#39; ou &quot;)&quot;
\: ou &#39;:&#39; ou &quot;:&quot;
\; ou &#39;;&#39; ou &quot;;&quot;
\^ ou &#39;^&#39; ou &quot;^&quot;</code></pre>
<p>exemple : :</p>
<pre><code>michaellaunay@luciole:~$ echo lunettes &gt; /tmp/\[\*\]\^\[&quot;*&quot;&#39;]&#39;
michaellaunay@luciole:~$ ls /tmp
[*]^[*]
michaellaunay@luciole:~$ cat /tmp/\[\*\]\^\[\*\]
lunettes</code></pre>
<h4 id="variables-spéciales">Variables spéciales</h4>
<p>En plus des variables d'environnement vue précédemment nous avons : :</p>
<pre><code>$? # Qui fait référence au code de retour de la dernière commande exécuté.
$$ # Le pid du programme en cours d&#39;exécution.
$! # Le pid de la dernière commande lancée en tâche de fond.
$# # Le nombre de paramètres.
$0 # Le nom du programme en cours d&#39;exécution.
$1 # Le premier paramètre passé.
$2 # Le second paramètre passé.
...
$9 # Le neuvième paramètre.
$*, $@ # L&#39;ensemble des paramètres</code></pre>
<h4 id="création-affectation-de-variable">Création, affectation de variable</h4>
<p>Pour créer une variable ou en modifier sa valeur il suffit de la définir : :</p>
<pre><code>michaellaunay@luciole:~$ VAR=&#39;Bonjour tout le monde&#39;
michaellaunay@luciole:~$ echo $VAR
Bonjour tout le monde
michaellaunay@luciole:~$ VAR=Salut
michaellaunay@luciole:~$ echo $VAR
Salut
michaellaunay@luciole:~$ VAR=$VAR&#39; à tous&#39;
michaellaunay@luciole:~$ echo $VAR
Salut à tous
michaellaunay@luciole:~$ PATH=/home/michaellaunay/MesScripts:$PATH
michaellaunay@luciole:~$ echo $PATH
/home/michaellaunay/MesScripts:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</code></pre>
<p>Pour supprimer une variable, on peut utiliser <strong>unset</strong> : :</p>
<pre><code>michaellaunay@luciole:~$ unset BASH_ENV</code></pre>
<h4 id="protection-des-espaces-des-valeurs-des-variables">Protection des espaces des valeurs des variables</h4>
<p>Attention bash passe les mots d'une variable en les séparant d'un unique espace. Ainsi : :</p>
<pre><code>michaellaunay@luciole:~$ VARIABLE=&quot;  commence par 2 espaces puis en contient cinq     et finit par deux  &quot;
michaellaunay@luciole:~$ echo DEBUT${VARIABLE}FIN #L&#39;abscence de guillemet forcent le bash à passer en paramettre chacuns des mots séparé par un unique espace.
DEBUT commence par 2 espaces puis en contient cinq et finit par deux FIN
michaellaunay@luciole:~$ echo DEBUT&quot;$VARIABLE&quot;FIN #Les guillemets protègent les espaces !
DEBUT  commence par 2 espaces puis en contient cinq     et finit par deux  FIN</code></pre>
<p>On peut aussi échapper les espaces avec des antislashs lors de l'affectation de la variable.</p>
<h4 id="évaluation-dune-variable">Évaluation d'une variable</h4>
<p>Une variable peut contenir une commande. Son simple appel suffit à provoquer son évaluation : :</p>
<pre><code>michaellaunay@luciole:~$ MON_SCRIPT=&quot;/tmp/ma_cmd.sh&quot;
michaellaunay@luciole:~$ $MON_SCRIPT #exécute la commande contenue dans la variable MON_SCRIPT
Hello
michaellaunay@luciole:~$ cat  $MON_SCRIPT #Affiche ce qu&#39;il y a dans le script /tmp/ma_cmd.sh
#! /bin/bash
echo Hello</code></pre>
<h4 id="export-de-variable">Export de variable</h4>
<p>Toute variable créée dans un shell n'est accessible que dans celui-ci.</p>
<p>Pour la rendre accessible aux commandes et scripts appelés après l'affectation il faut l'exporter : :</p>
<pre><code>michaellaunay@luciole:~$ echo &quot;echo \$SALUTATION&quot; &gt; /tmp/cmd.sh
michaellaunay@luciole:~$ /tmp/cmd.sh

michaellaunay@luciole:~$ SALUTATION=coucou
michaellaunay@luciole:~$ echo $SALUTATION
coucou
michaellaunay@luciole:~$ /tmp/cmd.sh

michaellaunay@luciole:~$ export SALUTATION
michaellaunay@luciole:~$ /tmp/cmd.sh
coucou</code></pre>
<h4 id="les-tests-dexpressions-et-fichier-opérateurs-de-contrôle">Les tests d'expressions et fichier, opérateurs de contrôle</h4>
<p>La commande <strong>test</strong> permet de tester une expression et de retourner 0 si le test est vrai et 1 s'il est faux : :</p>
<pre><code>michaellaunay@luciole:~$ test 1 = 1
michaellaunay@luciole:~$ echo $?
0
michaellaunay@luciole:~$ test 1 = 2
michaellaunay@luciole:~$ echo $?
1</code></pre>
<p>On peut aussi remplacer <strong>test</strong> par des crochets, mais il faut alors encadrer les crochets par des espaces : :</p>
<pre><code>michaellaunay@luciole:~$ [ 1 = 2 ]
michaellaunay@luciole:~$ echo $?
1</code></pre>
<p>Les options de test sont très nombreuses. Faites man test.</p>
<p>Avec <strong>test</strong> et <strong>if</strong> il est possible d'exécuter conditionnellement des commandes : :</p>
<pre><code>michaellaunay@luciole:~$ VAR=2
michaellaunay@luciole:~$ if [ $VAR = 2 ]; then echo Vrai; else echo Faux;fi
Vrai
michaellaunay@luciole:~$ VAR=$HOME
michaellaunay@luciole:~$ if [ -w $VAR ]
&gt; then echo écriture possible dans $VAR
&gt; else echo écriture impossible dans $VAR
&gt; fi
écriture possible dans /home/michaellaunay</code></pre>
<h4 id="exécution-dopérations-arithmétiques">Exécution d'opérations arithmétiques</h4>
<p>La construction <strong>$[ nombre1 opérateur nombre2 ]</strong> permet de réaliser le calcul d'expression sur des entiers : :</p>
<pre><code>michaellaunay@luciole:~$ echo $[ 10 - 1 ]
9</code></pre>
<p>La création de variable et sa modification : :</p>
<pre><code>michaellaunay@luciole:~$ CMPT=[0] # équivalent à la ligne suivante
michaellaunay@luciole:~$ let CMPT=0
michaellaunay@luciole:~$ echo $CMPT
0
michaellaunay@luciole:~$ let CMPT+=1
michaellaunay@luciole:~$ echo $CMPT
1
michaellaunay@luciole:~$ let CMPT+=1
michaellaunay@luciole:~$ echo $CMPT
2</code></pre>
<h4 id="la-boucle-while-et-until">La boucle while et until</h4>
<p><strong>While</strong> permet d'exécuter des commandes tant que la condition est satisfaite alors que <strong>until</strong> exécute des commandes tant que la condition échoue.</p>
<p>Exemple : :</p>
<pre><code>michaellaunay@luciole:~$ VAR=4
michaellaunay@luciole:~$ while [ $VAR -gt 0 ]
&gt; do
&gt; echo itération $VAR;
&gt; VAR=$[ $VAR - 1 ]
&gt; done
itération 4
itération 3
itération 2
itération 1</code></pre>
<h4 id="la-boucle-for">La boucle for</h4>
<p>Pour chaque élément d'un ensemble, on exécute une commande : :</p>
<pre><code>michaellaunay@luciole:~$ NORD=&quot;Lille Roubaix&quot;
michaellaunay@luciole:~$ CENTRE=&quot;Paris Chartres&quot;
michaellaunay@luciole:~$ SUD=&quot;Nice Marseille&quot;
michaellaunay@luciole:~$ for ville in $NORD $CENTRE $SUD
&gt; do
&gt; echo Visiter $ville
&gt; done
Visiter Lille
Visiter Roubaix
Visiter Paris
Visiter Chartres
Visiter Nice
Visiter Marseille</code></pre>
<h4 id="le-choix-multiple-case">Le choix multiple (case)</h4>
<p>Permet de réaliser un branchement. Ne pas oublier les deux points-virgules à la fin d'un cas : :</p>
<pre><code>michaellaunay@luciole:~$ VAR=Lille
michaellaunay@luciole:~$ case $VAR in
&gt; &#39;lille&#39; | &#39;Lille&#39; | &#39;LILLE&#39; )
&gt;   echo J\&#39;y habite
&gt; ;;
&gt; &#39;paris&#39; | &#39;Paris&#39; | &#39;PARIS&#39; )
&gt;   echo J\&#39;y ai habité
&gt; ;;
&gt; * )
&gt;   echo Je ne connais pas
&gt; ;;
&gt; esac
J&#39;y habite</code></pre>
<h4 id="les-opérateurs-et">Les opérateurs &amp;&amp; et ||</h4>
<p>L'opérateur <strong>&amp;&amp;</strong> permet d'exécuter la commande suivante si la commande précédente réussit (retourne 0) : :</p>
<pre><code>michaellaunay@luciole:~$ grep refusée /var/log/user.log &gt; /tmp/connexion.txt &amp;&amp; vim /tmp/connexion.txt</code></pre>
<p>L'opérateur <strong>||</strong> permet d'exécuter la commande suivante si la commande précédente a échoué (retour de 1) : :</p>
<pre><code>michaellaunay@luciole:~$ grep refusée /var/log/user.log &gt; /dev/null || echo tout va bien</code></pre>
<h4 id="la-commande-trap">La commande trap</h4>
<p>Elle permet de positionner une fonction qui sera exécuté lors de la réception d'un signal (man 7 signal) : :</p>
<pre><code>trap &quot;echo Fin d\&#39;exécution&quot; EXIT
trap &quot;echo Interruption violente Ctrl-c&quot; SIGINT
trap &quot;echo Fin demandée&quot; SIGTERM
trap &quot;echo Reprise d\&#39;exécution&quot; SIGCONT
trap &quot;echo Signal USR&quot; SIGUSR1 SIGUSR2</code></pre>
<h4 id="la-commande-sed">La commande sed</h4>
<p>Elle permet de faire des traitements sur les lignes d'un flux. Par exemple elle permet de trouver un motif et de le remplacer. On la rencontre dans de nombreux scripts.</p>
<p>Par exemple dans la ligne suivante : :</p>
<pre><code>ls -1 | xargs -i echo mv {} {} | sed -e &quot;s/Ubuntu20.04_//2&quot; | bash</code></pre>
<p>"ls -1" affiche le contenu du répertoire courant, une ligne par fichier.</p>
<p>Le résultat est envoyé à <strong>xargs</strong> qui pour chaque ligne va créer une chaîne de caractères "mv contenu_ligne contenu_ligne"</p>
<p>Le résultat est envoyé à <strong>sed</strong> qui supprime la seconde occurence de la chaîne "Ubuntu20.04" qu'il rencontre.</p>
<p>Le résultat est exécuté par bash en transformant la chaîne de caractères reçu en ligne de commande.</p>
<p>Ici sed permet de renommer les fichiers de type Ubuntu20.04_00_EssayerOuInstaller.png en 00_EssayerOuInstaller.png.</p>
<p>À cette ligne complexe, on préférera renommer de façon plus élégante et rapide avec la ligne de cmd : :</p>
<pre><code>for filename in *; do mv $filename ${filename/Ubuntu20.04_/}; done</code></pre>
<p>Pour plus d'information sur <strong>sed</strong> voir <a href="https://www.commentcamarche.net/faq/9536-sed-introduction-a-sed-part-i">https://www.commentcamarche.net/faq/9536-sed-introduction-a-sed-part-i</a></p>
<h4 id="lexpansion-de-paramètre">L'expansion de paramètre</h4>
<p>Liste des Filtres pour l'expansion de paramètre du Shell <a href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html">https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html</a> : :</p>
<pre><code>${parameter} sera remplacé par la valeur de parameter
michaellaunay@luciole:~$ CMPT=$(( 1 + 20 / 2 )) # Réalise l&#39;opération puis affecte CMPT pour les opérations possibles voir https://www.gnu.org/software/bash/manual/html_node/Shell-Arithmetic.html#Shell-Arithmetic
michaellaunay@luciole:~$ echo ${CMPT}
11
michaellaunay@luciole:~$ name[1]=&#39;un&#39; # équivalent à &#39;declare -n name&#39; voir https://www.gnu.org/software/bash/manual/html_node/Arrays.html#Arrays
michaellaunay@luciole:~$ name[2]=&#39;deux&#39;
michaellaunay@luciole:~$ name[3]=&#39;trois&#39;
michaellaunay@luciole:~$ echo ${name[2]}
deux
# équivalent à 
michaellaunay@luciole:~$ name=(&#39;zero&#39; &#39;un&#39; &#39;deux&#39; &#39;trois&#39;)
michaellaunay@luciole:~$ echo ${name[1]}
un
michaellaunay@luciole:~$ unset name[0]
michaellaunay@luciole:~$ echo ${name[0]}

michaellaunay@luciole:~$ echo ${name[1]}
un</code></pre>
<h4 id="les-scripts">Les scripts</h4>
<p>Un script est un fichier qui contient une suite de commandes.</p>
<p>La première ligne permet d'indiquer le shell dans lequel doit être exécuté le script : :</p>
<pre><code>#!/bin/bash
echo c\&#39;est du bash</code></pre>
<p>Cette ligne s'appelle le <a href="http://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>.</p>
<h4 id="les-fonctions">Les fonctions</h4>
<p>Une fonction est une portion de code nommée, réutilisable qui a accès à toutes les variables du script ou du shell d'où elle est appelée : :</p>
<pre><code>michaellaunay@luciole:~$ function carré() {
&gt; echo $[ $1 * $1]
&gt; }
michaellaunay@luciole:~$ carré 3
9</code></pre>
<h4 id="lecture-des-saisies-clavier">Lecture des saisies clavier</h4>
<p>La commande <strong>read</strong> permet de lire la saisie clavier et de l'affecter avec une variable : :</p>
<pre><code>michaellaunay@luciole:~$ read VAR
coucou
michaellaunay@luciole:~$ echo $VAR
coucou</code></pre>
<h4 id="exercice">Exercice</h4>
<p>Réalisez une calculatrice demandant la saisie de la première opérande puis de l'opérateur (symbole ou littéral), puis de la seconde opérande. Affichez le résultat puis exécutez à nouveau tant que le signal SIGUSR1 n'est pas reçu.</p>
<h4 id="les-sous-programmes">Les sous-programmes</h4>
<p>Dans un shell on peut appeler un script directement en passant son nom si celui-ci est exécutable ou en le faisant interpréter par le shell pour lequel il a été écrit.</p>
<p>Lorsqu'on exécute un ensemble de commandes encadré par des parenthèses alors le shell courant démarre un sous shell pour exécuter les commandes : :</p>
<pre><code>michaellaunay@luciole:~$ VAR=0
michaellaunay@luciole:~$ (VAR=$[ $VAR + 1]; echo $VAR)
1
michaellaunay@luciole:~$ echo $VAR
0</code></pre>
<p>Il est également possible de forcer l'exécution de commande en utilisant <strong>`</strong> : :</p>
<pre><code>michaellaunay@luciole:~$ echo date
date
michaellaunay@luciole:~$ echo `date`
dimanche 19 avril 2020, 17:24:32 (UTC+0200)</code></pre>
<h4 id="la-complétion-de-commande">La complétion de commande</h4>
<p>En appuyant sur la touche tab le shell affiche toutes les commandes ayant pour préfixe les lettres déjà saisies sur la ligne de commande.</p>
<h4 id="historique-des-commandes">Historique des commandes</h4>
<p>Les commandes saisies dans un shell sont enregistrées dans le fichier ~/.bash_history</p>
<p>Il est possible d'accéder aux anciennes commandes en utilisant les flèches.</p>
<h3 id="les-commandes">Les commandes</h3>
<h4 id="se-déplacer-dans-larborescence">Se déplacer dans l'arborescence</h4>
<p>Les commandes : :</p>
<pre><code>ls        # Permet d&#39;afficher les informations d&#39;un fichier ou d&#39;un répertoire
ls UnChemin # Affiche le contenu de UnChemin si c&#39;est un répertoire, sinon affiche le nom de UnChemin
ls -lah   # Affiche les détails, les fichiers cachés, et utilise des unités informatiques
ls -F     # Affiche un / derrière le nom des répertoires 
info ls   # Permet de connaître le sens des colonnes des options de ls, par exemple le chiffre de la seconde colonne de l&#39;option -l est le nombre de hard links.
cd        # Permet de déplacer le répertoire courant
pwd       # Affiche le chemin du répertoire courant</code></pre>
<p>exemple : :</p>
<pre><code>michaellaunay@luciole:~$ ls -lh /
total 2,1G
drwxr-xr-x   2 root root  12K avril 19 16:40 bin
drwxr-xr-x   4 root root 4,0K avril  8 06:51 boot
drwxr-xr-x   2 root root 4,0K mai   16  2019 cdrom
drwxr-xr-x  19 root root 4,6K avril 18 22:11 dev
drwxr-xr-x 158 root root  12K avril 15 06:43 etc
drwxr-xr-x   5 root root 4,0K août  22  2019 home
lrwxrwxrwx   1 root root   32 janv.  6 18:48 initrd.img -&gt; boot/initrd.img-5.0.0-38-generic
lrwxrwxrwx   1 root root   32 janv.  6 18:48 initrd.img.old -&gt; boot/initrd.img-5.0.0-37-generic
drwxr-xr-x  21 root root 4,0K mars   5 06:28 lib
drwxr-xr-x   2 root root 4,0K mars   5 06:28 lib32
drwxr-xr-x   2 root root 4,0K mars   5 06:28 lib64
drwx------   2 root root  16K mai   16  2019 lost+found
drwxr-xr-x   3 root root 4,0K juin  24  2019 media
drwxr-xr-x   2 root root 4,0K févr. 10  2019 mnt
drwxr-xr-x   5 root root 4,0K août  26  2019 opt
dr-xr-xr-x 354 root root    0 avril 18 22:11 proc
drwx------   8 root root 4,0K mars  25 10:16 root
drwxr-xr-x  39 root root 1,1K avril 19 10:15 run
drwxr-xr-x   2 root root  12K avril 19 16:40 sbin
drwxr-xr-x  17 root root 4,0K mars  22 22:44 snap
drwxr-xr-x   2 root root 4,0K févr. 10  2019 srv
-rw-------   1 root root 2,0G mai   16  2019 swapfile
dr-xr-xr-x  13 root root    0 avril 18 22:11 sys
drwxrwxrwt  24 root root 4,0K avril 19 17:20 tmp
drwxr-xr-x  14 root root 4,0K août   1  2019 usr
drwxr-xr-x  15 root root 4,0K juin  17  2019 var
lrwxrwxrwx   1 root root   29 janv.  6 18:48 vmlinuz -&gt; boot/vmlinuz-5.0.0-38-generic
lrwxrwxrwx   1 root root   29 janv.  6 18:48 vmlinuz.old -&gt; boot/vmlinuz-5.0.0-37-generic


michaellaunay@luciole:~/Documents/ecreall/Cours$ cd
michaellaunay@luciole:~$ pwd
/home/michaellaunay</code></pre>
<p>Les jokers : :</p>
<pre><code>* # Désigne toute chaîne contiguë de caractères
? # Désigne un caractère
[...] # Permet de désigner des ensembles de caractères [4-69] accepte 4, 5, 6, et 9, [[] accepte [ identique à \[A
[^...] # Permet de désigner des ensembles à exclure</code></pre>
<p>Un <strong>chemin relatif</strong> est un chemin qui permet de se déplacer jusqu'au fichier cible à partir du chemin courant : :</p>
<pre><code>michaellaunay@luciole:~$ cd ~ # identique à cd $HOME ou cd
michaellaunay@luciole:~$ ls -l ../../etc/passwd
-rw-r--r-- 1 root root 1583 2009-04-02 11:35 ../../etc/passwd</code></pre>
<p><strong>.</strong> indique le répertoire courant alors que <strong>..</strong> indique le parent.</p>
<p>Un <strong>chemin absolu</strong> est un chemin qui commence à la racine <strong>/</strong> de l'arborescence et énonce tous les sous-répertoires jusqu'à la cible : :</p>
<pre><code>michaellaunay@luciole:~$ ls -l /etc/passwd
-rw-r--r-- 1 root root 1583 2009-04-02 11:35 /etc/passwd</code></pre>
<h4 id="création-suppression-de-répertoire">Création / suppression de répertoire</h4>
<p>La commande <strong>mkdir</strong> permet de créer des répertoires : :</p>
<pre><code>mkdir NomRep # Crée le répertoire NomRep.
mkdir -p Rep1/Rep2/Rep3 # Crée Rep3 et l&#39;arborescence Rep1/Rep2 si nécessaire.</code></pre>
<p>La commande <strong>rmdir</strong> permet de supprimer un répertoire vide, on peut aussi le faire avec <strong>rm -r</strong> dans le cas d'un répertoire non vide.</p>
<h4 id="lecture-de-fichier">Lecture de fichier</h4>
<p>La commande <strong>cat</strong> permet d'afficher le contenu d'un fichier.</p>
<p>La commande <strong>strings</strong> permet de n'afficher que les chaînes de caractères d'un fichier binaire.</p>
<h4 id="rechercher-des-fichiers">Rechercher des fichiers</h4>
<p>La commande <strong>find</strong> permet de réaliser des recherches basées sur les informations d'un fichier (nom, date de création, de modification etc.) : :</p>
<pre><code>michaellaunay@luciole:~$ find Documents/ecreall -name &quot;*pdf&quot; -ctime -2
# recherche à partir de Documents/ecreall tous les fichiers finissant par pdf, créés depuis moins de 2 jours
Documents/ecreall/Cours/CoursGNULinux/CoursGNULinux.pdf</code></pre>
<p>La commande <strong>grep</strong> permet de réaliser des recherches basées sur la présence d'une chaîne ou d'une expression régulière dans le contenu d'un fichier.</p>
<p>La commande <strong>locate</strong> permet de trouver un fichier si le chemin a été renseigné dans la base de données mise à jour par le super utilisateur avec <strong>updatedb</strong> ou <strong>slocate -u</strong>.</p>
<h4 id="archivage-compression">Archivage / Compression</h4>
<p><strong>zip</strong>, <strong>unzip</strong> permet de compresser et décompresser les fichiers aux format zip</p>
<p><strong>gzip</strong> permet de compresser et décompresser les fichiers au format gzip</p>
<p><strong>tar</strong> avec les options <strong>cf</strong> permet d'archiver une arborescence en conservant les informations de propriétaire, les dates de création, les permissions d'accès. Avec les options <strong>xf</strong>, permet d'extraire une archive.</p>
<p><strong>tar cfz</strong> permet de combiner <strong>tar</strong> et <strong>gzip</strong> en une commande. L'option <strong>--listed-incremental=nom_fichier.list</strong> permet d'enregistrer un snapshot des fichiers archivés en vue de permettre des tar incrémentaux. C.f. <a href="https://doc.ubuntu-fr.org/tar#utilisation_en_archivage_incrementiel">https://doc.ubuntu-fr.org/tar#utilisation_en_archivage_incrementiel</a> Attention il est indispensable que la première archive soit lancée avec cette option pour que l'incrémentation soit possible !</p>
<h4 id="autres-commandes">Autres commandes</h4>
<p><strong>mv</strong> permet de déplacer un fichier ou une arborescence.</p>
<p><strong>tail</strong> permet de n'afficher que les dernières lignes d'un fichier, l'option -f permet d'afficher le contenu au fur et à mesure de son arrivé dans le flux.</p>
<p><strong>tee</strong> permet d'écrire le contenu de la sortie standard dans un fichier tout en laissant ce contenu dans la sortie standard ce qui permet dans un pipe d'avoir une capture du contenu sans casser le pipe.</p>
<p><strong>ln</strong> permet de créer des liens. Ainsi <strong>ln -s Source Destination</strong> permet de créer un lien symbolique.</p>
<p><strong>cp</strong> permet de copier un fichier dans un autre. <strong>cp -r Rep1 Rep2</strong> copie toute l'arborescence Rep1 vers Rep2.</p>
<p><strong>script NOM_Fichier</strong> permet d'enregistrer la session (les interactions en ligne de commande) vers un fichier, ce qui permet de l'auditer voire de la rejouer. L'option -t permet d'enregistrer les dates des échanges vers le flux d'erreur. L'enregistrement sera arrêté par la commande <strong>exit</strong>. <strong>scriptreplay</strong> Permet de rejour la session. Exemple : <strong>NOM=`date +%y%m%d%H%m%S`_upgrade_jessie;script -t 2&gt;~/$NOM.time -a ~/$NOM.script</strong></p>
<h4 id="les-noms-de-fichiers">Les noms de fichiers</h4>
<p>Linux est sensible à la casse (majuscules vs minuscules).</p>
<p>Depuis 2007, l'ensemble du système utilise <a href="http://fr.wikipedia.org/wiki/Utf-8">utf-8</a> comme encodage par défaut, en conséquence tous les caractères accentués peuvent être utilisés pour nommer les fichiers.</p>
<p>Les caractères spéciaux et les espaces peuvent être utilisés à la condition d'être échappés.</p>
<p>La taille des noms ne doit pas excéder 255 octets.</p>
<p>Si l'on utilise des caractères accentués ou asiatiques, le nombre de caractères maximal est inférieur à 255, car il faut 2 à 4 octets pour représenter un caractère autre que ASCII en <a href="http://fr.wikipedia.org/wiki/Utf-8">utf-8</a>.</p>
<p>Tout fichier ou répertoire commençant par un <strong>.</strong> sera caché et accessible uniquement avec l'option <strong>-a</strong> de <strong>ls</strong>.</p>
<h4 id="les-attributs-des-fichiers">Les attributs des fichiers</h4>
<p>Les attributs de fichier permettent de gérer les permissions d'accès en lecture, écriture, exécution, traversée et également de connaître la nature du fichier.</p>
<p>Ainsi : :</p>
<pre><code>michaellaunay@luciole:~/Documents/ecreall/Cours$ ls -lh
total 24K
lrwxrwxrwx   1 michaellaunay users   11 2009-03-01 21:23 unLienSymbolique -&gt; unFichier
drwxr-x--- 139 michaellaunay users  12K 2009-04-30 09:12 unSousRep
drwx------   2 michaellaunay michaellaunay  16K 2009-03-01 21:21 lost+found
-rw-r-----   1 michaellaunay amis  32K 2009-04-02 11:35 unFichier
michaellaunay@luciole:~/Documents/ecreall/Cours/CoursGNULinux$ ls -l /bin/mount
-rwsr-xr-x 1 root root 98440 2008-09-25 15:08 /bin/mount
michaellaunay@luciole:~/Documents/ecreall/Cours/CoursGNULinux$ ls -l
drwxrwxrwt  19 root root  4096 2009-05-03 11:10 tmp</code></pre>
<p><em>lrwxrwxrwx 1 michaellaunay users 11 2009-03-01 21:23</em> est la liste des attributs qui doit être décomposée comme ceci : :</p>
<pre><code>première lettre :
  l indique que le fichier est un lien symbolique (un raccourci).
  d indique que le fichier est un répertoire
  - indique que le fichier est un fichier ordinaire
  c périphérique de type caractère
  b périphérique de type bloc
  s socket
  p fifo

premier groupe de 3 lettres :
  r-- indique que le propriétaire a le droit de lecture
  -w- indique que le propriétaire a le droit d&#39;écriture
  --x indique que le propriétaire a le droit d&#39;exécuter si le fichier est ordinaire
      indique que le propriétaire a le droit de traverser si le fichier est un répertoire
  --s (SUID) indique qu&#39;un utilisateur qui exécute le fichier usurpe les droits du propriétaire
      pour tous les accès effectués par l&#39;exécutable.
      Le propriétaire a les droits d&#39;exécuter ou de traverser (--x est positionné mais est caché).
  --S (SUID) indique qu&#39;un utilisateur qui exécute le fichier usurpe les droits du propriétaire.
      Le propriétaire n&#39;a pas les droits d&#39;exécuter ou de traverser (--x n&#39;est pas positionné).

second groupe de 3 lettres :
  même signification que précédemment, mais pour les groupes et sauf pour le SUID.
  --s (SGID) indique qu&#39;un utilisateur appartenant au groupe qui exécute le fichier usurpe les
      droits du groupe et que le groupe a les droits d&#39;exécution.
  --S (SGID) indique qu&#39;un utilisateur appartenant au groupe qui exécute le fichier usurpe les
      droits du groupe mais que le groupe n&#39;a pas les droits d&#39;exécuter ou de traverser.

troisième groupe de 3 lettres :
  même signification que précédemment, mais pour tous les autres utilisateurs et sauf SGID
  --t (Sticky bit) Indique que les utilisateurs ont le droit de modifier le contenu du fichier
      ou du répertoire, mais pas de le supprimer.
      Les utilisateurs ont le droit d&#39;exécution ou de traverser.
  --T (Sticky bit) Idem mais les utilisateurs n&#39;ont pas le droit d&#39;exécuter ou de traverser.</code></pre>
<p>Le fichier unFichier a pour propriétaire <em>michaellaunay</em> (owner) et pour groupe <em>amis</em> (owning group).</p>
<p>Les notions de permission et de groupe seront détaillées ci-après.</p>
<p>La taille du fichier unFichier est de 32ko.</p>
<p>La date est celle de dernière modification. La date du dernier accès est accessible avec la commande <strong>ls -u -l</strong>.</p>
<p>Les permissions d'un lien ne sont pas utilisées, car ceux sont celles de la cible qui sont vérifiées.</p>
<p>Si les permissions sont suivies d'un + alors des ACL sont positionnées.</p>
<h4 id="les-types-de-fichiers">Les types de fichiers</h4>
<p>Outre les fichiers normaux, les répertoires et les liens, il existe de nombreux fichiers spéciaux sous Unix.</p>
<p>En effet la philosophie d'Unix est de vouloir que tout soit fichier : :</p>
<pre><code>Les périphériques sont manipulés comme s&#39;ils étaient des fichiers.
Les piles (fifo, lifo), les pipes nommées, sockets sont manipulés comme des fichiers.
Les caractéristiques du système sont traduites à travers une arborescence.
Le noyau lui-même est adressé à travers une arborescence qui permet de connaître son état et de le modifier.
Les processus sont eux même manipulés à travers une arborescence de fichiers.</code></pre>
<h4 id="dev">/dev</h4>
<p>Contient les fichiers de périphériques physiques ou virtuels : :</p>
<pre><code>/dev/sda    # Premier disk scsi ou sata ou usb
/dev/sda1   # Première partition de /dev/sda
/dev/sdb    # Second périphérique scsi ou sata ou usb
/dev/cdrom  # Lien vers le périphérique gérant le cdrom
/dev/null   # Utile pour se débarrasser du contenu d&#39;un flux
/dev/zero   # Générateur d&#39;octet nul
/dev/random # Générateur aléatoire</code></pre>
<p>Exemple:</p>
<pre><code>michaellaunay@luciole:~$ find /usr -name &quot;*.pdf&quot; 2&gt; /dev/null
/usr/share/doc/shared-mime-info/shared-mime-info-spec.pdf
/usr/share/example-content/case_ubuntu_johnshopkins_v2.pdf
/usr/share/example-content/case_howard_county_library.pdf
/usr/share/example-content/case_oxford_archaeology.pdf
/usr/share/example-content/case_ubuntu_locatrix_v1.pdf
/usr/share/example-content/case_Skegness.pdf
/usr/share/example-content/case_Contact.pdf
/usr/share/example-content/case_OaklandUniversity.pdf
/usr/share/example-content/case_KRUU.pdf
/usr/share/example-content/case_Wellcome.pdf
/usr/share/evolution/2.24/help/quickref/fr/quickref.pdf
/usr/share/gnome/help/system-admin-guide/C/system-admin-guide.pdf
/usr/share/gnome/help/gnome-access-guide/C/gnome-access-guide.pdf
/usr/share/gnome/help/user-guide/C/user-guide.pdf</code></pre>
<p>Dans ce cas tous les messages d'erreur ont été envoyés à la poubelle.</p>
<h4 id="sys">/sys</h4>
<p><strong>sysfs</strong> est une arborescence virtuelle résidant en mémoire qui exporte des informations sur les périphériques.</p>
<p>Cette arborescence offre plusieurs types de classement, une même information peut donc être trouvée de différente manière.</p>
<p>Les commandes telles que <strong>lsusb</strong> ou <strong>lspci</strong> vont chercher les informations dont elles ont besoin dans cette arborescence.</p>
<p><strong>/sys/class/</strong> montre les périphériques regroupés en classes : :</p>
<pre><code>michaellaunay@luciole:~$ ls /sys/class/
atm        firmware       ieee1394_protocol  pci_bus        scsi_disk     usb_host
backlight  gpio           ieee80211          pcmcia_socket  scsi_generic  vc
bdi        graphics       input              power_supply   scsi_host     video_output
block      hidraw         leds               ppdev          sound         vtconsole
bluetooth  hwmon          mem                printer        spi_master
dma        ieee1394       misc               rfkill         thermal
dmi        ieee1394_host  mmc_host           rtc            tty
drm        ieee1394_node  net                scsi_device    usb_endpoint

michaellaunay@luciole:~$ cat /sys/class/thermal/cooling_device0/type
Processor
michaellaunay@luciole:~$ cat /sys/class/thermal/cooling_device0/cur_state
0</code></pre>
<h4 id="proc">/proc</h4>
<p><strong>procfs</strong> est une arborescence virtuelle résidant en mémoire qui exporte des informations sur le noyau.</p>
<p>C'est dans cette arborescence que des commandes comme <strong>ps</strong> vont chercher des informations sur les processus.</p>
<p>Exemple : :</p>
<pre><code>michaellaunay@luciole:~$ cat /proc/cpuinfo
processor : 0
vendor_id : GenuineIntel
cpu family    : 6
model     : 15
model name    : Intel(R) Core(TM)2 Duo CPU     L7500  @ 1.60GHz
stepping  : 11
cpu MHz       : 800.000
cache size    : 4096 KB
physical id   : 0
siblings  : 2
core id       : 0
cpu cores : 2
apicid        : 0
initial apicid    : 0
fpu       : yes
fpu_exception : yes
cpuid level   : 10
wp        : yes
flags     : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi
          mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good
          nopl pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr lahf_lm ida
bogomips  : 3191.95
clflush size  : 64
cache_alignment   : 64
address sizes : 36 bits physical, 48 bits virtual
power management:</code></pre>
<p>/proc permet en tant que root et selon l'état du processus observé d'analyser ses ressources et sa mémoire.</p>
<p>Ainsi il est possible de récupérer le contenu de la mémoire du processus arrêté. Voir <a href="https://unix.stackexchange.com/questions/6301/how-do-i-read-from-proc-pid-mem-under-linux">https://unix.stackexchange.com/questions/6301/how-do-i-read-from-proc-pid-mem-under-linux</a> et <a href="https://unix.stackexchange.com/questions/6267/how-to-re-load-all-running-applications-from-swap-space-into-ram/6271#6271">https://unix.stackexchange.com/questions/6267/how-to-re-load-all-running-applications-from-swap-space-into-ram/6271#6271</a></p>
<h3 id="enchaînement-et-parallélisation-des-commandes">Enchaînement et parallélisation des commandes</h3>
<p>Toute commande doit être vue comme une boîte noire ayant une entrée standard (stdin), une sortie standard (stdout) et une sortie d'erreur standard qui permet aussi d'afficher des informations (stderr).</p>
<p>Par défaut l'entrée standard est la saisie clavier et les sorties sont l'écran.</p>
<h3 id="les-flux-standards">Les flux standards</h3>
<p>Les flux standards stdin, stdout et stderr sont numérotés respectivement 0, 1 et 2.</p>
<p>En conséquence on peut utiliser ces numéros pour les désigner lors des redirections.</p>
<h3 id="input-output">Input, Output</h3>
<p>La notion d'input (entrée) et d'output (sortie) est relative à la commande, ainsi dans un pipe entre deux commandes l'entrée de la seconde commande et en fait la sortie de la première. Le système crée un flux entre les deux commandes nourri par la première et consommé par la seconde.</p>
<h3 id="les-redirections">Les redirections</h3>
<p>Les redirections vont permettre d'indiquer que faire des entrées et sorties standards.</p>
<p>Les redirections de fichier : :</p>
<pre><code>&gt;, 1&gt;  # Stocke la sortie standard dans un fichier
2&gt;     # Stocke la sortie des erreurs dans un fichier
&amp;&gt;     # Stocke les sorties dans un seul fichier
&gt;&amp;     # Idem
&gt;&gt;     # Concatène la sortie standard à la fin d&#39;un fichier
&lt;      # Utilise un fichier en entrée
|      # pipe, décrit ci-après</code></pre>
<h3 id="les-pipes">Les pipes</h3>
<p>Le pipe permet d'enchaîner les commandes, l'entrée d'une commande est alors le résultat de la commande précédente.</p>
<p>L'intérêt est de pouvoir créer des comportements complexes à partir de commandes simples. Cette association peut à son tour être manipulée comme une boite noire et être insérée dans un pipe plus complexe.</p>
<p>Exemple:</p>
<pre><code>netstat -anp |grep &#39;tcp\|udp&#39; | awk &#39;{print $5}&#39; | sed s/::ffff:// | cut -d: -f1 | sort | uniq -c | sort -n</code></pre>
<h3 id="les-alias">Les alias</h3>
<p>La commande intégrée alias permet de redéfinir des commandes : :</p>
<pre><code>alias rm=&quot;echo &#39;ça va couper&#39; &amp;&amp; rm&quot;</code></pre>
<p>La commande <strong>unalias</strong> supprime les alias.</p>
<h3 id="screen">screen</h3>
<p>La commande <strong>screen</strong> est un multiplexeur de terminaux il permet de gérer plusieurs shell et de ce déconnecter sans tuer les shell dont les commandes ne sont pas encore finies.</p>
<p>L'intérêt est de pouvoir réaliser des tâches d'administration longues sans devoir rester connecté, ou si le réseau n'est pas fiable de ne pas perdre le travail accompli en reprenant là ou la connexion s'est rompue.</p>
<p>Les options de bases : :</p>
<pre><code>michaellaunay@luciole:~$ screen -dmS Nom
michaellaunay@luciole:~$ screen -r Nom # Permet de se rattacher au terminal Nom
# Pour se détacher Crtl-a Ctrl-d
# Pour un nouveau Ctrl-a Ctrl-c
# Pour passer de l&#39;un à l&#39;autre : Ctrl-a Ctrl-n
# man screen</code></pre>
<h3 id="ssh">ssh</h3>
<p>La commande <strong>ssh</strong> permet de se connecter à distance sur une machine Unix ceci de façon chiffrée. Elle permet aussi d'ouvrir des tunnels chiffrés.</p>
<p>L'ouverture d'un tunnel entre 2 machines est de la forme : :</p>
<pre><code>ssh -L ${PORT_SOURCE}:${nom_machine_dest}:${PORT_DEST} ${USER}@${DEST}</code></pre>
<p>où ${PORT_SOURCE} est le numéro de port d'entrée du tunnel sur la machine où l'on est, ${nom_machine_dest} est soit localhost soit le nom de la machine destination soit une adresse du réseau privé derrière le serveur destination, ${PORT_DEST} est le numéro du port de sortie du tunnel sur la machine cible ${USER} est le nom d'utilisateur ${DEST} est le nom complet du serveur de destination</p>
<p>Exemple : :</p>
<pre><code>ssh -l 9880:localhost:80 michaellaunay@plateforme.test.com</code></pre>
<p>Me permet d'ouvrir un tunnel entre ma machine et le serveur plateforme en utilisant mon compte michaellaunay.</p>
<p>Une fois mon mot de passe ou ma clé acceptée je me retrouve sur la machine distante et un tunnel est ouvert entre ma machine locale et plateforme.</p>
<p>Si j'ouvre un navigateur sur ma machine et que je mets comme adresse <a href="http://localhost:9880">http://localhost:9880</a>, la communication est chiffrée et envoyée sur plateforme où elle ressort sur le port 80 ce qui me permet d'accéder au serveur web de plateforme1 sans que quiconque ne sache ce que je fais.</p>
<p>Compréhension de ssh :</p>
<blockquote>
<ul>
<li><a href="http://fr.wikipedia.org/wiki/Ssh">http://fr.wikipedia.org/wiki/Ssh</a></li>
<li><a href="http://web.archive.org/web/20110907084212/http://www.unixgarden.com/index.php/administration-systeme/principes-et-utilisation-de-ssh">http://web.archive.org/web/20110907084212/http://www.unixgarden.com/index.php/administration-systeme/principes-et-utilisation-de-ssh</a></li>
</ul>
</blockquote>
<p>Si la clé d'une machine à laquelle on se connecte habituellement a changé (cas d'une réinstallation), on peut être amené à supprimer son entrée dans le fichier <em>~/.ssh/known_hosts</em>.</p>
<p>Le plus simple est alors d'utiliser la commande <strong>ssh-keygen -R NomDeLaMachineDistante</strong>.</p>
<p>L'installation du deamon <strong>apt-get install ssh</strong></p>
<p>Pour sécuriser les connexions <strong>ssh</strong>, il faut éditer <em>/etc/ssh/sshd_config</em> et mettre l'option <em>PermitRootLogin=no</em> et ajouter en fin de fichier <em>AllowUsers idUtilisateurAutorise</em>.</p>
<p>La commande <strong>screen</strong> est très utilisée avec "ssh", elle permet de conserver le <strong>tty</strong> ouvert lors des déconnexions et donc de reprendre là où on en était. Il suffit de la relancer avec l'option "-r" pour rattacher une session précédente, de même en début de session on peut faire "Ctrl A" "esc" pour enregistrer les lignes et donc avoir la scroll bar.</p>
<p>Créer une clé:</p>
<pre><code>ssh-keygen</code></pre>
<p>Ajouter sa clé public à un serveur distant :</p>
<pre><code>ssh-copy-id user@Serveur_Distant</code></pre>
<p>Supprimer la clé d'un serveur distant :</p>
<pre><code>ssh-keygen -R NomServeurDistant</code></pre>
<p>On peut utiliser <strong>tar</strong> et <strong>ssh</strong> pour faire des archives à travers un flux sécurisé :</p>
<pre><code>tar cf - RepertoireSource | ssh user@ServeurSauvegarde &quot;cat &gt; nom_archive.tar&quot;</code></pre>
<p>La restauration se fera alors comme suit :</p>
<pre><code>ssh user@ServeurSauvegarde &quot;cat nom_archive.tar&quot; | tar xf</code></pre>
<h3 id="iptables-et-ufw">iptables et ufw</h3>
<p>La commande <strong>iptables</strong> permet de consulter et modifier les règles du firewall.</p>
<p>Le service <strong>ufw</strong> est un "firewall" pré-configurer que l'on peut facilement compléter.</p>
<p>Pour l'installer il suffit de faire :</p>
<blockquote>
<p>apt install ufw</p>
</blockquote>
<p>Pour connaître la liste des applications pouvant être autorisées par ufw à passer le firewall :</p>
<blockquote>
<p><a href="mailto:root@luciole">root@luciole</a>:~# ufw app list Applications disponibles :</p>
<pre><code>Apache
Apache Full
Apache Secure
Bind9
Dovecot IMAP
Dovecot Secure IMAP
OpenLDAP LDAP
OpenLDAP LDAPS
OpenSSH
Postfix
Postfix SMTPS
Postfix Submission</code></pre>
</blockquote>
<p>On pourra alors : soit autoriser les ports manuellement, soit autoriser les ports utilisés par une application.</p>
<blockquote>
<p>ufw allow OpenSSH</p>
</blockquote>
<p>Modification du firewall pour permettre en entrée http, https, smtp :</p>
<blockquote>
<p>vim /etc/ufw/ufw.conf # ENABLED=yes #si pas déjà positionné ufw allow 22/tcp # Ouvre le port ssh à tous (on peut restreindre à certaines adresses) ufw allow 80/tcp # Ouverture de http ufw allow 443/tcp # Ouverture de https ufw allow 25/tcp # Ouverture de smtp (envoi des courriels) ufw enable # Rend actif ufw</p>
</blockquote>
<p>Ces commandes permettent aussi de gérer ipv6</p>
<p>Vérification :</p>
<blockquote>
<p><a href="mailto:root@luciole">root@luciole</a>:/etc/dovecot# ufw status État : actif</p>
<p>Vers Action De ---- ------ --22/tcp ALLOW Anywhere 25/tcp ALLOW Anywhere 80/tcp ALLOW Anywhere 443/tcp ALLOW Anywhere 22/tcp (v6) ALLOW Anywhere (v6) 25/tcp (v6) ALLOW Anywhere (v6) 80/tcp (v6) ALLOW Anywhere (v6) 443/tcp (v6) ALLOW Anywhere (v6)</p>
</blockquote>
<p>Permettre le lancement au démarrrage:</p>
<pre><code>systemctl enable ufw</code></pre>
<h3 id="un-peu-de-configuration-pour-lutilisation-en-ligne">Un peu de configuration pour l'utilisation en ligne</h3>
<p>Beaucoup de paramètre par défaut peuvent être modifier dans /etc</p>
<h3 id="configurer-vim-and-bash">Configurer vim and bash</h3>
<p>Décommenter "syntax on" dans "/etc/vim/vimrc", ce qui permet d'avoir la coloration syntaxique.</p>
<p>Pour avoir la recherche dans l'historique des commandes en saisissant les premières lettres de la commande éditer "/etc/inputrc" et supprimer le guillemet de tête:</p>
<pre><code>&quot;\e[5~&quot;: history-search-backward
&quot;\e[6~&quot;: history-search-forward</code></pre>
<p>Pour faire de vim l'éditeur par défaut:</p>
<pre><code>echo &quot;export EDITOR=vim&quot; &gt; /etc/profile.d/editor.sh</code></pre>
<p>Pour augmenter le nombre de ligne dans l'historique des commandes, créer "/etc/profile.d/history.sh" en mettant:</p>
<pre><code># https://wiki.ubuntu.com/Spec/EnhancedBash
shopt -s histappend
PROMPT_COMMAND=&quot;history -a; $PROMPT_COMMAND&quot;
export HISTSIZE=1000
export HISTFILESIZE=1000
export GREP_OPTIONS=&#39;--color=auto&#39;</code></pre>
<h2 id="gestion-des-permissions-et-droits-daccès">Gestion des permissions et droits d'accès</h2>
<h3 id="concepts">Concepts</h3>
<p>Tous les utilisateurs ont un compte qui permet de les identifier.</p>
<p>Les programmes fonctionnant en tâche de fond (services) sont lancés depuis des utilisateurs créés spécialement pour eux. Ainsi, le serveur html <strong>apache</strong> est lancé depuis le compte <strong>www-data</strong>.</p>
<p>Les utilisateurs peuvent appartenir à des groupes ce qui permet de donner des droits à un ensemble d'utilisateurs très facilement.</p>
<p>Tout fichier appartient à un utilisateur et à un groupe.</p>
<p>La gestion des droits d'accès et d'exécution se résume alors à gérer les types d'accès en fonction du propriétaire, du groupe, et du reste des utilisateurs.</p>
<p>Comme vu précédemment la commande <strong>ls -l</strong> permet d'afficher les attributs d'un fichier et donc ses permissions.</p>
<p>À la création d'un fichier, les droits sont automatiquement positionnés en fonction de la valeur par défaut du système et de <strong>umask</strong> : :</p>
<pre><code>michaellaunay@luciole:~$ umask
0022
michaellaunay@luciole:~/tmp$ touch test1
michaellaunay@luciole:~/tmp$ ls -lh test1
-rw-r--r-- 1 michaellaunay michaellaunay 0 avril  5 12:17 test1
michaellaunay@luciole:~/tmp$ umask 027
michaellaunay@luciole:~/tmp$ touch test2
michaellaunay@luciole:~/tmp$ ls -lh test2
-rw-r----- 1 michaellaunay michaellaunay 0 avril  5 12:18 test2</code></pre>
<p>Le propriétaire est alors le créateur, et le groupe est généralement le groupe par défaut de l'utilisateur sauf dans le cas ou le répertoire porte le SGID alors le groupe est celui du répertoire.</p>
<h3 id="changer-le-propriétaire-ou-le-groupe-propriétaire">Changer le propriétaire ou le groupe propriétaire</h3>
<p>La commande <strong>chown</strong> permet de changer le propriétaire et le groupe d'un fichier : :</p>
<pre><code>root@luciole:~$ ls -l /tmp/MonFichier
-rw-rw-rw- 1 michaellaunay michaellaunay 0 2009-05-03 19:08 /tmp/MonFichier
root@luciole:~# chown root:users /tmp/MonFichier
root@luciole:~# ls -l /tmp/MonFichier
-rw-rw-rw- 1 root users 0 2009-05-03 19:08 /tmp/MonFichier</code></pre>
<p>Toutefois pour des raisons de sécurité (gestion des quotas : attaque sushi) la commande peut être réservée au super utilisateur.</p>
<p>On dispose aussi de la commande <strong>chgrp</strong> qui permet de changer le groupe d'un fichier.</p>
<h3 id="valeurs-symboliques-et-octales-des-permissions">Valeurs symboliques et octales des permissions</h3>
<p>Les tableaux suivants donnent les équivalents symboliques octales des permissions.</p>
<table style="width:62%;">
<colgroup>
<col style="width: 31%" />
<col style="width: 18%" />
<col style="width: 12%" />
</colgroup>
<tbody>
<tr class="odd">
<td>DROIT</td>
<td>LETTRE</td>
<td>VALEUR</td>
</tr>
<tr class="even">
<td>Lecture</td>
<td>r (read)</td>
<td>4</td>
</tr>
<tr class="odd">
<td>Écriture</td>
<td>w (write)</td>
<td>2</td>
</tr>
<tr class="even">
<td>Exécution / Traversé</td>
<td>x (execute)</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Ainsi les permissions <em>rwx</em> sont équivalentes à <em>7</em> et <em>rwxr-xr--</em> donne <em>754</em>.</p>
<table style="width:71%;">
<colgroup>
<col style="width: 18%" />
<col style="width: 40%" />
<col style="width: 12%" />
</colgroup>
<tbody>
<tr class="odd">
<td>DROIT</td>
<td>LETTRE</td>
<td>VALEUR</td>
</tr>
<tr class="even">
<td>SUID</td>
<td>s si le propriétaire a <em>x</em> S si non</td>
<td>4</td>
</tr>
<tr class="odd">
<td>SGID</td>
<td>s si le groupe a <em>x</em> S sinon</td>
<td>2</td>
</tr>
<tr class="even">
<td>Sticky Bit</td>
<td>t si les autres ont <em>x</em> T sinon</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Ainsi <em>rwsr-sr-t</em> est équivalent à <em>7755</em>.</p>
<p>Si l'on a un S ou un T en majuscule cela signifie que les droits d'exécution n'ont pas été positionnés.</p>
<p>Ceci n'a pas de sens dans le cas général et indique une suppression du droit d'exécution avec oubli du SUID ou GUID ou Sticky Bit.</p>
<p>Sauf avec l'usage des ACLs, où un utilisateur particulier peut avoir le droit d'exécution et redonne du sens à S ou T.</p>
<h3 id="changer-les-permissions-sur-les-fichiers">Changer les permissions sur les fichiers</h3>
<p>La commande <strong>chmod</strong> permet de modifier les droits des fichiers.</p>
<h4 id="mode-chiffré">Mode chiffré</h4>
<p>Exemple : :</p>
<pre><code>michaellaunay@luciole:~/tmp$ ls -l MonFichier
-rw-r--r-- 1 michaellaunay michaellaunay 0 2009-05-03 19:40 MonFichier
michaellaunay@luciole:~/tmp$ chmod 754 MonFichier
michaellaunay@luciole:~/tmp$ ls -l MonFichier
-rwxr-xr-- 1 michaellaunay michaellaunay 0 2009-05-03 19:40 MonFichier</code></pre>
<h4 id="notation-relative-aux-droits-existants">Notation relative (aux droits existants)</h4>
<p>Exemple : :</p>
<pre><code>michaellaunay@luciole:~/tmp$ ls -l MonFichier
-rwxr-xr-- 1 michaellaunay michaellaunay 0 2009-05-03 19:40 MonFichier
michaellaunay@luciole:~/tmp$ chmod u+s,g-x,o-r MonFichier
michaellaunay@luciole:~/tmp$ ls -l MonFichier
-rwsr----- 1 michaellaunay michaellaunay 0 2009-05-03 19:40 MonFichier</code></pre>
<p>Attention aux modifications contradictoires : :</p>
<pre><code>michaellaunay@luciole:~$ echo coucou &gt; /tmp/hello
michaellaunay@luciole:~$ ls -l /tmp/hello
-rw-r--r-- 1 michaellaunay michaellaunay 7 2009-05-07 09:45 /tmp/hello
michaellaunay@luciole:~$ sudo chmod u-w,o+w /tmp/hello
michaellaunay@luciole:~$ ls -l /tmp/hello
-r--r--rw- 1 michaellaunay michaellaunay 7 2009-05-07 09:45 /tmp/hello
michaellaunay@luciole:~$ echo bonjour &gt;&gt; /tmp/hello
bash: /tmp/hello: Permission non accordée</code></pre>
<h4 id="notation-absolue">Notation absolue</h4>
<p>Exemple : :</p>
<pre><code>michaellaunay@luciole:~/tmp$ ls -l MonFichier
-rwsr----- 1 michaellaunay michaellaunay 0 2009-05-03 19:40 MonFichier
michaellaunay@luciole:~/tmp$ chmod u=rx,g=rx,o=rx MonFichier
michaellaunay@luciole:~/tmp$ ls -l MonFichier
-r-xr-xr-x 1 michaellaunay michaellaunay 0 2009-05-03 19:40 MonFichier</code></pre>
<h3 id="umask">Umask</h3>
<p>Par défaut le système applique les droits 0666 pour un fichier et 0777 pour les répertoires auxquels il applique encore le filtre <strong>umask</strong> qui par défaut vaut 0022, les droits sont alors 0644 (rw-r--r--) pour un fichier et 0755 (rwx-rx-rx) pour un répertoire.</p>
<p>Il est possible de changer la valeur du masque de permissions en appelant <strong>umask nouvellevaleur</strong>.</p>
<h3 id="acl">ACL</h3>
<p>Le mécanisme de gestion des droits Unix couvre 95% des usages.</p>
<p>Il reste donc certains cas non couverts comme le fait d'attribuer les droits de modification d'un fichier à un utilisateur sans avoir à demander à l'administrateur de devoir créer un groupe (ce qui manque un peu de souplesse).</p>
<p>On peut aussi vouloir associer de nouveaux attributs aux fichiers pour par exemple gérer des informations de sécurités.</p>
<p>À l'inverse il est très difficile de restreindre les droits d'un utilisateur d'un groupe donné pour un seul fichier.</p>
<p>C'est pour répondre ce besoin qu'ont été implémentées les Access Control List</p>
<p>Les ACLs reposent sur le mécanisme des attributs étendus.</p>
<p>Pour les rendre disponibles, il faut que la partition soit montée avec les options <em>acl</em> et <em>user_xattr</em> (modifier en conséquence <em>/etc/fstab</em>).</p>
<p>Les fonctions d'accès aux <em>acl</em> sont <strong>getfacl</strong>, <strong>setfacl</strong>, <strong>getfattr</strong>, <strong>setfattr</strong>.</p>
<p>Voir aussi les man pages de <em>acl</em> et <em>attr(5)</em>.</p>
<h3 id="attributs-étendus">Attributs étendus</h3>
<p>Les attributs étendus permettent de gérer simplement les métadonnées associées à un fichier.</p>
<p>Ceux sont ces attributs étendus qui recevront les informations liées aux ACLs.</p>
<p>Pour installer le paquet : <strong>apt-get install attr</strong></p>
<p>Ajouter l'option <em>user_xattr</em> aux partitions dans <em>/etc/fstab</em>.</p>
<p>Puis utiliser <strong>setfattr</strong> pour positionner les attributs et <strong>getfattr</strong> pour les afficher : :</p>
<pre><code>michaellaunay@excalibur:~$ echo test &gt; MonFichier
michaellaunay@excalibur:~$ setfattr -n user.description -v &#39;Contient des données de test&#39; MonFichier
michaellaunay@excalibur:~$ ls -l MonFichier
-rw-r--r-- 1 michaellaunay michaellaunay 5 2009-05-05 08:17 MonFichier
michaellaunay@excalibur:~$ getfattr -d MonFichier
#file: MonFichier
user.description=&quot;Contient des donn\305\251es de test&quot;</code></pre>
<p>Remarque : La présence d'attributs étendus n'est pas signalée par <em>ls</em>.</p>
<h3 id="affectation-des-acl">Affectation des ACL</h3>
<p>Pour vérifier que les ACLs peuvent être activées : :</p>
<pre><code>michaellaunay@luciole:~$ grep -i acl /boot/config-`uname -r`

CONFIG_EXT2_FS_POSIX_ACL=y
CONFIG_EXT3_FS_POSIX_ACL=y
CONFIG_EXT4DEV_FS_POSIX_ACL=y
CONFIG_FS_POSIX_ACL=y
CONFIG_GENERIC_ACL=y
CONFIG_JFS_POSIX_ACL=y
CONFIG_NFSD_V2_ACL=y
CONFIG_NFSD_V3_ACL=y
CONFIG_NFS_ACL_SUPPORT=m
CONFIG_NFS_V3_ACL=y
CONFIG_REISERFS_FS_POSIX_ACL=y
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_XFS_POSIX_ACL=y</code></pre>
<p>Pour installer les ACL si besoin <em>apt-get install acl</em>.</p>
<p>Puis rendre la partition compatible avec les ACL (édition de fstab).</p>
<p>Exemple de changement de permissions : :</p>
<pre><code>root@excalibur:~# mkdir /tmp/MYDIR
root@excalibur:~# chacl u::rwx,u:michaellaunay:rwx,g::---,o::---,m::rwx /tmp/MYDIR
root@excalibur:~# ls -l /tmp
drwx------+ 2 root     root    4096 2009-05-04 22:37 MYDIR
root@excalibur:~# su - michaellaunay
michaellaunay@excalibur:~$ touch /tmp/MYDIR/MonFichier
michaellaunay@excalibur:~$ ls -l /tmp/MYDIR/
-rw-r--r-- 1 michaellaunay michaellaunay 0 2009-05-04 22:50 /tmp/MYDIR/
michaellaunay@excalibur:~$ setfacl -m isabelle:r /tmp/MYDIR/MonFichier
michaellaunay@excalibur:~$ setfacl -m g:users:- /tmp/MYDIR/MonFichier
michaellaunay@excalibur:~$ getfacl /tmp/MYDIR/MonFichier
getfacl: Removing leading &#39;/&#39; from absolute path names
# file: tmp/MYDIR/MonFichier
# owner: michaellaunay
# group: michaellaunay
user::rw-
user:isabelle:r--
group::r--
group:users:---
mask::r--
other::r--</code></pre>
<h2 id="les-processus">Les processus</h2>
<h3 id="définition">Définition</h3>
<p>Un processus est l'instance d'un programme en cours de fonctionnement.</p>
<p>Une application est constituée de un à plusieurs processus qui collaborent à la réalisation du travail demandé.</p>
<p>Chaque processus s'exécute en parallèle des autres.</p>
<p>Un processus correspond à un fichier exécutable.</p>
<p>Les processus utilisent des bibliothèques qui peuvent être statiques ou dynamiques selon qu'elles sont dans le code de l'application ou non.</p>
<p>L'extension des bibliothèques dynamiques est <em>.so</em> (shared object).</p>
<p>Un processus est lancé par un autre processus, ainsi il existe une relation père fils entre les processus.</p>
<p>Le processus ancêtre de tous les autres est <em>init</em> qui est lancé lors du démarrage par le noyau.</p>
<p>Son <em>PID</em> est 1.</p>
<p><strong>Alt+F2</strong> est un raccourci clavier permettant d'appeler le lanceur.</p>
<h3 id="attributs-dun-processus">Attributs d'un processus</h3>
<p>PID : Identifiant du processus (Process Identification),</p>
<p>PPID : Identifiant du processus père (Parent Process Identification),</p>
<p>PGID : Identifiant du groupe de processus qui permet de connaitre l'application à laquelle appartient le processus,</p>
<p>UID : Le compte utilisateur ayant lancé le processus,</p>
<p>GIDs : Les groupes de l'utilisateur ayant lancé le processus,</p>
<p>TTY : Terminal où a été lancé le processus,</p>
<p>NICE : Priorité appliquée pour le scheduling,</p>
<p>CMD : La commande à l'origine du proccessus.</p>
<h3 id="cycle-de-vie-dun-processus">Cycle de vie d'un processus</h3>
<p>Un processus est dans un état qui peut être "created", "ready", "running", "sleeping", "idle" (en attente de signal), "Terminated" = "zombie"</p>
<p><em>Created</em> correspond à l'état du processus au moment de sa création lorsque les variables ne sont pas encore renseignées.</p>
<p><em>Ready</em> le processus est en mémoire, les variables sont renseignées.</p>
<p><em>Running</em> le processus est en cours d'exécution.</p>
<p><em>Sleeping</em> le processus a été préempté.</p>
<p><em>Idle</em> le processus attend un signal.</p>
<p><em>Zombie</em> le processus a fini de s'exécuter, le code de retour attend sa lecture.</p>
<p>Voir : <a href="http://en.wikipedia.org/wiki/Process_states">http://en.wikipedia.org/wiki/Process_states</a></p>
<h3 id="les-différentes-sortes-de-processus">Les différentes sortes de processus</h3>
<p>On distingue les processus classiques des deamons qui sont les services unix.</p>
<p>Les deamons ou démons fonctionnent en arrière plan ils ont en général pour père le processus 1.</p>
<p>Les démons sont lancés et arrêtés à partir des scripts contenus dans <strong>/etc/init.d</strong>.</p>
<h3 id="envoi-de-signaux-aux-processus">Envoi de signaux aux processus</h3>
<p>L'envoi de signaux au processus se fait par la commande <strong>kill</strong> ou <strong>pkill</strong>.</p>
<p>Les processus peuvent établir entre eux une communication événementielle basé sur les signaux.</p>
<p>Seul les signaux <strong>9</strong> <strong>SIGKILL</strong>, et <strong>SIGSTOP</strong> ne peuvent être attrapés.</p>
<h3 id="les-commandes-liées-à-la-gestion-des-processus">Les commandes liées à la gestion des processus</h3>
<p>La commande <strong>free</strong> affiche les ressources mémoires consommées.</p>
<p>La commande <strong>fuser</strong> liste les processus accédant à un fichier.</p>
<p>La commande <strong>ldd</strong> affiche la liste des bibliothèques utilisées par un exécutable.</p>
<p>La commande <strong>lsof</strong> affiche les fichiers ouverts par un processus <strong>lsof -p PID</strong>.</p>
<p>La commande <strong>nice</strong> et <strong>renice</strong> permette de modifier la priorité d'exécution.</p>
<p>La commande <strong>pgrep</strong> recherche un processus par son nom.</p>
<p>La commande <strong>ps</strong> affiche les processus en cours.</p>
<p>La commande <strong>pstree</strong> affiche l'arborescence des processus.</p>
<p>La commande <strong>top</strong> affiche la liste de processus classés par consommation décroissante.</p>
<p>La commande <strong>uptime</strong> affiche les informations de temps de fonctionnement, du nombre d'utilisateurs connectés, de la charge.</p>
<h3 id="arrière-plan-avant-plan-détachement">Arrière plan / Avant plan / Détachement</h3>
<p>Pour lancer un processus en arrière plan on peut soit terminer la ligne de commande qui le lance avec <strong>&amp;</strong>, soit le lancer, faire <strong>Ctrl+z</strong> puis <strong>bg</strong>.</p>
<p>Lors du <strong>Ctrl+z</strong> la commande <strong>fg</strong> ramène le processus au premier plan.</p>
<p>La commande <strong>jobs</strong> permet de lister les processus suspendus, on peut alors les rattacher avec <strong>fg num_job</strong>.</p>
<p>Les processus dont le père meure sans attendre le statut de ses enfants sont raccrochés à <em>init</em>.</p>
<h3 id="modification-des-priorités">Modification des priorités</h3>
<p>Les processus ont des priorités fixées entre -20 (la plus haute) et +19.</p>
<p>Le <em>scheduler</em> gère l'ordre d'exécution des processus en fonction de cette priorité.</p>
<p>Par défaut un processus est lancé avec la priorité +10.</p>
<p>Seul l'administrateur peut donner des priorités négatives aux processus.</p>
<p>La commande <strong>nice [COMMAND [ARG]]</strong> permet de lancer une commande en lui donnant la priorité <em>p</em> si l'on passe l'option <em>-n p</em>.</p>
<p>La commande <strong>renice</strong> permet de modifier la priorité d'un processus.</p>
<h2 id="planification-de-tâches">Planification de tâches</h2>
<p>Sous unix deux démons sont chargés de la planification des tâches : <strong>atd</strong> qui permet de programmer une tâche différée et <strong>crond</strong> qui permet de programmer les tâches répétitives.</p>
<h3 id="la-commande-crontab">La commande crontab</h3>
<p><strong>crond</strong> est un service qui peut être programmé grace à la commande <strong>crontab</strong>.</p>
<p><strong>crontab -l</strong> liste les commandes déjà programmées pour l'utilisateur courant.</p>
<p><strong>crontab -e</strong> permet d'éditer le fichier des commandes programmées pour l'utilisateur courant.</p>
<p>L'éditeur utilisé par <strong>crontab -e</strong> est celui désigné par la variable <em>EDITOR</em>.</p>
<h3 id="le-fichier-crontab-système">Le fichier crontab système</h3>
<p>Ils est possible d'éditer directement le fichier /etc/crontab ou ceux contenu dans /var/spool/cron/crontabs/${USER}</p>
<p>Le format du fichier est le même que lors de l'édition avec <em>crontab -e</em>:</p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 11%" />
<col style="width: 19%" />
<col style="width: 11%" />
<col style="width: 26%" />
<col style="width: 15%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Minutes</td>
<td>Heures</td>
<td>Jour du mois</td>
<td>Mois</td>
<td>Jour de la semaine</td>
<td>Commande</td>
</tr>
<tr class="even">
<td>(0-60)</td>
<td>(0-24)</td>
<td>(0-31)</td>
<td>(1-12)</td>
<td>(0-6)</td>
<td>un script</td>
</tr>
</tbody>
</table>
<p>Le joker ***** permet d'indiquer que toutes les valeurs sont acceptées.</p>
<p>Pour les fichiers <em>cron</em> du système, une colonne <em>Utilisateur</em> s'intercale juste avant celle de la <em>commande</em>. Elle permet alors d'indiquer sous quel utilisateur doit être lancée la commande.</p>
<p>Exemple : :</p>
<pre><code>root@serveur:~# crontab -l
# m h  dom mon dow   command
00 4 * * * /usr/bin/webalizer -c /etc/webalizer/www_ecreall.conf
10 4 * * * /usr/bin/webalizer -c /etc/webalizer/ssl_ecreall.conf
* * * * * /root/load.sh update
0 * * * * /root/load.sh graph &gt; /dev/null

root@serveur:~# cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don&#39;t have to run the `crontab&#39;
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user    command
17 *  * * *   root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
25 6  * * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )
47 6  * * 7   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )
52 6  1 * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )
#</code></pre>
<p>Sur la plupart des distributions <em>/etc/crontab</em> lance les scripts contenus dans <em>/etc/cron.hourly</em>, <em>/etc/cron.daily</em>, <em>/etc/cron.weekly</em>, <em>/etc/cron.monthly</em>. Pour ajouter une tâche il suffit d'ajouter un script au répertoire désiré.</p>
<p>Les fichiers <em>/etc/cron.allow</em> et <em>/etc/cron.deny</em> permettent s'ils existent de nommer les utilisateurs pouvant programmer des tâches.</p>
<h3 id="la-commande-at">La commande at</h3>
<p><strong>at</strong> permet de lancer une commande à une heure donnée, la commande utilise le démon <strong>atd</strong></p>
<p><strong>atq</strong> permet de voir la liste des commandes en attente d'exécution.</p>
<p><strong>atrm</strong> Permet de supprimer une commande programmée.</p>
<p>Exemple : :</p>
<pre><code>root@server:~# apt-get install mailutils # Pour avoir la commande mail
root@server:~# at 6:45; mail -s &quot;Debout&quot; michaellaunay@ecreall.com &lt; reveil.msg</code></pre>
<p>Les fichiers <em>/etc/at.allow</em> et <em>at.deny</em> permettent comme pour cron de lister les utilisateurs pouvant ou non lancer <strong>at</strong>.</p>
<h2 id="les-utilisateurs-et-les-groupes">Les utilisateurs et les groupes</h2>
<p>Unix est un système multi-utilisateurs.</p>
<p>Tout fichier est associé à un propriétaire et à un groupe.</p>
<p>La gestion des droits dépend des notions d'utilisateur, de propriétaire, de groupe, et des autres.</p>
<p>Ceci suppose :</p>
<blockquote>
<ul>
<li>l'existence d'une base des comptes utilisateurs,</li>
<li>l'existence d'une base des groupes d'utilisateurs,</li>
<li>que tout fichier possède un utilisateur propriétaire et un groupe propriétaire,</li>
<li>que tout processus hérite des droits de l'utilisateur l'ayant lancé et par conséquent de l'ensemble des droits des groupes de l'utilisateur,</li>
<li>que l'utilisateur <em>root</em> a tous les droits pour pouvoir gérer le système.</li>
</ul>
</blockquote>
<h3 id="quest-quun-utilisateur">Qu'est qu'un utilisateur ?</h3>
<p>Chaque utilisateur d'un système Unix est associé à un identifiant unique qui lui permet de s'authentifier et d'accéder à son compte.</p>
<p>Ainsi au <em>login</em> le système demande à l'utilisateur son mot de passe.</p>
<p>Lorsque la connexion réussit le système associe à l'utilisateur l'<strong>UID</strong> (<strong>User IDentification</strong>) correspondant à son identifiant.</p>
<p>Le système associe également à l'utilisateur un <strong>GID</strong> (<strong>Groupe IDentification</strong>) qui est le groupe principal de l'utilisateur.</p>
<p>Ces numéros seront utilisés pour gérer les permissions des fichiers. Les commandes comme <em>ls</em> feront alors la correspondance entre les numéros et les noms d'utilisateurs et de groupes.</p>
<p>Un <strong>UID</strong> est associé à un répertoire personnel et à un shell.</p>
<p>L'UID 0 désigne l'utilisateur <strong>root</strong></p>
<p>Un utilisateur peut ne pas être une personne physique mais être l'utilisateur d'exécution d'un démon.</p>
<p>En conséquence, les <strong>UID</strong> des personnes physiques commencent généralement à partir de 1000.</p>
<h3 id="quest-quun-groupe">Qu'est qu'un groupe ?</h3>
<p>Les groupes permettent de créer des ensembles d'utilisateurs afin de gérer collectivement les permissions.</p>
<p>Généralement la création d'un utilisateur engendre la création de son groupe principal ayant pour identifiant de groupe le même identifiant et pour <strong>GID</strong> la même valeur que l'<strong>UID</strong>.</p>
<h3 id="gestion-des-comptes">Gestion des comptes</h3>
<h4 id="ajouter-un-utilisateur">Ajouter un utilisateur</h4>
<p>La création d'un nouvel utilisateur peut être faite à l'aide des commandes <strong>useradd</strong> ou <strong>adduser</strong> la seconde étant préférable, car interactive.</p>
<h4 id="supprimer-un-utilisateur">Supprimer un utilisateur</h4>
<p>La commande <strong>userdel</strong> permet de supprimer un utilisateur.</p>
<p>Avec l'option <em>-r</em> cette commande supprimera en plus le répertoire personnel de l'utilisateur.</p>
<h4 id="désactiver-un-compte-utilisateur">Désactiver un compte utilisateur</h4>
<p>L'une des façons les plus propres d'interdire la connexion à un utilisateur est de lui associer le shell <strong>nologin</strong> : :</p>
<pre><code>root@server:~# usermod -s /usr/sbin/nologin indesirable</code></pre>
<h4 id="changer-le-mot-de-passe-dun-utilisateur">Changer le mot de passe d'un utilisateur</h4>
<p>La commande <strong>passwd</strong> permet sous <em>root</em> de changer le mot de passe d'un utilisateur.</p>
<p>Si l'on est un utilisateur la commande demandera de saisir l'ancien mot de passe.</p>
<p>La commande <strong>chpasswd</strong> permet de scripter les changements de mots de passe.</p>
<h4 id="afficher-des-informations-dun-utilisateur">Afficher des informations d'un utilisateur</h4>
<p>La commande <strong>id</strong> permet d'afficher les informations de l'utilisateur : :</p>
<pre><code>michaellaunay@serveur:~$ id
uid=1000(michaellaunay) gid=1000(michaellaunay) groupes=4(adm),20(dialout),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),107(fuse),111(lpadmin),112(admin),1000(michaellaunay)</code></pre>
<p>La commande <strong>groups</strong> permet d'afficher les informations de groupe : :</p>
<pre><code>michaellaunay@luciole:~/Documents/ecreall/Cours/CoursGNULinux$ groups
michaellaunay adm dialout cdrom plugdev lpadmin admin sambashare</code></pre>
<p>La commande <strong>who</strong> permet de savoir qui est connecté sur la machine.</p>
<p>La commande <strong>whoami</strong> permet de savoir sous quelle identité on est connecté.</p>
<h4 id="modifier-les-informations-dun-utilisateur">Modifier les informations d'un utilisateur</h4>
<p>La commande <strong>usermod</strong> permet de modifier toutes les propriétés d'un utilisateur.</p>
<p>Faire <em>man usermod</em></p>
<p>La commande <strong>chsh</strong> permet de changer le shell de connexion.</p>
<p>La commande <strong>chfn</strong> permet de changer la description d'un utilisateur.</p>
<h4 id="changer-didentité">Changer d'identité</h4>
<p>La commande <strong>su</strong> permet de changer d'identité. <strong>su -</strong> permettra en plus d'utiliser l'environnement de l'utilisateur.</p>
<p>La commande <strong>sudo</strong> permet d'exécuter un script ou une commande en tant que <em>root</em>. <strong>sudo -i</strong> permet sous <em>Ubuntu</em> de se connecter en tant que <em>root</em>.</p>
<h3 id="gestion-des-groupes">Gestion des groupes</h3>
<h4 id="créer-un-groupe">Créer un groupe</h4>
<p>Comme pour l'utilisateur nous pouvons utiliser <strong>addgroup</strong> ou <strong>groupadd</strong></p>
<h4 id="afficher-des-informations-sur-les-groupes">Afficher des informations sur les groupes</h4>
<p>La commande <strong>groups</strong> déjà vu affiche les informations d'appartenance.</p>
<h4 id="ajouter-un-utilisateur-à-un-groupe">Ajouter un utilisateur à un groupe</h4>
<p>On utilise la commande <strong>usermod</strong> de la façon suivante : :</p>
<pre><code>root@server~# usermod -a -G cdrom,dev michaellaunay</code></pre>
<h4 id="ajouter-un-utilisateur-au-groupe-des-administrateurs">Ajouter un utilisateur au groupe des administrateurs</h4>
<p>usermod -a -G sudo identifiant_de_l_utilisateur</p>
<h4 id="changer-de-groupe-principal">Changer de groupe principal</h4>
<p>La commande <strong>newgrp</strong> permet de changer de groupe principal.</p>
<h4 id="modifier-un-groupe">Modifier un groupe</h4>
<p>Pour modifier un groupe nous pouvons utiliser la commande <strong>groupmod</strong>.</p>
<h4 id="supprimer-un-groupe">Supprimer un groupe</h4>
<p>La commande <strong>groupdel</strong> permet de supprimer un groupe.</p>
<h3 id="le-fichier-etcpasswd">Le fichier /etc/passwd</h3>
<p>Le fichier <em>/etc/passwd</em> contient la définition de tous les comptes.</p>
<h3 id="le-fichier-etcshadow">Le fichier /etc/shadow</h3>
<p>Le fichier <em>/etc/shadow</em> contient les mots de passe des comptes définis dans <em>/etc/passwd</em></p>
<h3 id="le-fichier-etcgroup">Le fichier /etc/group</h3>
<p>Le fichier <em>/etc/group</em> contient la définition de tous les groupes.</p>
<h3 id="installation-openldap">Installation openldap</h3>
<p>Ldap est un annuaire qui permet de gérer le utilisateur d'un service sans créer un compte unix.</p>
<p>Installation du serveur ldap :</p>
<blockquote>
<p>apt install slapd ldap-utils</p>
</blockquote>
<p>Modification de la configuration :</p>
<blockquote>
<p>dpkg-reconfigure slapd # saisie de "ecreall.com" comme domaine # saisie de "people" comme organization # saisie du mot de passe (comme celui de l'utilisateur michaellaunay mais pour LDAP)</p>
</blockquote>
<p>Attention ! Configurer LTS pour chiffrer les connexions si elles sont extérieures à la machine, car les mots de passe circulent en clair (voir <a href="https://wiki.debian.org/LDAP/OpenLDAPSetup#Enable_TLS.2FSSL">https://wiki.debian.org/LDAP/OpenLDAPSetup#Enable_TLS.2FSSL</a>)!</p>
<p>Activer le service au démarrage :</p>
<blockquote>
<p>systemctl enable slapd</p>
</blockquote>
<p>Rendre "ldap" accessible en éditant "/etc/ldap/ldap.conf" en ajoutant :</p>
<blockquote>
<p>BASE dc=ecreall,dc=com URI <a href="ldap://127.0.0.1">ldap://127.0.0.1</a></p>
</blockquote>
<p>Ajout d'une entrée LDAP :</p>
<blockquote>
<p>Créer un fichier ecreall.ldif contenant :</p>
<blockquote>
<p>dn: ou=People,dc=ecreall,dc=com ou: People objectClass: top objectClass: organizationalUnit</p>
<p>dn: ou=Group,dc=ecreall,dc=com ou: Group objectClass: top objectClass: organizationalUnit</p>
<p>dn: cn=Gérant,dc=ecreall,dc=com objectclass: organizationalRole cn: Gérant</p>
</blockquote>
<p>ldapadd -x -D "cn=admin,dc=ecreall,dc=com" -W -f ecreall.ldif</p>
</blockquote>
<p>Mettre à jour l'index (cache) :</p>
<blockquote>
<p>systemctl stop slapd slapindex chown -R openldap:openldap /var/lib/ldap systemctl start slapd</p>
</blockquote>
<p>Vérification :</p>
<blockquote>
<p>ldapsearch -x -b 'dc=ecreall,dc=com' '(objectclass=*)'</p>
</blockquote>
<p>Ajout d'une OrganizationUnit :</p>
<blockquote>
<p>Créer un fichier "e-services.ldif" et y mettre :</p>
<blockquote>
<p>dn: ou=Études,dc=ereall,dc=com objectClass: organizationalUnit ou: Études</p>
</blockquote>
<p>ldapadd -x -D "cn=admin,dc=ecreall,dc=com" -W -f e-services.ldif</p>
</blockquote>
<p>Ajouter une personne :</p>
<blockquote>
<p>Exemple pour ajouter Michaël Launay, créer un fichier "ldif_files/michaellaunay.ldif" :</p>
<blockquote>
<p>dn: cn=Michaël Launay, ou=People, dc=ecreall, dc=com objectclass: top objectclass: person objectclass: organizationalPerson objectclass: inetorgperson cn: Michaël Launay sn: Launay gn: Michaël uid: michaellaunay title: Gérant mail: <a href="mailto:michaellaunay@ecreall.com">michaellaunay@ecreall.com</a> telephoneNumber: 0320793290 officePostalAddress: 11 A Avenue de l'Harmonie postalCode: 59650 l: Villeneuve d ASCQ</p>
</blockquote>
<p>L'ajouter :</p>
<blockquote>
<p>ldapadd -x -D "cn=admin,dc=ecreall,dc=com" -W -f ldif_files/michaellaunay.ldif</p>
</blockquote>
</blockquote>
<p>Voir :</p>
<blockquote>
<p><a href="https://wiki.debian.org/LDAP/OpenLDAPSetup">https://wiki.debian.org/LDAP/OpenLDAPSetup</a> <a href="https://guide.ubuntu-fr.org/server/openldap-server.html">https://guide.ubuntu-fr.org/server/openldap-server.html</a> <a href="http://www-sop.inria.fr/members/Laurent.Mirtain/ldap-livre.html">http://www-sop.inria.fr/members/Laurent.Mirtain/ldap-livre.html</a></p>
</blockquote>
<h2 id="syslog">Syslog</h2>
<p><strong>Syslog</strong> est le système chargé d'enregistrer les fichiers journaux.</p>
<p>Le démon <strong>klogd</strong> consigne les événements de type message du noyau, authentification, connexion alors que <strong>syslogd</strong> enregistre les message d'envoi ou réception de courrier, ceux d'erreur, etc.</p>
<p>Les fichiers de messages se trouvent dans <em>/var/log</em></p>
<p><strong>syslogd</strong> est configuré avec le fichier <em>/etc/syslog.conf</em>. Ce fichier permet d'indiquer les sources de messages et les destinations associées (fichier, tty, application ou syslog d'une autre machine). Pour être prise en compte, la modification du fichier de conf doit être suivie par un <em>kill 1 $PID_SYSLOG</em>.</p>
<p>Toutefois de nombreux programmes n'utilisent pas <em>syslog</em> comme <em>CUPS</em>, <em>Samba</em>, etc.</p>
<p>Afin d'éviter que la taille des fichiers de logs n'explose la capacité du disque les fichiers sont compressés de façon régulière par <strong>logrotate</strong> dont la configuration est modifiable en éditant <strong>/etc/logrotate</strong></p>
<p>La commande <strong>dmesg</strong> permet d'afficher les messages du noyau.</p>
<h3 id="modification-de-la-configuration-de-logrotate">Modification de la configuration de logrotate</h3>
<p>Logrotate possède une configuration par défaut contenue dans "/etc/logrotate.conf" puis un répertoire avec les configurations des services pour compléter ou remplacer la configuration par défaut.</p>
<p>Il est fréquent que pour des raisons légales, on doive garder un ou deux ans de logs selon la nature des utilisateurs et des services. Souvant on garde 104 semaines de connexions et 52 semaines de navigation et 14 semaines pour les autres services.</p>
<p>Pour modifier la conf par défaut à 14 semaines on édite "/etc/logrotate.conf" : :</p>
<pre><code>- Remplacer &quot;rotate 4&quot; par &quot;rotate 14&quot; pour garder 3 mois de log par défaut
- Décommenter &quot;compress&quot; pour compresser les anciens fichiers log
- Ajouter delaycompress chaque vieux fichier de log
- Limiter la taille d&#39;un fichier de log à 100M</code></pre>
<p>On doit donc avoir dans /etc/logrotate.conf :</p>
<blockquote>
<p>rotate 14 compress delaycompress size 100M</p>
</blockquote>
<p>Puis on change "rotate X" à "rotate 104" dans les fichier des services concernés se trouvant dans le répertoire "/etc/logrotate.d/". Par exemple, on va modifier "/etc/logrotate.d/apache2" pour mettre rotate à 104, et modifier le fichier "/etc/logrotate.d/rsyslog" modifier les logs des services d'authentifications.</p>
<h2 id="périphérique-disque-et-système-de-fichiers">Périphérique disque et système de fichiers</h2>
<h3 id="les-disques-durs-sous-linux">Les disques durs sous Linux</h3>
<p>L'organisation physique d'un disque est constituée de plateaux superposés divisés en pistes concentriques.</p>
<p>Chaque piste contenant un certain nombre de secteurs de 512 octets.</p>
<p>L'ensemble des pistes des différents plateaux accessible sans nouveau déplacement des têtes de lecture constitue un cylindre.</p>
<p>Voire <a href="http://fr.wikipedia.org/wiki/Disque_dur">http://fr.wikipedia.org/wiki/Disque_dur</a>.</p>
<p>Le nommage des périphériques disques dépend de leur nature et de la façon dont ils sont gérés par le bios.</p>
<p>Ainsi sda, sdb correspondent à des disques durs alors que nvme0n1p7 correspond à un disque ssd monté sur le connecteur nvme.</p>
<p>Depuis 2013 les nommages des périphériques suivent les règles <em>ifname</em> voir : <a href="https://access.redhat.com/documentation/fr-fr/red_hat_enterprise_linux/7/html/networking_guide/sec-understanding_the_device_renaming_procedure">https://access.redhat.com/documentation/fr-fr/red_hat_enterprise_linux/7/html/networking_guide/sec-understanding_the_device_renaming_procedure</a></p>
<h3 id="les-concepts">Les concepts</h3>
<p>Un disque est "découpé" en partitions.</p>
<p>Le premier secteur contient le MBR (Master Boot Record) qui décrit la table des 4 premières partitions et contient également le code du chargeur primaire (primary loader).</p>
<p>L'une des quatre partitions primaires peut être du type étendue et contenir des partitions logiques qui sont alors chaînées entre elles.</p>
<p>La taille des partitions est donnée en nombre de cylindres, ce qui fixe le nombre de secteurs de la partition.</p>
<p>La partition possède un type qui fixe son usage, par exemple 83 pour Linux, 82 pour le swap, 5 pour une partition étendue, etc.</p>
<h3 id="les-systèmes-de-fichiers">Les systèmes de fichiers</h3>
<p>Un système de fichier est une structure de données permettant de stocker et organiser les informations dans des fichiers.</p>
<p>Le système de fichier est généralement stocké dans une partition mais il peut l'être sur un disque amovible (USB) ou dans un fichier.</p>
<h3 id="partitions">Partitions</h3>
<p>La numérotation des partitions est réalisée en accolant au nom du périphérique le numéro de la partition. Ainsi : :</p>
<pre><code>sda est le premier disque complet
sda1 est la première partition
sda4 est généralement la partition étendue
sda5 est la première partition logique
sdb est le second disque</code></pre>
<h3 id="utilitaires-de-partitionnement">Utilitaires de partitionnement</h3>
<p>Historiquement la commande permettant de créer les partitions était <strong>fdisk</strong>, mais elle est limité à des partitions de taille inférieure à 2To.</p>
<p>Elle est remplacée par la commande <strong>parted</strong> et par sa version graphique <strong>gparted</strong> qui permettent de créer et retailler des partitions déjà existantes, mais il faut descendre le paquet.</p>
<p>La commande <strong>partprobe</strong> permet d'avertir le système que l'on a modifié la tables des partitions.</p>
<h3 id="arborescence-standard-et-organisation-du-fhs">Arborescence standard et organisation du FHS</h3>
<p>Le Filesystem Hierachy Standard est l'organisation standard Unix utilisée par Linux</p>
<p>Tout est fichier. Les périphériques (scanner, imprimante, etc) sont manipulés sous forme de fichier dans lequel on va lire et écrire.</p>
<h4 id="arborescence-de">Arborescence de /</h4>
<p>/ est la racine, elle a pour contenu :</p>
<blockquote>
<ul>
<li>/bin contient les exécutables du système d'exploitation,</li>
<li>/boot les fichiers de démarrage,</li>
<li>/dev les périphériques sous forme de fichiers pouvant être lus ou écrits,</li>
<li>/etc les fichier de configuration et ceux nécessaires au démarrage,</li>
<li>/home les répertoires des utilisateurs,</li>
<li>/lib le bibliothèques partagées et les modules du noyau dans le sous répertoire modules,</li>
<li>/mnt les dossier des points de montage temporaires,</li>
<li>/proc les états du noyau,</li>
<li>/root le répertoire du super utilisateur root,</li>
<li>/sbin les exécutables du super utilisateur,</li>
<li>/sys contient les caractéristiques et informations sur les périfériques comme le nom du fabriquant, les bus connectés,</li>
<li>/tmp les fichiers temporaires liés à l'exécution des applications ou services, ils sont effacés au reboot,</li>
<li>/usr les ressources du système non essentielles (Unix Système Ressources)</li>
<li>/var les fichiers tels que les based de données, les pages html, les mails, les logs</li>
</ul>
</blockquote>
<ul>
<li>Pour une description plus complète C.f. <a href="http://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">http://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard</a></li>
</ul>
<h4 id="arborescence-de-usr">Arborescence de /usr</h4>
<p>/usr contient :</p>
<blockquote>
<ul>
<li>/usr/bin/ Binaires de l'utilisateur,</li>
<li>/usr/include/ Entêtes des bibliothèques partagées,</li>
<li>/usr/lib/ Bibliothèques partagées des logiciels utilisateurs,</li>
<li>/usr/local/ Hiérarchie pour les données de locales.</li>
<li>/usr/sbin/ Binaires pour l'administrateur,</li>
<li>/usr/share/ Fichiers indépendants de la plateforme (non binaires),</li>
<li>/usr/src/ Les sources du noyau,</li>
</ul>
</blockquote>
<h4 id="arborescence-de-var">Arborescence de /var</h4>
<p>/var contient:</p>
<blockquote>
<ul>
<li>/var/lib/ Données persistantes telles les bases de données,</li>
<li>/var/lock Les fichiers de verrous,</li>
<li>/var/log Les fichiers de Log</li>
<li>/var/mail Les mails si la configurations précise qu'ils doivent être stockés ici</li>
<li>/var/run Les informations d'exécution des daemons</li>
<li>/var/spool Les queues de traitement (mail, impression, etc)</li>
<li>/var/tmp Les fichiers temporaires à préserver des reboots</li>
</ul>
</blockquote>
<h3 id="formater-une-partition">Formater une partition</h3>
<p>La commande <strong>mkfs</strong> permet de formater une partition. Le type système de fichier est alors choisi à ce moment ex: <strong>mkfs.ext3</strong>.</p>
<h3 id="monter-démonter-une-partition">Monter / Démonter une partition</h3>
<p>Un système de fichier est accessible après son <em>montage</em> soit au démarrage, soit à l'aide de la commande <strong>mount</strong>.</p>
<p>Le démontage se fait à l'aide de la commande <strong>umount</strong>.</p>
<p>La commande <strong>sshfs</strong> permet de monter un disque distant à travers le protocole <strong>ssh</strong>. Pour démonter un système de fichier monté avec sshfs : <strong>fusermount -u point_de_montage</strong>.</p>
<h3 id="les-tables-de-montage-etcfstab">Les tables de montage : /etc/fstab</h3>
<p>Le fichier <strong>/etc/fstab</strong> contient les montages à réaliser au démarrage ou pour lesquels <em>root</em> a autorisé un montage manuel.</p>
<h3 id="tables-systèmes-inodes">Tables systèmes, inodes</h3>
<p>Un file system est composé de différentes tables systèmes :</p>
<blockquote>
<ul>
<li>Le super-bloc contenant les informations de taille, d'état de montage.</li>
<li>La table des <em>inodes</em> (nœud d'index) qui fait correspondre à chaque fichier un numéro d'identification unique et qui possède les informations des droits d'accès, de propriété.</li>
<li>Les répertoires qui sont une table de correspondance <em>inode</em> vers nom de fichier.</li>
</ul>
</blockquote>
<p>La commande <strong>ls -i</strong> permet d'afficher l'inode d'un fichier.</p>
<p>Remarques :</p>
<blockquote>
<ul>
<li>Les <em>inodes</em> ne contiennent pas le nom du fichier.</li>
<li>Un <em>file system</em> est limité en <em>inodes</em></li>
</ul>
</blockquote>
<h3 id="journalisation">Journalisation</h3>
<p>La journalisation permet d'enregistrer les manipulations réalisées sur les fichiers et l'arborescence.</p>
<p>Pour certain système de fichier elle enregistre en plus les différences, ce qui permet de revenir à un état précédent.</p>
<p>Les système simples permettent néanmoins de revenir au dernier état cohérent en cas de plantage du système.</p>
<p>Toutefois, les coupures de courant peuvent aboutir à des états incohérents, ceci à cause du cache en écriture des disques durs.</p>
<p>Au redémarrage de la machine la journalisation va permettre d'accélérer le diagnostique des disques.</p>
<p><strong>ext3</strong> est un système journalisé de manière simple.</p>
<h3 id="récupération-de-fichiers">Récupération de fichiers</h3>
<p>La journalisation sur les partitions de type ext3 et plus comme la ext4 permet de récupérer les fichiers supprimés. Pour cela il faut arrêter le système, le booter sur un système externe comme une clé usb bootable (live usb). Devenir root, installer sur le système externe extundelete : :</p>
<pre><code>apt install extundelete</code></pre>
<p>Repérer la partition contenant les fichiers à restaurer avec la commande lsblk. Puis appeler la commande extundelete : :</p>
<pre><code>sudo extundelete /dev/sda6 --restore-directory /home/michaellaunay/Maildir/cur/ --after 1636239600</code></pre>
<p>Où --restore-directory permet de dire dans quel répertoire on cherche à récupérer les fichiers. Et --after permet de dire à partir de quelle date de suppression on souhaite récupérer les fichiers. La date est en seconde à partir du 1er janvier 1970 (On peut utiliser datetime.</p>
<h3 id="contrôle-des-systèmes-de-fichiers">Contrôle des systèmes de fichiers</h3>
<p>La commande <strong>df</strong> permet de lister les montages réalisés.</p>
<p>La commande <strong>du</strong> permet de calculer la taille d'une arborescence.</p>
<p>La commande <strong>fsck</strong> permet de vérifier l'état d'une partition. ATTENTION ! Il ne faut pas l'utiliser sur des partitions montées.</p>
<p>La commande <strong>e2label</strong> permet d'affecter un nom à un <em>file system</em>.</p>
<p>La commande <strong>hdparm</strong> permet avec l'option <em>-t</em> de connaître les performances d'un disque.</p>
<h3 id="montage-des-périphériques-amovibles">Montage des périphériques amovibles</h3>
<p>La commande <strong>lsusb</strong> permet de voir les périphériques USB connectés.</p>
<p>La commade <strong>lspci</strong> permet de voir les périphériques PCI connectés.</p>
<p>Lorsqu'un périphérique de type blocs ou caractères est détecté par le noyau, un périphérique correspondant est ajouté dans <em>/dev</em> par le démon <strong>udevd</strong> du système <strong>udev</strong>.</p>
<p>Le système <strong>udev</strong> a pour rôle de gérer l'unicité des noms pour les prériphériques et de maintenir <em>/dev</em> en cohérence avec les périphériques présents.</p>
<p>Les fichiers de configuration de <strong>udev</strong> sont placés dans <em>/etc/udev</em>. Il est possible de définir des règles dans <em>/etc/udev/rules.d</em> qui seront évaluées dans l'ordre lexicographique.</p>
<p>Le démon HAL (Hardware Abstraction Layer) <strong>hald</strong> est notifié par <strong>udev</strong> de l'ajout d'un périphérique (règle <em>/etc/udev/rules.d/90-hal.rules</em>).</p>
<p><strong>HAL</strong> identifie alors le type des périphériques connectés, du système de fichers, et en fonction des informations comme <em>VendorId</em> ou <em>ProductId</em> d'associer le contenu avec un type d'application.</p>
<p>La base de données des périphériques est située dans le répertoire <em>/usr/share/hal/fdi/</em> : :</p>
<pre><code>michaellaunay@luciole:~$ grep -rl ipod /usr/share/hal/fdi/*
/usr/share/hal/fdi/information/10freedesktop/10-usb-music-players.fdi</code></pre>
<p>Une fois le périphérique complètement identifié, <strong>HAL</strong> envoie un message sur le bus de communication des applications <strong>D-Bus</strong>.</p>
<p>Les applications de l'environnement graphique vont alors monter le périphérique et le rendre accessible à l'utilisateur.</p>
<p>Sous <strong>gnome</strong> le comportement peut être modifié via le gestionnaire de fichiers <strong>nautilus</strong> dans Edition-Préférences-Supports**.</p>
<p>Exemple des noms persistants donnés par udev: :</p>
<pre><code>michaellaunay@luciole:~$ ls -lR /dev/disk
/dev/disk:
total 0
drwxr-xr-x 2 root root 260 avril 18 22:11 by-id
drwxr-xr-x 2 root root  80 avril 18 22:11 by-partlabel
drwxr-xr-x 2 root root 100 avril 18 22:11 by-partuuid
drwxr-xr-x 2 root root 160 avril 18 22:11 by-path
drwxr-xr-x 2 root root 100 avril 18 22:11 by-uuid

/dev/disk/by-id:
total 0
lrwxrwxrwx 1 root root  9 avril 18 22:11 ata-ST8000VN0022-2EL112_ZA1F9KQR -&gt; ../../sda
lrwxrwxrwx 1 root root 10 avril 18 22:11 ata-ST8000VN0022-2EL112_ZA1F9KQR-part1 -&gt; ../../sda1
lrwxrwxrwx 1 root root 13 avril 18 22:11 nvme-eui.0025385491b00f2f -&gt; ../../nvme0n1
lrwxrwxrwx 1 root root 15 avril 18 22:11 nvme-eui.0025385491b00f2f-part1 -&gt; ../../nvme0n1p1
lrwxrwxrwx 1 root root 15 avril 18 22:11 nvme-eui.0025385491b00f2f-part2 -&gt; ../../nvme0n1p2
lrwxrwxrwx 1 root root 13 avril 18 22:11 nvme-Samsung_SSD_970_EVO_Plus_1TB_S4EWNF0M403887L -&gt; ../../nvme0n1
lrwxrwxrwx 1 root root 15 avril 18 22:11 nvme-Samsung_SSD_970_EVO_Plus_1TB_S4EWNF0M403887L-part1 -&gt; ../../nvme0n1p1
lrwxrwxrwx 1 root root 15 avril 18 22:11 nvme-Samsung_SSD_970_EVO_Plus_1TB_S4EWNF0M403887L-part2 -&gt; ../../nvme0n1p2
lrwxrwxrwx 1 root root  9 avril 18 22:11 usb-Generic_STORAGE_DEVICE-0:0 -&gt; ../../sdb
lrwxrwxrwx 1 root root  9 avril 18 22:11 wwn-0x5000c500b5c4d662 -&gt; ../../sda
lrwxrwxrwx 1 root root 10 avril 18 22:11 wwn-0x5000c500b5c4d662-part1 -&gt; ../../sda1

/dev/disk/by-partlabel:
total 0
lrwxrwxrwx 1 root root 15 avril 18 22:11 &#39;EFI\x20System\x20Partition&#39; -&gt; ../../nvme0n1p1
lrwxrwxrwx 1 root root 10 avril 18 22:11  Sauvegardes -&gt; ../../sda1

/dev/disk/by-partuuid:
total 0
lrwxrwxrwx 1 root root 15 avril 18 22:11 54795468-79c2-48ce-9c7e-f6bd6aea6914 -&gt; ../../nvme0n1p2
lrwxrwxrwx 1 root root 15 avril 18 22:11 e9a9f238-ec93-4777-82e8-cbea7c8cf986 -&gt; ../../nvme0n1p1
lrwxrwxrwx 1 root root 10 avril 18 22:11 eeb50a63-ec05-4e34-b673-b90bc5ea2cfa -&gt; ../../sda1

/dev/disk/by-path:
total 0
lrwxrwxrwx 1 root root  9 avril 18 22:11 pci-0000:00:14.0-usb-0:1:1.0-scsi-0:0:0:0 -&gt; ../../sda
lrwxrwxrwx 1 root root 10 avril 18 22:11 pci-0000:00:14.0-usb-0:1:1.0-scsi-0:0:0:0-part1 -&gt; ../../sda1
lrwxrwxrwx 1 root root  9 avril 18 22:11 pci-0000:00:14.0-usb-0:5:1.0-scsi-0:0:0:0 -&gt; ../../sdb
lrwxrwxrwx 1 root root 13 avril 18 22:11 pci-0000:03:00.0-nvme-1 -&gt; ../../nvme0n1
lrwxrwxrwx 1 root root 15 avril 18 22:11 pci-0000:03:00.0-nvme-1-part1 -&gt; ../../nvme0n1p1
lrwxrwxrwx 1 root root 15 avril 18 22:11 pci-0000:03:00.0-nvme-1-part2 -&gt; ../../nvme0n1p2

/dev/disk/by-uuid:
total 0
lrwxrwxrwx 1 root root 10 avril 18 22:11 0a2768a9-34ac-4944-83a2-2e10ed4c48a5 -&gt; ../../sda1
lrwxrwxrwx 1 root root 15 avril 18 22:11 aad5ec2d-1dce-4a2b-8b07-2cd2bef72410 -&gt; ../../nvme0n1p2
lrwxrwxrwx 1 root root 15 avril 18 22:11 C3AC-80CA -&gt; ../../nvme0n1p1</code></pre>
<p>Voir :</p>
<blockquote>
<p><a href="https://doc.ubuntu-fr.org/udev">https://doc.ubuntu-fr.org/udev</a> <a href="https://web.archive.org/web/20100417131709/www.unixgarden.com/index.php/programmation/decouvertes-et-experimentation-avec-d-bus">https://web.archive.org/web/20100417131709/www.unixgarden.com/index.php/programmation/decouvertes-et-experimentation-avec-d-bus</a></p>
</blockquote>
<h3 id="utilitaire-smartd">Utilitaire smartd</h3>
<p>Smart signifie <strong>Self-Monitoring, Analysis and Reporting Technology</strong> c'est une technologie d'auto surveillance mise en œuvre par certains disques durs.</p>
<p>Le but de cette technologie est de permettre le suivi de l'usure "normale" des disques internes.</p>
<p>Lorsque les disques utilisés supportent les informations d'état <strong>smart</strong>, il devient possible de vérifier leur état, mais aussi de lancer un démon qui nous alerte en cas de risque.</p>
<p>Le contrôle se fait au détriment d'une légère perte de performance.</p>
<p>Installation : :</p>
<pre><code>root@luciole:~# apt-get install smartmontools</code></pre>
<p>Le démon smartd est alors installé et peu prévenir l'administrateur par mail lorsque les informations d'état des disques atteindront les seuils d'alertes.</p>
<p>La vérification se fait au démarrage et est modifiable en éditant <em>etc/smartd.conf</em>.</p>
<p>Si les erreurs disque n'ont pus être corrigées il faut fortement songer à changer de disque...</p>
<p>Attention à l'usage de <em>smart</em> avec le <em>RAID</em> qui pose problème avec certains contrôleurs.</p>
<p>Pour savoir si smart est activé sur le disque: :</p>
<pre><code>root@luciole:~# smartctl -i /dev/sda
smartctl version 5.38 [x86_64-unknown-linux-gnu] Copyright (C) 2002-8 Bruce Allen
Home page is http://smartmontools.sourceforge.net/

=== START OF INFORMATION SECTION ===
Device Model:     FUJITSU MHW2160BH PL
Serial Number:    K10FT7A25Y3B
Firmware Version: 0084001E
User Capacity:    160 041 885 696 bytes
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   8
ATA Standard is:  ATA-8-ACS revision 3b
Local Time is:    Sun May 24 18:33:45 2009 CEST
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

root@luciole:~# smartctl -A /dev/sda
smartctl version 5.38 [x86_64-unknown-linux-gnu] Copyright (C) 2002-8 Bruce Allen
Home page is http://smartmontools.sourceforge.net/</code></pre>
<p>Pour l'activer si nécessaire : :</p>
<pre><code>root@luciole:~# smartctl -s /dev/sda</code></pre>
<p>Consultation de l'état d'un disque : :</p>
<pre><code>=== START OF READ SMART DATA SECTION ===
SMART Attributes Data Structure revision number: 16
Vendor Specific SMART Attributes with Thresholds:
ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
  1 Raw_Read_Error_Rate     0x000f   100   100   046    Pre-fail  Always       -       182781
  2 Throughput_Performance  0x0005   100   100   030    Pre-fail  Offline      -       39256064
  3 Spin_Up_Time            0x0003   100   100   025    Pre-fail  Always       -       1
  4 Start_Stop_Count        0x0032   099   099   000    Old_age   Always       -       603
  5 Reallocated_Sector_Ct   0x0033   100   100   024    Pre-fail  Always       -       8589934592000
  7 Seek_Error_Rate         0x000f   100   100   047    Pre-fail  Always       -       1690
  8 Seek_Time_Performance   0x0005   100   100   019    Pre-fail  Offline      -       0
  9 Power_On_Hours          0x0032   080   080   000    Old_age   Always       -       10494
 10 Spin_Retry_Count        0x0013   100   100   020    Pre-fail  Always       -       0
 12 Power_Cycle_Count       0x0032   100   100   000    Old_age   Always       -       564
192 Power-Off_Retract_Count 0x0032   100   100   000    Old_age   Always       -       9
193 Load_Cycle_Count        0x0032   079   079   000    Old_age   Always       -       422760
194 Temperature_Celsius     0x0022   100   100   000    Old_age   Always       -       42 (Lifetime Min/Max 14/55)
195 Hardware_ECC_Recovered  0x001a   100   100   000    Old_age   Always       -       166
196 Reallocated_Event_Count 0x0032   100   100   000    Old_age   Always       -       453509120
197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       0
198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       0
199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0
200 Multi_Zone_Error_Rate   0x000f   100   100   060    Pre-fail  Always       -       10052
203 Run_Out_Cancel          0x0002   100   100   000    Old_age   Always       -       3732309344292
240 Head_Flying_Hours       0x003e   200   200   000    Old_age   Always       -       0</code></pre>
<p>Lecture du résultat : :</p>
<pre><code>TYPE :
    Old_age : indique qu&#39;un dépassement n&#39;est pas critique, nous avons simplement dépassé la valeur
              garantie par le constructeur.
    Pre-fail : indique que tout dépassement risque de provoquer une perte du disque.

UPDATED :
    Always : la valeur est maintenue à jour.
    Offline : la valeur est calculée uniquement lors des tests.

VALUE : La valeur actuelle du disque. Une valeur comprise entre 100 et 255 indique générelement
    une bonne santé du disque.

WORST : La pire valeur enregistrée par le disque.

THRESH : La valeur seuil en dessous de laquelle le disque commence à souffrir.

RAW VALUE : est la conversion de VALUE dans les unités utilisées par le constructeur.</code></pre>
<p>Il existe plusieurs types de tests pour mettre à jour les valeurs : :</p>
<pre><code>offline : le disque ne doit pas être monté.
short : test court sur les performances, les problèmes électriques et lectures/écritures physiques.
long : version longue du précédent.</code></pre>
<p>Lancement d'un test : :</p>
<pre><code>root@luciole:~# smartctl -t long /dev/sda
smartctl version 5.38 [x86_64-unknown-linux-gnu] Copyright (C) 2002-8 Bruce Allen
Home page is http://smartmontools.sourceforge.net/

=== START OF OFFLINE IMMEDIATE AND SELF-TEST SECTION ===
Sending command: &quot;Execute SMART Extended self-test routine immediately in off-line mode&quot;.
Drive command &quot;Execute SMART Extended self-test routine immediately in off-line mode&quot; successful.
Testing has begun.
Please wait 92 minutes for test to complete.
Test will complete after Sun May 24 20:18:57 2009

Use smartctl -X to abort test.</code></pre>
<p>Pour voir le résultat il faut soit consulter les <em>logs</em> soit : :</p>
<pre><code>smartctl -c /dev/sda
smartctl -l selftest /dev/sda
smartctl -A /dev/sda</code></pre>
<p>Configuration de <strong>smartd</strong> :</p>
<p>Le man de <strong>samrtd</strong> donne l'ensemble des informations permettant de configurer le démon qui scrute l'état des disques.</p>
<p>Informations :</p>
<blockquote>
<ul>
<li><a href="http://fr.wikipedia.org/wiki/Self-Monitoring,_Analysis_and_Reporting_Technology">http://fr.wikipedia.org/wiki/Self-Monitoring,_Analysis_and_Reporting_Technology</a></li>
<li><a href="http://linux-attitude.fr/post/Soyez-encore-plus-a-lecoute-de-vos-disques">http://linux-attitude.fr/post/Soyez-encore-plus-a-lecoute-de-vos-disques</a></li>
</ul>
</blockquote>
<h3 id="les-montages-en-raid">Les montages en raid</h3>
<p>Le RAID (Redundant Array of Independant Disk) permet d'augmenter la tolérance aux pannes ou d'avoir un espace de stockage plus rapide ou plus grand que ce que l'on obtiendrait avec un seul disque.</p>
<p>La tolérance est obtenue soit par mirroring, soit par calcul de parité.</p>
<p>Les performances sont obtenues par multiplexage des disques, par exemple un mot de 4 octets voit chacun de ses octets écrits en parallèle sur 4 disques différent.</p>
<p>La concaténation permet elle de disposer virtuellement d'un seul disque dont la capacité est la somme de chacun des disques.</p>
<p>Voir : <a href="http://fr.wikipedia.org/wiki/RAID_(informatique)">http://fr.wikipedia.org/wiki/RAID_(informatique)</a></p>
<h4 id="le-raid-0">Le RAID 0</h4>
<p>On cherche les performances sans tolérance aux pannes.</p>
<h4 id="le-raid-1">Le RAID 1</h4>
<p>L'information est dupliquée sur les disques qui sont donc montés en miroir.</p>
<h4 id="le-raid-5">Le RAID 5</h4>
<p>Il nécessite au minimum 3 disques.</p>
<p>Les informations sont stockées par bande (strip).</p>
<p>Par exemple pour un système à 3 disques, deux bandes de données et une de parité sont écrites alternativement sur les 3 disques.</p>
<p>Les bandes de parités sont écrites alternativement sur tous les disques façon a accroitre la résistance aux pannes.</p>
<p>Elles sont calculées en faisant un ou exclusif des bandes de données précédentes.</p>
<h4 id="la-gestion-du-raid-logiciel-par-linux">La gestion du RAID logiciel par Linux</h4>
<p>La commande <strong>mdadm</strong> permet de gérer les disques <em>RAID</em>.</p>
<p>La commande <strong>mdadm --create</strong> permet d'initialiser un disque <em>RAID</em>.</p>
<p>La commande <strong>mdadm --detail /dev/mdX</strong> affiche l'état d'un <em>RAID</em>.</p>
<p>La commande <strong>mdadm --deamonise /dev/mdX</strong> démarre le <em>RAID</em>.</p>
<p>Le fichier <em>/etc/mdadm/mdadm.conf</em> contient la configuration utilisée par mdadm au démarrage.</p>
<p>La commande <strong>mdadm --detail --scan --verbose</strong> permet de récupérer la configuration et si nécessaire de la stocker dans <em>/etc/mdadm/mdadm.conf</em> pour le prochain démarrage.</p>
<p>Lien : <a href="http://doc.ubuntu-fr.org/raid_logiciel">http://doc.ubuntu-fr.org/raid_logiciel</a></p>
<p>Exemple creation d'un dique : :</p>
<pre><code>fdisk /dev/sda #Pour la création de /dev/sda1
fdisk /dev/sdb #Pour la création de /dev/sdb1
mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1
mdadm --daemonise /dev/md0
#sinon en éditant /etc/mdadm/mdadm.conf on peut y ajouter
#ARRAY /dev/md0 level=raid1 num-devices=2 devices=/dev/sda1,/dev/sdb1</code></pre>
<p>Les périphérique <em>RAID</em> apparaissent sous <em>/dev/md#</em>.</p>
<h3 id="lvm">LVM</h3>
<p><strong>LVM</strong> Logical Volume Manager s'intercale entre le noyau et les partitions des disques afin de permettre :</p>
<blockquote>
<ul>
<li>de redimensionner les partitions,</li>
<li>de concaténer les disque,</li>
<li>de réaliser des instantanés du système de fichier.</li>
</ul>
</blockquote>
<p>Sa mise en place doit être faite dés le partitionnement (type 8E).</p>
<p><em>GRUB</em> ne fonctionne pas avec <em>LVM</em> il faut donc soit utiliser <em>Lilo</em> soit réserver LVM à <em>/home</em>.</p>
<p>Glossaire :</p>
<p><strong>PV</strong> <em>Physical Volume</em> est un disque ou un ensemble de disque utilisé par <em>LVM</em>,</p>
<p><strong>VG</strong> <em>Volume Group</em> est un ensemble de PV,</p>
<p><strong>LV</strong> <em>Logical Volume</em> est une partie du <em>VG</em> vue par l'utilisateur comme s'il s'agissait d'une partition,</p>
<p><strong>PD</strong> <em>Physical Device</em> est ensemble de partition d'un disque utilisé par <em>LVM</em>,</p>
<p><strong>PE</strong> <em>Physical Extent</em> est la plus petite unité de données gérée par LVM (~= 4Mo).</p>
<p>Les modules de <em>LVM</em> doivent être montés avec <em>modprobe dm_load</em>.</p>
<p>La commande <strong>vgscan</strong> permet de lancer <em>LVM</em>.</p>
<p>La commande <strong>pvcreate</strong> permet de créer un volume physique.</p>
<p>La commande <strong>vgcreate</strong> permet de regrouper le <em>PV</em> dans un groupe de volume.</p>
<p>La commande <strong>lvcreate</strong> permet de créer le volume logique.</p>
<p>Il ne faut pas oublier de formater un volume logique pour pouvoir s'en servir, on utilise alors <em>mkfs</em> classiquement.</p>
<p>La commande <strong>lvextend</strong> permet de modifier la taille d'un <em>LV</em>.</p>
<p>Pour retailler le système de fichier on utilisera la commande <strong>resize2fs</strong> après avoir démonté le système de fichier.</p>
<h2 id="python">Python</h2>
<p>Le scripting bash peut vite s'apparenter à du développement, alors pourquoi ne pas utiliser un vrai langage de programmation ?</p>
<h3 id="historique-1">Historique</h3>
<p>Python a été créé fin 1986 par Guido van Rossum au CWI (Institut de recherche en mathématique et informatique de Hollande), à partir de la version 1.2 en 1995 le CNRI (Corporation of Nationnal Research Initiative) finance le projet.</p>
<p>En 2000 Python passe en version 2.0 au sein de Be.open, puis l'équipe rejoint Digitial Creation (Futur Zope Corporation) en 2001. En mars 2001 création de la python fondation et libération complète du code.</p>
<h3 id="la-notion-dobjet">La notion d'objet</h3>
<p>Tout est objet.</p>
<h3 id="la-notion-de-classe">La notion de classe</h3>
<p>Tous les objets appartiennent à une classe.</p>
<h3 id="linstruction-print">L'instruction print</h3>
<p>Exemple : :</p>
<pre><code>print(1)
print(&quot;Hello world&quot;)
print(&#39;coucou&#39;)</code></pre>
<h3 id="les-primitives-daccès-aux-informations-de-type">Les primitives d'accès aux informations de type</h3>
<p><strong>id()</strong> renvoie l'identifiant d'un objet.</p>
<p><strong>type()</strong> renvoie le type de l'objet.</p>
<p><strong>dir()</strong> liste les attributs des objets.</p>
<h3 id="les-commentaires">Les commentaires</h3>
<p>Le caractère <strong>#</strong> marque le début d'un commentaire.</p>
<h3 id="les-chaînes-de-caractères">Les chaînes de caractères</h3>
<p>En python 3 l'encodage par défaut est UTF-8 qui est une représentation des types unicode.</p>
<p>On passe d'unicode au str en appelant la fonction encode (u"C'est la fête".encode('ISO-8859-15').</p>
<p>On passe du str au unicode par la fonction decode.</p>
<p>Les délimiteurs et types de chaînes :</p>
<blockquote>
<ul>
<li>Les guillemets <strong>"</strong> et <strong>"""</strong>,</li>
<li>Les apostrophes <strong>'</strong>,</li>
<li>Les chaînes raw <strong>r''</strong>,</li>
<li>Les chaînes formatable <strong>f''</strong>,</li>
</ul>
</blockquote>
<h3 id="les-numériques">Les numériques</h3>
<p>Les entiers (0 à 2^32) pour le type <strong>int</strong> et pour les entiers longs de type <strong>long</strong> on suffixe par un L ou l, la représentation octale commence par un 0 et l'hexadécimale par 0x.</p>
<p>Le type <strong>bool</strong> (True, False)</p>
<p>Les valeurs à virgule flottante (0.1 et 1e100) leur type est <strong>float</strong>.</p>
<p>Les nombres complexes (1 + 3j) leur type est <strong>complex</strong>.</p>
<h3 id="les-types-à-valeur-unique">Les types à valeur unique</h3>
<p>None</p>
<p>NotImplemented</p>
<h3 id="les-séquences">Les séquences</h3>
<p>Les tuples ()</p>
<p>Les listes []</p>
<p>Les dictionnaires {}</p>
<h3 id="les-opérateurs">Les opérateurs</h3>
<p>L'affectation =</p>
<p>La division / (Attention identique au C donc 5/6 = 0 mais 5.0/6 = 0.83333....)</p>
<p>La division entière //</p>
<p>Le modulo % ou divmod(5,3) = (1,2)</p>
<p>La négation -</p>
<p>L'inversion bit à bit ~ (complément à un)</p>
<p>La puissance **</p>
<p>Appartenance in</p>
<h3 id="opérateurs-binaires">Opérateurs binaires</h3>
<p>Le et <strong>&amp;</strong></p>
<p>Le ou <strong>|</strong></p>
<p>Le ou exclusif <strong>^</strong></p>
<h3 id="opérateurs-de-comparaison">Opérateurs de comparaison</h3>
<p>Inférieur <strong>&lt;</strong></p>
<p>Supérieur <strong>&gt;</strong></p>
<p>Inférieur égal <strong>&lt;=</strong></p>
<p>Supérieur égal <strong>&gt;=</strong></p>
<p>égalité <strong>==</strong> différence <strong>!=</strong> ou <strong>&lt;&gt;</strong></p>
<p>le est <strong>is</strong></p>
<p>le n'est pas <strong>is not</strong></p>
<h3 id="ordre-de-traitement-des-opérations">Ordre de traitement des opérations</h3>
<p>Parenthèses, Exposants, Division, Multiplication, Addition, Soustraction</p>
<h3 id="linstruction-pass">L'instruction pass</h3>
<h3 id="lindentation">L'indentation</h3>
<p>La création de block de code se fait par indentation.</p>
<h3 id="les-structures-conditionnelles">Les structures conditionnelles</h3>
<p>L'instruction if (else et elif)</p>
<p>L'instruction for in</p>
<p>L'instruction while</p>
<h3 id="les-fonctions-1">Les fonctions</h3>
<p>La définition des fonctions se fait à l'aide de l'instruction « def ».</p>
<p>La fonction est un objet.</p>
<p>Le code doit être indenté.</p>
<p>Les paramètres ne sont pas typés.</p>
<p>Les paramètres peuvent recevoir une valeur par défaut <em>p1 = 0</em>.</p>
<p>Les paramètres non explicites (ex: def f(**dict)) sont placés dans un dictionnaires.</p>
<p>Les paramètres arbitraires (ex : def f(*pars))sont placé dans un tuple.</p>
<p>Combinaison paramètres implicites et arbitraires (ex: def f(*pars, **dict)).</p>
<p>La directive return</p>
<p>La directive lambda</p>
<h3 id="les-docstrings">Les docstrings</h3>
<p>Les fonctions du code peuvent être documentées, ce qui permet lors de l'exécution d'un code d'interroger une fonction pour savoir comment elle fonctionne.</p>
<h3 id="les-décorateurs">Les décorateurs</h3>
<p>On peut en python définir des fonctions qui compléteront d'autres fonctions sur le principe de la composition mathématique.</p>
<p>Exemple : :</p>
<pre><code>def mondecorateur(fonction) :
  def nouvellefonction() :
     print(&#39;execution de %s&#39;%fonction .__name__)
     return fonction()
  return nouvellefonction

@mondecorateur
def f() :
  print(&#39;coucou&#39;)

f()
&gt;&gt;execution de f
&gt;&gt;coucou</code></pre>
<p>Utile pour tester les pré-conditions des fonctions.</p>
<h3 id="les-classes">Les Classes</h3>
<p>Les classes regroupent à la fois des données et des fonctions travaillant sur ces données.</p>
<p>Elles sont définies par l'instruction class</p>
<p>Les classes peuvent hériter d'autres classes.</p>
<p>Exemple : :</p>
<pre><code>class Animal(object):
  def __init__(self):
    self.age = 0
    self.poids = 0

class Chat(Animal):
   def __init__(self, nom):
     super(Chat, self).__init__() # Permet de construire la partie Animal
     self.nom = nom</code></pre>
<p>La notion de constructeur <strong>__init__</strong></p>
<p>La notion de destructeur <strong>__del__</strong></p>
<p>Les attributs privés</p>
<h3 id="les-exceptions">Les exceptions</h3>
<p>Les erreurs sont signalées par le mécanisme des exceptions : :</p>
<pre><code>&gt;&gt;&gt; try:
...    PasDefinie = None
... except NameError:
...    print(&quot;Variable non définie&quot;)
...
Variable non définie</code></pre>
<h3 id="les-modules">Les modules</h3>
<p>Les bibliothèques de programmation en python s'appellent des modules.</p>
<p>Primitive import</p>
<p>Primitive reload</p>
<h3 id="les-paquets">Les paquets</h3>
<p>Les modules sont généralement découpés en paquets qui se traduisent par des dossiers sur le disque.</p>
<h3 id="les-principaux-modules">Les principaux modules</h3>
<hr />
<p>Contient les primitives</p>
<h4 id="sys-1">sys</h4>
<p>Contient les informations relative à l'exécution en cours</p>
<h4 id="os">os</h4>
<p>Permet de gérer le système</p>
<h4 id="gzip-zipfile">gzip, zipfile</h4>
<p>Permettent de gérer les fichiers compressés.</p>
<h4 id="socket">socket</h4>
<p>Pour gérer les connexions TCP ou UDP</p>
<h4 id="urllib2">urllib2</h4>
<p>Pour gérer les connexions http</p>
<p>Liens :</p>
<blockquote>
<ul>
<li><a href="http://diveintopython.adrahon.org/">http://diveintopython.adrahon.org/</a></li>
<li><a href="http://docs.python.org/">http://docs.python.org/</a></li>
<li><a href="http://www.afpy.org/">http://www.afpy.org/</a></li>
</ul>
</blockquote>
<h2 id="initialisation-du-système-et-des-services">Initialisation du système et des services</h2>
<h3 id="la-séquence-de-boot">La séquence de boot</h3>
<p>Au démarrage de l'ordinateur, le bios cherche un périphérique d'amorçage selon l'ordre établi par sa séquence de boot.</p>
<p>Le bios lance le chargeur (loader) qui se trouve dans le MBR (Master Boot Record) et qui ne fait que 512 octets.</p>
<p>Si le chargeur est GRUB, alors le MBR ne contient que la 1er partie de GRUB appelée <em>stage 1</em> qui à pour unique rôle de charger stage 1_5 et stage 2.</p>
<p>Stage 1_5 contient le code d'accès aux différents systèmes de fichiers. Il est contenu dans les premiers secteurs et peut avoir une taille de 33ko.</p>
<p>Puis stage 2 est chargé, il peut être n'importe où sur le disque.</p>
<p>Stage 2 propose à l'utilisateur de choisir le système d'exploitation ou la version du noyau à démarrer à travers un menu.</p>
<p>L'utilisateur peut aussi modifier la configuration de démarrage en éditant le menu (appuyer sur <em>e</em>).</p>
<p>Stage 2 charge alors l'image du système d'exploitation choisi, le fichier se trouve généralement dans <em>/boot</em> et porte un nom du type <em>vmlinuz-2.6.XXX</em>.</p>
<p><em>/boot</em> contient aussi des fichiers <em>initrd</em> qui permettent de gérer les périphériques nécessitant le chargement de module spécifique (cas des systèmes de ficher non inclus au noyau).</p>
<p>Le menu de démarrage passe quelques options à l'image du système, notamment le nom du périphérique contenant la racine exemple : <em>root=/dev/sda1</em>.</p>
<p>Une fois le noyau lancé, il exécute <em>/sbin/init</em> avec 1 comme PID.</p>
<p><em>init</em> démarre les démons qui vont par exemple configurer les services réseau.</p>
<h3 id="grub">GRUB</h3>
<p><strong>GRUB</strong> est l'acronyme de GRand Unified Bootloader. C'est un programme GNU de démarrage permettant de choisir le système d'exploitation qui sera chargé.</p>
<p>Le fichier <em>/boot/grub/menu.lst</em> permet de créer le menu de démarrage, et d'imposer un choix par défaut. + <em>GRUB</em> peut charger l'image du noyau depuis le réseau.</p>
<p>La version 2 est celle installée avec Ubuntu 20.04.</p>
<p>La mise à jour du noyau entraine la modification du fichier <em>/boot/grub/grub.cfg</em>, mais il est possible de la forcer avec la commande <strong>update-grub</strong>.</p>
<p>Pour customiser le bootloader on doit éditer le fichier /etc/grub.d/40_custom</p>
<p>Lors du démarage de Grub on peut passer des options au kernel en appuyant sur la touche "e".</p>
<p>Voir la doc : <a href="https://doc.ubuntu-fr.org/grub-pc">https://doc.ubuntu-fr.org/grub-pc</a></p>
<h3 id="démarrage-du-noyau">Démarrage du noyau</h3>
<p>Il est possible de passer des options au noyau lors de son démarrage.</p>
<p>La syntaxe des options est : :</p>
<pre><code>option1=valeur option2=valeur1,valeur2</code></pre>
<h3 id="les-arguments-ou-paramètres-du-kernel">Les arguments ou paramètres du kernel</h3>
<p>Les principales options d'amorçage du noyau sont :</p>
<blockquote>
<ul>
<li>root=/dev/sda1 indique la partition système,</li>
<li>ro Indique que le système de fichier doit être monté en lecture seul,</li>
<li>init permet de démarrer un autre processus à la place d'<em>init</em>,</li>
<li>single ou emergency permet de passer en mode simple utilisateur et permet par exemple de pouvoir modifier le mot de passe root,</li>
<li>quiet démarre en mode silencieux,</li>
<li>nosmp n'utilise qu'un seul processeur,</li>
<li>noht pas d'hyper threading,</li>
<li>noapic pas de détection des interruptions,</li>
<li>nolapic aucune gestion des interruptions,</li>
<li>apm=off|on désactive ou active la gestion de l'alimentation en énergie,</li>
<li>noresume ne réveille pas une hibernation.</li>
</ul>
</blockquote>
<h3 id="systemd-vs-initv-vs-upstart">Systemd vs InitV vs upstart</h3>
<p>@TODO Systemd</p>
<p>InitV signifie Init system V.</p>
<p>Ce système est remplacé par <strong>upstart</strong> sur les dernières Ubuntu et Fedora.</p>
<p>Au démarrage, le noyau lance <em>init</em>.</p>
<p>L'ancien système était paramétrable via le fichier <em>/etc/inittab</em> qui est remplacé par la notion de <em>job</em>.</p>
<p><strong>init</strong> lit le répertoire <em>/etc/event.d</em> qui contient les jobs à lancer.</p>
<p>Chaque job réalise des actions en fonction du niveau d'exécution du noyau.</p>
<p><strong>init</strong> se charge de maintenir les jobs opérationnels.</p>
<p>La commande <strong>initctl</strong> permet de communiquer avec <strong>init</strong>.</p>
<p>La liste des jobs démarrés est donnés par <strong>initctl list</strong> : :</p>
<pre><code>root@luciole:~# initctl list
control-alt-delete (stop) waiting
last-good-boot (stop) waiting
logd (stop) waiting
rc-default (stop) waiting
rc0 (stop) waiting
rc1 (stop) waiting
rc2 (stop) waiting
rc3 (stop) waiting
rc4 (stop) waiting
rc5 (stop) waiting
rc6 (stop) waiting
rcS (stop) waiting
rcS-sulogin (stop) waiting
sulogin (stop) waiting
tty1 (start) running, process 10354
tty2 (start) running, process 8436
tty3 (start) running, process 8437
tty4 (start) running, process 8429
tty5 (start) running, process 8430
tty6 (start) running, process 8439</code></pre>
<p>Le lancement d'un job se fait par <em>initctl start rc0</em>, son arrêt par <em>initctl stop rc0</em>.</p>
<p>Liens :</p>
<blockquote>
<ul>
<li><a href="http://www.digitbooks.fr/articles/2-upstart.html">http://www.digitbooks.fr/articles/2-upstart.html</a></li>
</ul>
</blockquote>
<h3 id="les-niveaux-dexécution-run-level">Les niveaux d'exécution (Run level)</h3>
<p>Signification des niveaux pour Ubuntu : :</p>
<pre><code>Niveau S : Initialisation du système (le système de fichier est en read only),
Niveau 0 : Extinction,
Niveau 1 : Mode mono utilisateur,
Niveau 2 et 5 : Mode multi-utilisateurs avec réseau avec démarrage du serveur X,
Niveau 6 : Reboot.</code></pre>
<h3 id="le-système-de-démarrage-des-services">Le système de démarrage des services</h3>
<p>Lors du lancement d'<em>init</em> par le noyau, celui-ci transmet l'information de niveau à exécuter.</p>
<p>Ainsi <em>init</em> lance les jobs en leur précisant le niveau demandé.</p>
<p>Le job <em>rc5</em> lance <em>/etc/init.d/rc 5</em>, qui à son tour va lancer les scripts contenu dans <em>/etc/rc5.d</em> selon l'ordre lexicographique.</p>
<p>Les répertoires <em>/etc/rcX.d</em> contiennent des liens vers les scripts de <em>/etc/init.d</em>.</p>
<p>Les scripts contenus dans <em>/etc/init.d</em> permettent de démarrer, arrêter, ou connaître le statut des démons.</p>
<h3 id="changement-du-niveau-dexécution">Changement du niveau d'exécution</h3>
<p>Il est possible de changer le niveau d'exécution.</p>
<p>Exemple pour arrêter la machine :</p>
<blockquote>
<p><strong>initctl emit runlevel 0</strong></p>
</blockquote>
<h2 id="modules">Modules</h2>
<p>Le noyau Linux est modulaire.</p>
<p>La gestion de nombreux périphériques n'est pas faite dans le noyau mais dans des modules qui sont chargés à la demande.</p>
<p>La commande <strong>modprobe</strong> permet de charger un module directement par son nom.</p>
<p>La commande <strong>lsmod</strong> permet de connaître les modules déjà chargés.</p>
<p>La commande <strong>rmmod</strong> permet de supprimer un module du noyau.</p>
<p>Il est possible d'intégrer définitivement les modules au noyau en recompilant celui-ci.</p>
<h2 id="configuration-réseau-et-outils-tcpip">Configuration réseau et outils TCP/IP</h2>
<h3 id="introduction-1">Introduction</h3>
<p>L'unix BSD a été l'une des premières plateformes à supporter la pile protocolaire TCP/IP.</p>
<p>Dans cette tradition GNU/Linux regorge d'outils TCP, UDP, ICMP.</p>
<p>TCP signifie Transmission Control Protocol.</p>
<p>IP : Internet Protocol.</p>
<p>UDP : User Datagram Protocol.</p>
<p>ICMP : Internet Control Message Protocol.</p>
<p>Sous Ubuntu l'installation configure l'interface réseau en client DHCP (Dynamique Host Configuration Protocol).</p>
<p>De nombreux programmes communiquent entre eux sur la machine en utilisant l'interface réseau <em>loopback</em> de nom <em>localhost</em> et d'adresse <em>127.0.0.1</em> et ceci alors même que la connexion ne sort pas de la machine.</p>
<p>Liens :</p>
<blockquote>
<ul>
<li><a href="http://fr.wikipedia.org/wiki/Tcp">http://fr.wikipedia.org/wiki/Tcp</a></li>
<li><a href="http://fr.wikipedia.org/wiki/Internet_Protocol">http://fr.wikipedia.org/wiki/Internet_Protocol</a></li>
</ul>
</blockquote>
<h3 id="configuration-automatique">Configuration automatique</h3>
<p>Le protocole DHCP permet de demander à un serveur une adresse IP ainsi que les paramètres de connexion tels que le masque de sous réseau, les DNS, la passerelle.</p>
<p>La commande <strong>dhclient</strong>, permet de relancer la négociation avec le serveur.</p>
<p>Infos : <a href="http://fr.wikipedia.org/wiki/DHCP">http://fr.wikipedia.org/wiki/DHCP</a></p>
<h3 id="la-commande-ip">La commande ip</h3>
<p>La commande ip permet d'afficher et modifier toutes les interfaces réseaux.</p>
<p>ip addr : Affiche les adresses ip et toutes les informations. ip addr show dev em1 : Affiche les informations pour le périphérique em1 ip addr add 192.168.1.1/24 dev em1 : Ajoute l'adresse 192.168.1.1 avec le masque 24 au préiphérique em1.</p>
<p>ip link : Gère et affiche toutes les interfaces réseaux. ip link show dev em1 : Affiche les informations pour em1. ip -s link : ffiche les interfaces statiques. ip link set dev eno12345678 up : Met en fonctionnement l'interface eno12345678. ip link set dev eno12345678 down : Éteint l'interface eno12345678.</p>
<p>ip route : Affiche et permet la modification de la table de routage.</p>
<p>ip maddr : Affiche et permet la gestion des adresses multicast. ip maddr show dev em1 : Affiche les informations multicast de em1</p>
<p>ip neigh : Affiche les objets voisins c'est à dire la table ARP pour IPv4. ip neigh show dev em1 : Affiche le cache ARP de l'interface em1</p>
<p>La commande ip permet de consulter et changer l'état ou les paramettres de tous les types de périphériques réseaux. Elle remplace les commandes ifconfig, iwconfig, ifup/ifdown, route que nous détaillerons ci après, car elles sont encore proposées par certaines docs.</p>
<p>voir :</p>
<p><a href="http://cpham.perso.univ-pau.fr/ENSEIGNEMENT/UERHD/DescriptifCmdIP.pdf">http://cpham.perso.univ-pau.fr/ENSEIGNEMENT/UERHD/DescriptifCmdIP.pdf</a></p>
<p><a href="https://access.redhat.com/sites/default/files/attachments/rh_ip_command_cheatsheet_1214_jcs_print.pdf">https://access.redhat.com/sites/default/files/attachments/rh_ip_command_cheatsheet_1214_jcs_print.pdf</a></p>
<h3 id="ifconfig-déprécié">ifconfig (déprécié)</h3>
<p>La commande <strong>ifconfig</strong> permet à la fois de consulter les paramètres réseau mais également de configurer les interfaces. Cette commande est aujourd'hui obsolète et remplacée par <strong>ip</strong> que nous détaillerons ci-après, on peut l'installer avec <strong>apt install net-tools</strong>. Toutefois elle est beaucoup plus simple, mais moins complète que <strong>ip</strong> .</p>
<p>Exemple de configuration : :</p>
<pre><code>root@luciole:~# ifconfig eth0 192.168.0.7 netmask 255.255.255.0</code></pre>
<p>La configuration ainsi réalisée n'est pas permanent, elle sera perdue au prochain démarrage.</p>
<p>Pour modifier de façon permanente la configuration réseau il faut éditer <em>/etc/network/interfaces</em>.</p>
<p><strong>ifconfig</strong> est remplacé par la commande <strong>ip addr</strong> ou <strong>ip a</strong> <strong>ifconfig eth0 192.168.0.11</strong> est remplacé par <strong>ip addr add 192.168.0.11/255.255.255.0 dev enxe4b97aef38eb</strong> Les noms comme eth0 sont remplacés par la convention de nommage <strong>ifname</strong> pour éviter le changement de nom lors du reboot.</p>
<h3 id="iwconfig-déprécié">iwconfig (déprécié)</h3>
<p>La commande <strong>iwconfig</strong> permet de configurer les cartes wifi.</p>
<h3 id="ifupifdown-déprécié">ifup/ifdown (déprécié)</h3>
<p>La commande <strong>ifup</strong> permet de démarrer une interface réseau en fonction de la configuration indiquée dans <em>/etc/network/interfaces</em> Remplacée par <strong>ip link set NOM_PERIPHERIQUE up</strong></p>
<p>La commande <strong>ifdown</strong> permet de l'arrêter. Remplacée par <strong>ip link set NOM_PERIPHERIQUE down</strong></p>
<h3 id="route-déprécié">route (déprécié)</h3>
<p>La commande <strong>route</strong> permet de consulter et de fixer l'adresse de la passerelle : :</p>
<pre><code>root@luciole:~# route add default gw 192.168.0.1</code></pre>
<p>Remplacée par <strong>ip route</strong></p>
<p>En consultation elle est identique à <strong>netstat -nr</strong></p>
<h3 id="ip">ip</h3>
<p>La commande ip est le couteau suisse de la configuration réseau, son paquet <strong>iproute2</strong> remplace les commandes du paquet <strong>net-tools</strong> : :</p>
<pre><code>Attribuer une adresse : ::

  ip addr add 192.168.0.54/24 dev eth0

Connaitre son adresse : ::

  ip -4c addr show #-4 affiche uniquement les IPv4, -c pour l&#39;affichage couleur

Activer une interface réseau : ::

  ip link set eth0 update

Désactiver une interface réseau : ::

  ip link set eth0 down

Supprimer une adresse d&#39;une interface : ::

  ip addr del 192.168.0.54 dev eth0

Ajouter une gateway : ::

  ip route add default via 192.168.0.1</code></pre>
<h3 id="les-interfaces-virtuelles">Les interfaces virtuelles</h3>
<p>La création d'interface virtuelle permet de donner plusieurs adresses IP à une même carte réseau.</p>
<p>Cela permet par exemple de créer une adresse ip fixe pour une entrée DNS tout en la redirigeant via l'interface du datacenter vers une autre ip.</p>
<p>La ligne de commande est du type : :</p>
<pre><code>ip link add link DEVICE name NAME type vlan</code></pre>
<p>Voir <a href="https://www.systutorials.com/docs/linux/man/8-ip-link/">https://www.systutorials.com/docs/linux/man/8-ip-link/</a></p>
<h3 id="fixer-le-nom-de-machine">Fixer le nom de machine</h3>
<p>La commande <strong>hostname</strong> permet à la fois de consulter et de changer le nom de la machine.</p>
<p>Il est maintenant souhaitable d'utiliser la commande <strong>hostnamectl</strong> par exemple comme suit :</p>
<blockquote>
<p>hostnamectl set-hostname luciole</p>
</blockquote>
<p>En effet de nombreuse machines recoivent leur nom par la couche réseau lors du boot comme par exemple les images cloud.</p>
<p>Attention il ne s'agit pas du Fully Qualified Domain Name, mais seulement du nom de la machine sans le nom de domaine.</p>
<p>Il est possible aussi de modifier le nom de façon définitive via le fichier /etc/hostname</p>
<h3 id="positionner-le-reverse">Positionner le reverse</h3>
<p>Pour ne pas être considérer comme spameur lors de l'envoi de mail il faut positionner le "reverse" du serveur sur le même Full Qualified Domain Name (fqdn), c'est à dire que si on fait une recherche du nom de la machine à partir de son adresse ip, le résultat doit être le nom de la machine suivi de son domaine. Pour cela il faut :</p>
<pre><code>- Vérifier que dans la zone DNS de notre registrar, là où on a enregistré le nom de notre domaine, on a bien un champ A qui corresponde à l&#39;adresse de la machine ;
- Aller sur l&#39;interface d&#39;administration du serveur (Scaleway, OVH, Gandi, etc) ;
- Modifier le reverse en donnant le fqdn de la machine.</code></pre>
<p>Pour vérifier, il suffira de comparer l'adresse obtenu avec "dig $FQDN_Du_Serveur" avec "dig -x $IP_Du_Serveur".</p>
<h3 id="démarrage-et-arrêt-du-réseau">Démarrage et arrêt du réseau</h3>
<p>La commande <strong>/etc/init.d/networking start</strong> permet de démarrer la couche réseau.</p>
<h3 id="la-résolution-de-nom">La résolution de nom</h3>
<p>La commande <strong>dig</strong> permet de réaliser la résolution de nom.</p>
<p>La commande <strong>dig -x $ADRESSE_IP</strong> permet de réaliser la résolution inverse.</p>
<p>Le fichier <strong>/etc/resolv.conf</strong> est utilisé pour connaître les adresses des DNS.</p>
<h3 id="la-modification-du-fichier-etchosts">La modification du fichier /etc/hosts</h3>
<p>Le fichier <em>/etc/hosts</em> contient les adresses et noms des machines connues.</p>
<p>On y trouve au minimum la définition du loopback et de la machine.</p>
<p>Les valeurs qui y sont priment sur la résolution DNS.</p>
<p>Exemple : :</p>
<pre><code>michaellaunay@griffon:~$ cat /etc/hosts
127.0.0.1 localhost griffon griffon.ecreall.com
88.191.77.45    griffon.ecreall.com</code></pre>
<p>La modification est trivial puisqu'il suffit d'ajouter une ligne $Adresse $Nom1 $Nom2.</p>
<h3 id="les-outils-et-commandes-de-tests-réseau">Les outils et commandes de tests réseau</h3>
<h4 id="ping">ping</h4>
<p>La commande <strong>ping</strong> permet d'envoyer des paquets ICMP à une machine distante pour tester la connectivité du réseau.</p>
<h4 id="host">host</h4>
<p>Un autre utilitaire de résolution de nom de domaine. Traceroute ++++++++++</p>
<p>La commande <strong>traceroute</strong> permet de connaître les noeuds du réseau nous séparant d'un machine cible.</p>
<h4 id="netstat">netstat</h4>
<p>La commande <strong>netstat</strong> permet de connaître le statut des connexions réseaux.</p>
<p><strong>netstat -tp</strong> permet de voir les connexions restées ouvertes et les processus associés.</p>
<p>Exemple : :</p>
<pre><code>root@luciole:~# netstat -taupe
Connexions Internet actives (serveurs et établies)
Proto Recv-Q Send-Q Adresse locale          Adresse distante        Etat       User       Inode       PID/Program name
tcp        0      0 luciole.local:34978     ecs.amazonaws.com:www   ESTABLISHED michaellaunay 53652       11400/gvfsd-http
tcp        1      0 luciole.local:35516     ecs.amazonaws.com:www   CLOSE_WAIT  michaellaunay 50142       11400/gvfsd-http
tcp        1      0 luciole.local:50217     ecs.amazonaws.com:www   CLOSE_WAIT  michaellaunay 53380       11400/gvfsd-http
tcp        1      0 luciole.local:35515     ecs.amazonaws.com:www   CLOSE_WAIT  michaellaunay 50135       11400/gvfsd-http
tcp        0      0 luciole.local:34979     ecs.amazonaws.com:www   ESTABLISHED michaellaunay 53668       11400/gvfsd-http</code></pre>
<p>Permet de voir des connexions en direction du cloud d'Amazon, un <em>cat /proc/11400/cmd</em> donne : :</p>
<pre><code>root@luciole:~# cat /proc/11400/cmd
/usr/lib/gvfs/gvfsd-http--spawner:1.82/org/gtk/gvfs/exec_spaw/0</code></pre>
<p>On voit que la commande est <em>spawnée</em> ce qui signifie que si on la <em>kill</em> elle sera relancée par le système.</p>
<p>Après quelques recherches, il s'avère que c'est l'application <em>Rhythmbox</em> qui va chercher les couvertures des albums écoutés en utilisant le service gvfs.</p>
<h4 id="tcpdump">tcpdump</h4>
<p>La commande <strong>tcpdump</strong> permet "d'espionner" ce qui se passe sur nos interfaces réseau.</p>
<h4 id="nmap">nmap</h4>
<p>La commande <strong>nmap</strong> permet de scanner les ports d'un machine et donc de faire un diagnostic des éventuelles portes d'entrées.</p>
<h4 id="ngrep">ngrep</h4>
<p>La commande <strong>ngrep</strong> permet de n'afficher les paquets réseaux qu'à la condition qu'ils contiennent la chaîne cherchée.</p>
<h4 id="wireshark">wireshark</h4>
<p>Permet d'osculter les paquets réseaux comme ceux enregistrés par <strong>tcpdump</strong>. last ++++</p>
<p>La commande <strong>last</strong> permet de connaître les derniers <em>login</em> réalisés sur la machine, leur date et adresse d'origine.</p>
<h2 id="gestion-des-paquetages-et-installation-de-logiciels-sous-ubuntu">Gestion des paquetages et installation de logiciels sous Ubuntu</h2>
<h3 id="ubuntu-un-système-grand-public">Ubuntu, un système "Grand Public"</h3>
<p>Ubuntu simplifie extrêmement l'installation et devient donc facile d'accès pour un non linuxien.</p>
<h3 id="quelle-version-choisir-et-pour-quel-usage">Quelle version choisir et pour quel usage ?</h3>
<p>Il existe deux types de versions :</p>
<blockquote>
<ul>
<li>Une version serveur, dépouillée d'interface graphique, permettant d'utiliser RAID et LVM,</li>
<li>Une version pc de bureau, utilisant Gnome.</li>
</ul>
</blockquote>
<h3 id="les-dépôts">Les dépôts</h3>
<p>Nous avons vu précédemment la gestion graphique des dépôts.</p>
<p>Nous pouvons éditer le fichier <em>/etc/apt/sources.list</em> et ajouter des dépôts.</p>
<p>Exemple : :</p>
<pre><code>echo &quot;deb http://packages.medibuntu.org/ karmic free non-free&quot; &gt;&gt; /etc/apt/sources.list*</code></pre>
<p>Toutefois il faudra télécharger la clé d'authentification du nouveau dépôt et l'ajouter avec : :</p>
<pre><code>wget -q http://fr.packages.medibuntu.org/medibuntu-key.gpg -O- | sudo apt-key add -</code></pre>
<p>Puis mettre à jour le cache avec <strong>apt update</strong></p>
<h3 id="installation-de-paquets">Installation de paquets</h3>
<p>La commande <strong>apt install $NOM_PAQUET</strong> permet d'installer des paquets : :</p>
<pre><code>apt install libdvdread7 mkisofs dvdbackup dvdauthor oggvideotools ffmpeg
apt install libavcodec-58 libavdevice58 libavformat58</code></pre>
<h3 id="suppression-de-paquets">Suppression de paquets</h3>
<p>Pour supprimer un paquet on utilise <strong>apt remove $NOM_PAQUET</strong>.</p>
<h3 id="informations-sur-les-paquetages">Informations sur les paquetages</h3>
<p>Pour avoir la liste des paquets installés <strong>dpkg -l</strong>.</p>
<h3 id="recherche-de-paquetages">Recherche de paquetages</h3>
<p>La commande <strong>apt search $MOT_CLE</strong> permet de chercher un paquet à partir d'un mot de sa description.</p>
<h3 id="mise-à-jour-des-paquetages">Mise à jour des paquetages</h3>
<p>Pour mettre à jour la distribution : :</p>
<pre><code>apt update
apt upgrade</code></pre>
<h3 id="interfaces-graphiques">Interfaces graphiques</h3>
<p>Il existe deux types d'interfaces graphiques, une en mode texte <strong>aptitude</strong> et une dans X11 <strong>synaptic</strong>.</p>
<h3 id="commande-alien">Commande alien</h3>
<p>La commande alien permet de transformer un paquet <em>rpm</em> en paquet debian et donc de pouvoir l'installer.</p>
<h2 id="apache">Apache</h2>
<h3 id="présentation">Présentation</h3>
<p>Apache est un serveur web pouvant être utilisé comme proxy, cache etc.</p>
<p>Il supporte le protocole https et est donc utilisé pour servir les applications web à sécuriser.</p>
<h3 id="installation-1">Installation</h3>
<p>La commande <strong>apt install apache2</strong> permet d'utiliser une version récente d'Apache.</p>
<h3 id="configuration">Configuration</h3>
<p>Nous allons créer un petit site <em>www.monsite.com</em> et nous allons voir comment le sécuriser.</p>
<p>Dans un premier temps nous allons ajouter sur le poste client les entrées www.monsite.com pour réaliser des tests sans passer par le DNS.</p>
<p>Ajout de ssl.monsite.com /etc/hosts : :</p>
<pre><code>192.168.0.7 www.monsite.com</code></pre>
<p>Puis sur le serveur nous allons activer les modules utilisés pour la sécurisation : :</p>
<pre><code>root@monserveur:~# a2enmod ssl</code></pre>
<p>Cette commande créer 2 liens dans /etc/apache2/mods-enabled pointant vers ../mods-available/ssl.conf et ../mods-available/ssl.load.</p>
<p>Pour ajouter un site, il suffit de créer un fichier de configuration dans <em>/etc/apache2/sites-available</em> puis de l'activer : :</p>
<pre><code>root@monserveur:~# vim /etc/apache2/sites-available/www.monsite.com

  &lt;VirtualHost *:443&gt;
    ServerAdmin michaellaunay@ecreall.com
    ServerName www.monsite.com
    SSLEngine on
    SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP
    SSLCertificateFile /etc/apache2/ssl/server.crt
    SSLCertificateKeyFile /etc/apache2/ssl/server.key
    &lt;Directory /var/www/&gt;
                  Options Indexes FollowSymLinks MultiViews
                  AllowOverride None
                  Order allow,deny
                  allow from all
    &lt;/Directory&gt;
    DocumentRoot /var/www
  &lt;/VirtualHost&gt;

  &lt;VirtualHost *:80&gt;
    ServerAdmin michaellaunay@ecreall.com
    ServerName www.monsite.com
    &lt;Directory /var/www/&gt;
                  Options Indexes FollowSymLinks MultiViews
                  AllowOverride None
                  Order allow,deny
                  allow from all
    &lt;/Directory&gt;
    DocumentRoot /var/www
  &lt;/VirtualHost&gt;</code></pre>
<p>Puis d'activer le site : :</p>
<pre><code>root@monserveur:~# a2ensite www.monsite.com
root@monserveur:~# /etc/init.d/apache2 restart</code></pre>
<h3 id="sécurisation">Sécurisation</h3>
<p>La sécurisation de fait en ajoutant un certificat X 509 sous forme d'une clé privée et d'une clé privée.</p>
<p>Nous verrons au chapitre X 509 l'usage d'une clé auto-signée.</p>
<h3 id="traçage">Traçage</h3>
<p>La configuration des logs permet de surveillez les accès aux sites.</p>
<p>On constatera que pour un site mis en ligne sur internet les tentatives d'intrusions sont importantes.</p>
<h2 id="postfix">Postfix</h2>
<h3 id="présentation-1">Présentation</h3>
<p>Postfix est un distributeur de courrier.</p>
<p>Il a pour rôle de recevoir le courrier, de le stocker dans la boite mail du destinataire ou de le relayer à un autre serveur de mail si la boite destinataire n'est pas sur sa machine.</p>
<p>Nous allons voir comment utiliser spf et dkim pour authentifier les mails.</p>
<h3 id="ressources-postfix-spf-dkim-et-test">Ressources postfix, spf, dkim et test</h3>
<p><a href="https://www.nextinpact.com/article/30341/109074-emails-avec-spf-dkim-dmarc-arcet-bimi-a-quoi-ca-sert-comment-en-profiter">https://www.nextinpact.com/article/30341/109074-emails-avec-spf-dkim-dmarc-arcet-bimi-a-quoi-ca-sert-comment-en-profiter</a> <a href="https://www.bortzmeyer.org/7208.html">https://www.bortzmeyer.org/7208.html</a> <a href="https://ubuntu.tutorials24x7.com/blog/install-mail-server-on-ubuntu-20-04-lts-using-postfix-dovecot-and-roundcube">https://ubuntu.tutorials24x7.com/blog/install-mail-server-on-ubuntu-20-04-lts-using-postfix-dovecot-and-roundcube</a> <a href="https://ubuntu.tutorials24x7.com/blog/set-up-dkim-domainkeys-with-postfix-on-ubuntu-20-04-lts">https://ubuntu.tutorials24x7.com/blog/set-up-dkim-domainkeys-with-postfix-on-ubuntu-20-04-lts</a> <a href="https://www.linuxbabe.com/mail-server/setting-up-dkim-and-spf">https://www.linuxbabe.com/mail-server/setting-up-dkim-and-spf</a></p>
<p>Pour tester <a href="https://www.appmaildev.com/en/spf">https://www.appmaildev.com/en/spf</a></p>
<p>RFC en français <a href="https://www.bortzmeyer.org/7208.html">https://www.bortzmeyer.org/7208.html</a></p>
<p>Les variables d'opendkim <a href="http://www.opendkim.org/opendkim.8.html">http://www.opendkim.org/opendkim.8.html</a></p>
<h3 id="installation-2">Installation</h3>
<blockquote>
<p>apt install postfix</p>
</blockquote>
<p>Lors de l'installation il faut préciser le nom du host, mettez le FQDN. Il faut que le reverse ait été corectement positionné sinon les mails risquent d'être considérés comme du spam dés la connexion du serveur. On va en profiter pour installer spf et dkim, puis, dmarc,</p>
<p>Si postfix transmet des mails :</p>
<pre><code>apt install opendkim opendkim-tools #Pour la chaîne de signature
apt install mailutils # Pour pouvoir tester l&#39;envoi de mail avec la commande mail</code></pre>
<p>Si postfix gére la réception des mails alors installer aussi :</p>
<pre><code>apt install postfix-policyd-spf-python
vim /etc/postfix/master.cf
  #Ajouter en fin de fichier
  policyd-spf  unix  -       n       n       -       0       spawn
  user=policyd-spf argv=/usr/bin/policyd-spf</code></pre>
<p>L'édition du fichier master permet de lancer le démon d'analyse des mails reçus.</p>
<h3 id="configuration-1">Configuration</h3>
<p>Le fichier de configuration est <em>/etc/postfix/main.cf</em></p>
<p>Selon que le serveur est la destination ou seulement un relai on précisera <em>mydestination</em> ou non.</p>
<p>Exemple pour un serveur destinataire : :</p>
<pre><code>michaellaunay@monserveur:~$ cat /etc/postfix/main.cf
biff = no
append_dot_mydomain = no
readme_directory = no
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
home_mailbox = Maildir/
mail_spool_directory = /var/spool/mail/
myhostname = monserveur.masociete.com
mydomain = masociete.com
myorigin = $mydomain
header_checks = regexp:/etc/postfix/header_checks
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
relayhost =
mydestination = masociete.org, masociete.com, localhost.localdomain, localhost
unknown_local_recipient_reject_code = 550
mynetworks_style = host
mynetworks = 127.0.0.1, 82.236.252.174
mailbox_size_limit = 4294967296
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
message_size_limit = 10240000
header_size_limit = 102400
bounce_size_limit = 512000
disable_vrfy_command = no
smtpd_helo_required = yes
smtpd_banner = $myhostname ESMTP
maps_rbl_domains = relays.ordb.org, sbl.spamhaus.org, list.dsbl.org
smtpd_helo_restrictions = reject_invalid_hostname,  permit
smtpd_sender_restrictions = reject_unknown_sender_domain, reject_non_fqdn_sender, permit
smtpd_client_restrictions = permit_mynetworks, reject_rbl_client, permit
smtpd_recipient_restrictions = permit_mynetworks,
                                permit_sasl_authenticated,
                                reject_unauth_destination,
                                check_policy_service unix:private/policyd-spf
milter_protocol = 6
milter_default_action = accept
smtpd_milters = inet:localhost:8992
non_smtpd_milters = inet:localhost:8992</code></pre>
<p>Configuration de spf :</p>
<pre><code>Ajouter une entrée spf à vos entrées DNS sur votre Registrar.

Par exemple le registrar de **ecreall.com** est OVH et il faut ajouter une entrée SPF et la remplir comme suit :

  Sous-domaine []**.ecreall.com** #Préciser le sous domaine, ici il n&#39;y en a pas donc on laisse vide
  TTL [Par défaut] #Mais pour les tests [Personnalisé] on peut alors mettre une valeur faible en secondes comme [60]
  Autoriser l&#39;IP de **ecreall.com** à envoyer des emails ? [v]oui # on autorisera les adresses ip que l&#39;on souaite.
  Autoriser les serveurs MX à envoyer des emails [v]oui #si MX est notre serveur
  Autoriser tous les serveurs dont le nom se termine par **ecreall.com** [v]Non # permet de gérer les sous domaines
  D&#39;autres serveurs ? # Mettre les autres adresses ou noms autorisés à envoyer

Sous Gandi il ne faut surtout pas utiliser le champ spf qui est documenté comme obsolète, à la place il faut utiliser une entrée TXT

Il faut alors mettre &quot;v=spf1 a mx ip4:62.210.112.125 -all&quot; dans le champ.

La valeur des champs spf est expliquée par Google ici https://support.google.com/a/answer/33786</code></pre>
<p>Pour tester :</p>
<pre><code>nslookup -type=txt ecreall.com
#Ce qui donne
  ecreall.com text = &quot;v=spf1 a mx ip4:62.210.112.125 -all&quot;</code></pre>
<p>Configuration de opendkim :</p>
<pre><code>vim /etc/opendkim.conf 
#Ajoutez ou mettez les variables à :
  Domain                ecreall.com
  KeyFile               /etc/dkimkeys/dkim.private
  Selector              dkim
  UserID                opendkim
  Socket inet:8992@localhost</code></pre>
<p>Le champ "Domain" indique quels vont être les mails signés avec la clé contenue dans le fichier "Keyfile" Le champ "Selector" indique quelle clé dans le fichier utilisée pour ce domaine. UsserID indique l'utilisateur du démon, attention le fichier de la clé privée doit pouvoir être lu par cet utilisateur. Socket Indique la socket qui sera utilisée par postfix pour se connecter et signer les mails transmis.</p>
<p>Génération de la clé de signature des mails :</p>
<pre><code>cd /etc/dkimkeys/
opendkim-genkey -t -s dkim -d nova-ideo.com
chown root:opendkim dkim.private
chmod 660 dkim.private</code></pre>
<p>L'attribut "-s dkim" permet de préciser de signer différemment chaque mail selon son domaine dans le cas où le serveur gère plusieurs domaines.</p>
<p>On a alors :</p>
<pre><code>root@luciole:/etc/dkimkeys# ls -lh
total 12K
-rw-rw---- 1 root opendkim 1,7K févr. 11 16:09 dkim.private
-rw------- 1 root root      508 févr. 11 16:09 dkim.txt
-rw-r--r-- 1 root root      664 déc.  27  2019 README.PrivateKeys</code></pre>
<p>Vérifier la clé :</p>
<pre><code>root@luciole:/# opendkim-testkey -d ecreall.com -s dkim -vvv
opendkim-testkey: using default configfile /etc/opendkim.conf
opendkim-testkey: /etc/dkimkeys/dkim.private: WARNING: unsafe permissions
opendkim-testkey: key loaded from /etc/dkimkeys/dkim.private
opendkim-testkey: checking key &#39;dkim._domainkey.ecreall.com&#39;
opendkim-testkey: key not secure
opendkim-testkey: key OK</code></pre>
<p>La ligne "opendkim-testkey: key not secure" est due au fait DNSSEC n'a pas été activé sur le dns.</p>
<p>Afficher le contenu de dkim.txt</p>
<blockquote>
<dl>
<dt>cat /etc/dkimkeys/dkim.txt</dt>
<dd><dl>
<dt>dkim._domainkey IN TXT ( "v=DKIM1; h=sha256; k=rsa; t=y; "</dt>
<dd><p>"p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxvKAG6fOfx+BnzZX1DSOpWEh/VzRqSb6/zmXp2MwUmS238Rx3LtQB0qJeJW9uGmsIS2GlNc1bL+0RnAeVi5q2vh3oGOQ0+kCmrqtaQwhUa6SYxjd5+QLZXbpt2emtaWIn687ufXmWa4gVnGxVN8O3K2ALcVyToPLB5e48s5fUh5Ln15f+X2XKAJkoZVlqeIvyD9+zHD1D7wvoL" "EDR3fSMYQmMQfBc2hR8nLArbCQj3HdJD5LITNQ9HlnM8dX56/MonWyavIKKWp3CV9IQZz0syG6i3XoxqdwdFvKh1daF+wnbYxS7ug9OlvWUo+6p4up6zFoEgT6PXo/cnjbYHA+FQIDAQAB" ) ; ----- DKIM key dkim for ecreall.com</p>
</dd>
</dl>
</dd>
</dl>
</blockquote>
<p>Configurer votre registrar :</p>
<pre><code>Se connecter à la zone DNS de son domaine, par exemple pour Ecreall dans OVH, on ajoute une entrée DKIM en remplissant les champs comme suit ::

  Sous-domaine [dkim._domainkey]

  Version [v]

  Alorithme (hash) -256 [v]

  Clé Publique [MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1YRDtepyDeIgVolfFz4bRgacdE0hxGFhB+9XTXmZbYcPc0iyDaGJivpd7TYAZ2zRBG+wU6s8viK9mxA/JLDTklhdbnD2oQOjBA1g7bcqqo/F3gHbApaz/M2DrQ4y5HEaHTjm/bsCLzbO7v3buTuhxu6mpVp5m/q+uX7o2LB1GkTw/DbqE2j3tHx5N5sojX6dZxvk+V9nyInArY4ni3uWrH3Y8aLSK7+QHyZVJAVGiT6jdRDdEERQlo2CTZj6UQu3jGtic+GZCU8Hp/SJWQj/xrx/ygZEJ0z294fLEIOGgUw66vRl6iVE9NJCaavTqBxlfgX7QNOa/9bqnR9uDI2flwIDAQAB
  ]

  Type de service []

  Mode test [v] # Permet de demander aux serveur recevant nos mails de ne pas tenir compte de DKIM tant qu&#39;on a pas fini

  Sous domaine [v] La clé publique n&#39;est pas valide pour les sous-domaine

Quand tout est au point ne pas oublier d&#39;éditer l&#39;entrée pour enlever le mode de test.</code></pre>
<h3 id="dmarc">dmarc</h3>
<p>L'ajout de DMARC se fait par simple ajoute d'une entrée de type DMARC ou TXT pour le sous-domaine _dmarc avec les valeurs suivantes :</p>
<pre><code>v=DMARC1;p=quarantine;pct=100;rua=mailto:michaellaunay+dmarc@ecreall.com;sp=quarantine;aspf=s;</code></pre>
<p>Où V est la version du protocole,</p>
<p>p est la politique à appliqer pour les messages reçu soit disant de notre domaine mais qui échoue, None (rien faire) ou Quarantine marquer douteux, Reject rejeter.</p>
<p>pct le pourcentage à traiter.</p>
<p>rua l'uri de la ressource à prévenir en cas d'usurpation.</p>
<p>sp la politique des sous domainkeys.</p>
<p>aspf s'il faut suivre spf à la lettre.</p>
<h2 id="mysql">MySQL</h2>
<h3 id="présentation-2">Présentation</h3>
<p>MySQL est une base de données légère facile à mettre en œuvre est très utilisées par les sites web.</p>
<p>Sont utilisation est libre mais si les sources de l'application réalisée ne sont pas en GPL, il faut s'acquitter de l'achat d'une licence commerciale.</p>
<h3 id="installation-3">Installation</h3>
<p>La commande <strong>apt install mysql-server</strong> permet d'installer le serveur contenant la base de données alors que <strong>apt-get install mysql-client</strong> se contentera d'installer le client.</p>
<h3 id="configuration-2">Configuration</h3>
<p>A l'installation il est fortement recommandé de donner un mot de passe à l'utilisateur root.</p>
<p>Liens :</p>
<blockquote>
<ul>
<li><a href="http://www-fr.mysql.com/">http://www-fr.mysql.com/</a></li>
<li><a href="http://fr.wikipedia.org/wiki/Mysql">http://fr.wikipedia.org/wiki/Mysql</a></li>
</ul>
</blockquote>
<h2 id="sécurisation-1">Sécurisation</h2>
<h3 id="certificat-x-509">Certificat X 509</h3>
<p>Les certificats X 509 sont utilisés à la fois pour l'authentification et pour le chiffrage des infrastructures à clés publiques (PKI) comme par exemple dans le protocole ssl lors des connexion ssh (port 22) ou https (port 443).</p>
<p>Ils sont délivrés par une autorité de certification et son liées à une adresse électronique ou à une entrée DNS.</p>
<p>Si l'autorité de certification est connue du navigateur, la connexion se fera sans alerter l'utilisateur. Dans le cas contraire, il sera prévenu que le site n'est pas de confiance.</p>
<p>Toutefois, il est possible de disposer des avantages du chiffrement sans passer par une autorité <em>de confiance</em>, en utilisant un certificat <em>auto-signé</em> : :</p>
<pre><code>root@monserveur:~# make-ssl-cert /usr/share/ssl-cert/ssleay.cnf /etc/ssl/apache2/ssl/ssl.monsite.com.pem
root@monserveur:~# vim /etc/apache2/sites-available/ssl.monsite.com
#remove SSLCertificateFile and update SSLCertificateKeyFile with
SSLCertificateKeyFile /etc/apache2/ssl/ssl.monsite.com.pem
root@monserveur:~# service apache2 restart</code></pre>
<p>Mais les certificats autosignés ont l'inconvéniant de ne pas avoir d'autorité connue et donc d'être refusé.</p>
<p>Nous pouvons utiliser les service let's encrypt qui poermette d'avoir un</p>
<p>Configuration de Let's Encrypt pour générer nos certificats ssl :</p>
<pre><code>apt install apache2 #Si ce n&#39;est pas fait, vérifier que le port http est ouvert sur ufw !
apt install certbot
certbot certonly --webroot -w /var/www/html -d URL_De_Mon_Site</code></pre>
<p>Vérification de la génération :</p>
<pre><code>root@triticale:~# openssl x509 -noout -text -in /etc/letsencrypt/live/URL_De_Mon_Site/fullchain.pem | grep &quot;Not After&quot;
        Not After : Aug  5 11:25:06 2020 GMT</code></pre>
<p>Modifier le cron de renouvellement "/etc/cron.d/certbot" et mettre :</p>
<pre><code>0 \*/12 \* \* \* root test -x /usr/bin/certbot -a \! -d /run/systemd/system &amp;&amp; perl -e &#39;sleep int(rand(43200))&#39; &amp;&amp; certbot -q renew --apache</code></pre>
<p>Liens :</p>
<blockquote>
<ul>
<li><a href="http://doc.ubuntu-fr.org/tutoriel/securiser_apache2_avec_ssl">http://doc.ubuntu-fr.org/tutoriel/securiser_apache2_avec_ssl</a></li>
<li><a href="http://fr.wikipedia.org/wiki/X.509">http://fr.wikipedia.org/wiki/X.509</a></li>
</ul>
</blockquote>
<h3 id="postgrey">postgrey</h3>
<p><strong>postgrey</strong> est un paquet de configuration de <em>postfix</em> permettant de différer la réception des mails des serveurs inconnus.</p>
<p>Le but est d'éliminer les spams, car les serveurs de spams ne prennent pas la peine de renvoyer un courrier dont la réception est différée.</p>
<h3 id="fail2ban">fail2ban</h3>
<p>Fail2ban est un démon qui permet de modifier les règles du firewall pour bannir pendant un temps déterminé les adresses IP qui ont échoué plusieurs connexions de suite à l'un des services du serveur.</p>
<p>Le temps d'exclusion, le nombre de tentatives tolérées, les adresses non bannies sont configurables via les fichiers /etc/fail2ban/fail2ban.conf et /etc/fail2ban/jail.conf.</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="http://en.wikipedia.org/wiki/Comparison_of_operating_systems">http://en.wikipedia.org/wiki/Comparison_of_operating_systems</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</section>
